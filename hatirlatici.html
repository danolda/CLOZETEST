<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Hatırlatıcı & SRS Modu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .srs-card { max-width: 800px; margin: 0 auto; border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; }
        .header-area { background: linear-gradient(135deg, #6610f2, #d63384); color: white; padding: 30px; border-radius: 0 0 20px 20px; margin-bottom: 30px; text-align: center; }
        .option-row { display: flex; align-items: center; padding: 12px; margin-bottom: 10px; border: 1px solid #dee2e6; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .option-row:hover { background-color: #f8f9fa; transform: translateX(5px); }
        .btn-circle { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; border: 2px solid #6c757d; color: #6c757d; }
        
        .opt-correct { border-color: #198754 !important; background-color: rgba(25, 135, 84, 0.1) !important; }
        .opt-correct .btn-circle { background-color: #198754; color: white; border-color: #198754; }
        
        .opt-wrong { border-color: #dc3545 !important; background-color: rgba(220, 53, 69, 0.1) !important; }
        .opt-wrong .btn-circle { background-color: #dc3545; color: white; border-color: #dc3545; }
        
        .timer-info { font-size: 0.9rem; color: #6c757d; font-style: italic; }
        .empty-state { padding: 50px; text-align: center; color: #6c757d; }
    </style>
</head>
<body>

<div class="header-area">
    <h1><i class="bi bi-alarm-fill"></i> Akıllı Tekrar Sistemi</h1>
    <p>Yanlış yaptığın soruları belirli aralıklarla tekrar et.</p>
    <a href="index.html" class="btn btn-outline-light btn-sm mt-2"><i class="bi bi-arrow-left"></i> Ana Sayfaya Dön</a>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- İstatistik Kartı -->
            <div class="d-flex justify-content-between mb-3 px-2">
                <span class="badge bg-danger p-2" id="due-count-badge">Çözülecek: 0</span>
                <span class="badge bg-secondary p-2" id="wait-count-badge">Bekleyen (Süresi Gelmemiş): 0</span>
                
                <!-- AYAR: TEST MODU -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="testModeToggle" onchange="toggleTestMode()">
                    <label class="form-check-label small text-muted" for="testModeToggle">Test Modu (1 Dakika)</label>
                </div>
            </div>

            <!-- Soru Alanı -->
            <div id="srs-container"></div>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASYON ---
    // Varsayılan: 7 Gün (604800000 ms). Test Modu: 1 Dakika (60000 ms)
    let TIME_INTERVAL = 7 * 24 * 60 * 60 * 1000; 

    // Veritabanı
    let allQuestions = [];
    let wrongBank = JSON.parse(localStorage.getItem('yds_mistakes')) || [];
    let srsSchedule = JSON.parse(localStorage.getItem('yds_srs_schedule')) || {};
    let generatedQuestions = JSON.parse(localStorage.getItem('yds_generated')) || [];

    // ================= VERİ SETLERİ (Senin verdiğin veriler) =================
    // Kopyala-Yapıştır kolaylığı için buraya senin verilerini gömüyoruz.
    // NOT: index.html içindeki "ydsVocabDB" ve "rawQuestionsText" değişkenlerini buraya aynen alıyorum.
    
    // 1. KELİME HAVUZU (Kısaltılmış örnek, sen tam listeni buraya koyabilirsin)
    // Eğer index.html ile aynı klasördeyse, tarayıcı önbelleğinden veriyi çekemeyiz, 
    // mecburen veriyi buraya da koymamız gerek.
    const ydsVocabDB = [
        { en: "Abandon", tr: "Terk etmek, vazgeçmek" },
        { en: "Abolition", tr: "Yürürlükten kaldırma, iptal" },
        { en: "Abrupt", tr: "Ani, beklenmedik" },
        // ... (Buraya index.html'deki ydsVocabDB listesinin tamamını yapıştırabilirsin) ...
        // Kodun çalışması için kısa tuttum, ama mantık aynı.
        { en: "Abundant", tr: "Bol, bereketli" } 
    ];

    // 2. GRAMER SORULARI (Örnek)
    const rawQuestionsText = `
Section: Prepositions & Collocations (1–70)
1) She insisted ___ paying for the damage...
   A) at
   B) to
   C) for
   D) with
   E) on
TIP: Kalıp → insist on + V-ing / noun.
`; // Buraya index.html'deki rawQuestionsText'in tamamını yapıştır.

    const rawAnswersText = `1:E`; // Buraya index.html'deki rawAnswersText'in tamamını yapıştır.

    // =======================================================================

    // Sayfa Yüklendiğinde
    window.onload = function() {
        // Test modu ayarını kontrol et
        if(localStorage.getItem('yds_test_mode') === 'true') {
            document.getElementById('testModeToggle').checked = true;
            TIME_INTERVAL = 60 * 1000; // 1 dakika
        }

        loadData(); // Soruları yükle
        syncMistakes(); // Ana uygulamadan yeni yanlışları çek
        renderSRS(); // Ekrana bas
    };

    function toggleTestMode() {
        const isChecked = document.getElementById('testModeToggle').checked;
        localStorage.setItem('yds_test_mode', isChecked);
        TIME_INTERVAL = isChecked ? (60 * 1000) : (7 * 24 * 60 * 60 * 1000);
        alert(isChecked ? "Test Modu Aktif: Yanlış sorular 1 dakika sonra tekrar sorulacak." : "Normal Mod: Yanlış sorular 1 hafta sonra tekrar sorulacak.");
        renderSRS();
    }

    // Soruları Hazırlama (Index.html'deki mantığın aynısı)
    function loadData() {
        allQuestions = [];
        
        // Kelime Soruları Üret
        const vocabQ = generateVocabQuestions();
        allQuestions = allQuestions.concat(vocabQ);

        // Gramer Sorularını Parse Et (Senin kodundaki fonksiyonun basitleştirilmiş hali)
        // Eğer rawQuestionsText doluysa burayı işler
        if (typeof rawQuestionsText !== 'undefined' && rawQuestionsText.length > 10) {
            // Basit Parser (Senin tam verine göre uyarla)
            // Not: Bu örnekte parser'ı tam yazmadım, index.html'deki parseRawData fonksiyonunu buraya kopyalayabilirsin.
            // Şimdilik demo sorularla çalışıyor.
        }
        
        // AI Sorularını da ekle
        allQuestions = allQuestions.concat(generatedQuestions);
    }

    function generateVocabQuestions() {
        // Index.html'deki fonksiyonun aynısı
        let qList = [];
        ydsVocabDB.forEach((item, index) => {
            let optionsObj = { A: item.tr, B: "Hata", C: "Yok", D: "Boş", E: "Test" }; // Demo şıklar
            qList.push({
                id: 1000 + index, 
                text: `<strong>"${item.en}"</strong> kelimesinin Türkçe karşılığı nedir?`,
                options: optionsObj,
                correctAnswer: "A",
                tip: "Kelime tekrarı",
                isVocab: true 
            });
        });
        return qList;
    }

    // --- SENKRONİZASYON (ANA UYGULAMA İLE BAĞLANTI) ---
    function syncMistakes() {
        let changed = false;
        const now = Date.now();

        // 1. Ana uygulamadaki 'wrongBank' (Sadece ID listesi) içinde olup
        //    Bizim 'srsSchedule' (Tarihli liste) içinde olmayanları ekle.
        wrongBank.forEach(id => {
            if (!srsSchedule[id]) {
                // Yeni bir yanlış gelmiş! Hemen çözülmesi için tarihi "şimdi" yap.
                srsSchedule[id] = now - 1000; 
                changed = true;
            }
        });

        // 2. Bizde olup 'wrongBank'ta olmayanları temizle (Ana uygulamada düzeltildiyse buradan da sil)
        Object.keys(srsSchedule).forEach(id => {
            if (!wrongBank.includes(parseInt(id)) && !wrongBank.includes(id.toString())) {
                delete srsSchedule[id];
                changed = true;
            }
        });

        if (changed) {
            localStorage.setItem('yds_srs_schedule', JSON.stringify(srsSchedule));
        }
    }

    // --- RENDER ---
    function renderSRS() {
        const container = document.getElementById('srs-container');
        container.innerHTML = "";
        
        const now = Date.now();
        let dueQuestions = [];
        let waitCount = 0;

        // Zamanı gelenleri filtrele
        Object.keys(srsSchedule).forEach(id => {
            const dueDate = srsSchedule[id];
            if (dueDate <= now) {
                // Bu ID'ye ait soruyu 'allQuestions' içinden bul
                const q = allQuestions.find(x => x.id == id);
                if (q) dueQuestions.push(q);
            } else {
                waitCount++;
            }
        });

        // İstatistikleri güncelle
        document.getElementById('due-count-badge').innerText = `Çözülecek: ${dueQuestions.length}`;
        document.getElementById('wait-count-badge').innerText = `Bekleyen: ${waitCount}`;

        if (dueQuestions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <h3 class="mt-3">Tebrikler!</h3>
                    <p>Şu an tekrar etmen gereken soru bulunmuyor.</p>
                    <p class="small">Yanlış yaptığın soruların zamanı gelince burada belirecek.</p>
                </div>`;
            return;
        }

        // Soruları Bas
        dueQuestions.forEach((q, idx) => {
            let optsHTML = "";
            ['A', 'B', 'C', 'D', 'E'].forEach(opt => {
                optsHTML += `
                <div class="option-row" onclick="checkAnswer(${q.id}, '${opt}', '${q.correctAnswer}')">
                    <div class="btn-circle">${opt}</div>
                    <div>${q.options[opt] || '---'}</div>
                </div>`;
            });

            const card = `
            <div class="card srs-card mb-4" id="card-${q.id}">
                <div class="card-body p-4">
                    <h5 class="card-title text-primary fw-bold mb-3">Soru #${q.id}</h5>
                    <p class="lead mb-4">${q.text}</p>
                    <div id="opts-${q.id}">${optsHTML}</div>
                    <div id="feedback-${q.id}" class="mt-3 fw-bold"></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', card);
        });
    }

    // --- CEVAP KONTROLÜ (SRS MANTIĞI BURADA) ---
    function checkAnswer(qId, selectedOpt, correctOpt) {
        const card = document.getElementById(`card-${qId}`);
        const feedback = document.getElementById(`feedback-${qId}`);
        const rows = card.querySelectorAll('.option-row');
        
        // Tıklamayı engelle
        rows.forEach(r => r.style.pointerEvents = 'none');

        // Görsel Geri Bildirim
        rows.forEach(row => {
            const btnText = row.querySelector('.btn-circle').innerText;
            if (btnText === correctOpt) row.classList.add('opt-correct');
            if (btnText === selectedOpt && selectedOpt !== correctOpt) row.classList.add('opt-wrong');
        });

        if (selectedOpt === correctOpt) {
            // DOĞRU CEVAP: Sistemden sil (Öğrenildi!)
            feedback.innerHTML = `<span class="text-success"><i class="bi bi-check-lg"></i> Harika! Bu soru öğrenildi ve listeden silindi.</span>`;
            
            // 1. SRS Listesinden Sil
            delete srsSchedule[qId];
            localStorage.setItem('yds_srs_schedule', JSON.stringify(srsSchedule));

            // 2. Ana Uygulama (wrongBank) Listesinden Sil
            wrongBank = wrongBank.filter(id => id != qId); // Hem string hem int kontrolü için != kullanıldı
            localStorage.setItem('yds_mistakes', JSON.stringify(wrongBank));

            // Kartı yavaşça kaldır
            setTimeout(() => { card.style.display = 'none'; }, 1500);

        } else {
            // YANLIŞ CEVAP: Tarihi ertele (Tekrar sorulacak)
            const nextDate = Date.now() + TIME_INTERVAL;
            const dateStr = new Date(nextDate).toLocaleString();
            
            feedback.innerHTML = `<span class="text-danger"><i class="bi bi-clock-history"></i> Yanlış. Bu soru <strong>${dateStr}</strong> tarihinde tekrar sorulacak.</span>`;
            
            // Tarihi güncelle
            srsSchedule[qId] = nextDate;
            localStorage.setItem('yds_srs_schedule', JSON.stringify(srsSchedule));
        }
        
        // Sayaçları güncelle
        setTimeout(() => {
             // Basitçe badge sayılarını güncellemek yerine, tam render yapmamak için manuel düşürebiliriz
             // Ama en temiz yöntem tekrar syncMistakes ve renderSRS çağırmak değil (sayfa zıplar).
             // Şimdilik sadece badge'i JS ile 1 azaltabiliriz.
        }, 1000);
    }

</script>
</body>
</html>
