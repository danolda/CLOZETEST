<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YDS Wars - Travian Tarzƒ± Strateji Oyunu</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--wood:#4a7c29;--clay:#c45a1a;--iron:#5a5a5a;--crop:#d4a017;--bg-dark:#1a1208;--bg-medium:#2d2011;--bg-light:#3d2e1a;--gold:#ffd700;--silver:#c0c0c0;--text:#f0e6d2;--text-dim:#a89878;--border:#6b5530;--accent:#c8a050;--danger:#c0392b;--success:#27ae60;--panel-bg:linear-gradient(180deg,#3a2a18 0%,#2a1c10 100%);--btn-green:linear-gradient(180deg,#5a9e2f 0%,#3d7a1a 100%);--btn-gold:linear-gradient(180deg,#e8b830 0%,#c49020 100%);--btn-red:linear-gradient(180deg,#c0392b 0%,#962d22 100%)}
*{margin:0;padding:0;box-sizing:border-box}body{background:#0d0a05;color:var(--text);font-family:'Nunito',sans-serif;overflow-x:hidden;min-height:100vh}
::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#1a1208}::-webkit-scrollbar-thumb{background:#6b5530;border-radius:4px}
.hidden{display:none!important}button{cursor:pointer;font-family:inherit}h1,h2,h3,h4{font-family:'Cinzel',serif;color:var(--accent)}

/* LOGIN */
#loginScreen{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0a0705 0%,#1a1208 50%,#0d0a05 100%)}
#loginScreen::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c8a050' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat}
.login-box{position:relative;z-index:1;background:var(--panel-bg);border:2px solid var(--border);border-radius:12px;padding:40px;width:420px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
.login-box h1{text-align:center;font-size:2.2rem;margin-bottom:6px;color:var(--gold);text-shadow:0 2px 10px rgba(255,215,0,0.3)}
.login-box .subtitle{text-align:center;color:var(--text-dim);margin-bottom:24px;font-size:0.9rem}
.login-box .emblem{text-align:center;font-size:3.5rem;margin-bottom:10px}
.form-group{margin-bottom:16px}.form-group label{display:block;font-weight:700;margin-bottom:4px;color:var(--accent);font-size:0.85rem;text-transform:uppercase;letter-spacing:1px}
.form-group input{width:100%;padding:10px 14px;background:#1a1208;border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:1rem;outline:none;transition:border-color .2s}
.form-group input:focus{border-color:var(--gold)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border:1px solid rgba(0,0,0,0.3);border-radius:6px;font-weight:700;font-size:0.95rem;transition:all .15s;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
.btn-green{background:var(--btn-green);color:#fff;border-bottom:2px solid #2d6010}.btn-green:hover{filter:brightness(1.15);transform:translateY(-1px)}
.btn-gold{background:var(--btn-gold);color:#1a1208;border-bottom:2px solid #9a7010}.btn-gold:hover{filter:brightness(1.15)}
.btn-red{background:var(--btn-red);color:#fff;border-bottom:2px solid #7a2018}
.btn-sm{padding:6px 12px;font-size:0.8rem}.btn-block{width:100%;justify-content:center}
.login-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border)}
.login-tabs button{flex:1;padding:10px;background:transparent;border:none;color:var(--text-dim);font-weight:700;font-size:0.95rem;transition:.2s}
.login-tabs button.active{color:var(--gold);border-bottom:2px solid var(--gold);margin-bottom:-2px}
.login-error{background:rgba(192,57,43,0.2);border:1px solid var(--danger);padding:8px 12px;border-radius:6px;color:#e74c3c;font-size:0.85rem;margin-bottom:12px;display:none}

/* TRIBE */
#tribeScreen{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(135deg,#0a0705,#1a1208,#0d0a05)}
.tribe-title{font-family:'Cinzel',serif;font-size:2.5rem;color:var(--gold);text-shadow:0 2px 20px rgba(255,215,0,0.3);margin-bottom:8px}
.tribe-subtitle{color:var(--text-dim);margin-bottom:30px;font-size:1rem}
.tribe-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:900px}
.tribe-card{width:260px;background:var(--panel-bg);border:2px solid var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden}
.tribe-card:hover{border-color:var(--gold);transform:translateY(-6px);box-shadow:0 12px 40px rgba(255,215,0,0.15)}
.tribe-card .tribe-icon{font-size:4rem;margin-bottom:10px;display:block}
.tribe-card h3{font-size:1.4rem;margin-bottom:8px}
.tribe-card p{font-size:0.85rem;color:var(--text-dim);line-height:1.5}
.tribe-card .tribe-bonus{margin-top:12px;padding:8px;background:rgba(200,160,80,0.1);border:1px solid rgba(200,160,80,0.2);border-radius:6px;font-size:0.8rem;color:var(--accent)}
.tribe-card.roman:hover{border-color:#e74c3c}.tribe-card.roman h3{color:#e74c3c}
.tribe-card.teuton:hover{border-color:#27ae60}.tribe-card.teuton h3{color:#27ae60}
.tribe-card.turk:hover{border-color:#3498db}.tribe-card.turk h3{color:#3498db}

/* GAME LAYOUT */
#gameScreen{display:none;min-height:100vh}
.top-bar{background:linear-gradient(180deg,#2d2011 0%,#1a1208 100%);border-bottom:2px solid var(--border);padding:0;position:sticky;top:0;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,0.5)}
.top-bar-inner{display:flex;align-items:center;max-width:1300px;margin:0 auto;padding:0 10px}
.nav-icons{display:flex;gap:0}
.nav-icon{width:52px;height:48px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:var(--text-dim);cursor:pointer;transition:.15s;border-bottom:3px solid transparent;position:relative}
.nav-icon:hover,.nav-icon.active{color:var(--gold);background:rgba(200,160,80,0.1);border-bottom-color:var(--gold)}
.nav-icon .badge{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;font-size:0.6rem;padding:1px 4px;border-radius:8px;font-weight:700}
.res-bar{display:flex;align-items:center;gap:2px;flex:1;justify-content:center;flex-wrap:wrap}
.res-item{display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:700;min-width:90px}
.res-dot{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,0.3);flex-shrink:0}
.res-dot.wood{background:var(--wood)}.res-dot.clay{background:var(--clay)}.res-dot.iron{background:var(--iron)}.res-dot.crop{background:var(--crop)}
.gold-display{display:flex;align-items:center;gap:6px;padding:4px 12px;color:var(--gold);font-weight:800;font-size:1rem}
.server-time{font-size:0.75rem;color:var(--text-dim);padding:4px 10px;white-space:nowrap}
.speed-badge{background:var(--danger);color:#fff;padding:1px 6px;border-radius:10px;font-size:0.65rem;font-weight:800}

.game-body{display:flex;max-width:1300px;margin:0 auto;min-height:calc(100vh - 50px)}
.sidebar-left{width:220px;flex-shrink:0;padding:10px;display:flex;flex-direction:column;gap:10px}
.sidebar-right{width:240px;flex-shrink:0;padding:10px;display:flex;flex-direction:column;gap:10px}
.main-content{flex:1;padding:10px;min-width:0}
.panel{background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.panel-header{background:linear-gradient(180deg,#4a3620 0%,#3a2810 100%);padding:8px 12px;font-family:'Cinzel',serif;font-size:0.85rem;color:var(--accent);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.panel-body{padding:10px}

/* ‚ïê‚ïê‚ïê DORF1 KAYNAK ALANLARI ‚ïê‚ïê‚ïê */
.village-view{position:relative;width:100%;aspect-ratio:4/3;border-radius:12px;overflow:hidden;border:3px solid #2a5510;box-shadow:inset 0 0 60px rgba(0,0,0,0.3),0 8px 30px rgba(0,0,0,0.5)}
.village-bg{position:absolute;inset:0;z-index:0}
.dorf1-bg{background:radial-gradient(ellipse at 50% 50%,#6aaa35 0%,#4a8a20 35%,#3a7015 60%,#2e5e12 85%,#1e4a08 100%)}
.dorf2-bg{background:radial-gradient(ellipse at 50% 50%,#80b840 0%,#60a030 35%,#4a8525 60%,#3a7018 85%,#2a5a10 100%)}
/* Rivers */
.river{position:absolute;height:4px;background:linear-gradient(90deg,transparent 0%,#5ab0e8 20%,#6ac0f0 50%,#5ab0e8 80%,transparent 100%);opacity:0.5;z-index:1;border-radius:2px}
/* Resource zone backgrounds */
.res-zone{position:absolute;border-radius:50%;z-index:1;opacity:0.35}
.res-zone.wood-zone{background:radial-gradient(circle,#2e7d32 0%,#1b5e20 50%,transparent 70%)}
.res-zone.clay-zone{background:radial-gradient(circle,#bf360c 0%,#8d2004 50%,transparent 70%)}
.res-zone.iron-zone{background:radial-gradient(circle,#616161 0%,#424242 50%,transparent 70%)}
.res-zone.crop-zone{background:radial-gradient(circle,#f9a825 0%,#f57f17 50%,transparent 70%)}
/* Slots */
.village-slot{position:absolute;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:0.85rem;cursor:pointer;transition:all .15s;z-index:10;box-shadow:2px 3px 8px rgba(0,0,0,0.4);border:2px solid;flex-direction:column;line-height:1}
.village-slot:hover{transform:scale(1.2);z-index:20;box-shadow:0 0 15px rgba(255,215,0,0.5)}
.village-slot.empty{background:rgba(255,255,255,0.25);border-color:rgba(255,255,255,0.4);color:transparent}
.village-slot.empty:hover{background:rgba(255,215,0,0.3);border-color:var(--gold)}
.village-slot .slot-icon{font-size:1rem;line-height:1}
.village-slot .slot-lvl{font-size:0.7rem;font-weight:900;line-height:1}
.village-slot.s-wood{background:linear-gradient(135deg,#c8e6c9,#a5d6a7);border-color:#2e7d32;color:#1b5e20}
.village-slot.s-clay{background:linear-gradient(135deg,#ffccbc,#ffab91);border-color:#d84315;color:#bf360c}
.village-slot.s-iron{background:linear-gradient(135deg,#e0e0e0,#bdbdbd);border-color:#424242;color:#212121}
.village-slot.s-crop{background:linear-gradient(135deg,#fff9c4,#fff176);border-color:#f9a825;color:#f57f17}
.village-slot.s-building{background:linear-gradient(135deg,#bbdefb,#90caf9);border-color:#1565c0;color:#0d47a1}
.village-slot.s-main{background:linear-gradient(135deg,#e1bee7,#ce93d8);border-color:#6a1b9a;color:#4a148c;width:56px;height:56px;font-size:1rem}
.village-slot.s-rally{background:linear-gradient(135deg,#ffcdd2,#ef9a9a);border-color:#c62828;color:#b71c1c;border-radius:8px}
.village-slot.s-wall{background:linear-gradient(135deg,#d7ccc8,#bcaaa4);border-color:#5d4037;color:#3e2723;border-radius:4px;width:120px;height:30px;font-size:0.7rem}
.village-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.2rem;z-index:5;pointer-events:none;filter:drop-shadow(2px 4px 6px rgba(0,0,0,0.4))}

/* ‚ïê‚ïê‚ïê WORLD MAP ‚ïê‚ïê‚ïê */
.map-outer{position:relative;width:100%;height:calc(100vh - 110px);overflow:hidden;border:2px solid var(--border);border-radius:8px;background:#4a7a18}
.map-scroll{position:absolute;inset:0;overflow:auto;cursor:grab}
.map-scroll:active{cursor:grabbing}
.map-scroll::-webkit-scrollbar{width:10px;height:10px}
.map-scroll::-webkit-scrollbar-thumb{background:#5a8a25;border-radius:5px}
.map-grid-table{border-collapse:collapse;image-rendering:pixelated}
.map-grid-table td{width:60px;height:60px;border:1px solid rgba(0,0,0,0.12);text-align:center;vertical-align:middle;position:relative;font-size:0.6rem;padding:0;transition:background .05s}
.map-grid-table td:hover{outline:2px solid var(--gold);z-index:5;outline-offset:-2px}
.map-grid-table td.terrain-grass{background:#5a9a25}.map-grid-table td.terrain-grass2{background:#4e8e20}
.map-grid-table td.terrain-forest{background:#3a7015}.map-grid-table td.terrain-mountain{background:#8a7a60}
.map-grid-table td.terrain-desert{background:#c4a050}.map-grid-table td.terrain-water{background:#4a90d9}
/* Map village markers */
.mv{width:42px;height:42px;margin:auto;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;border:2px solid;cursor:pointer;position:relative;flex-direction:column;line-height:1.1;font-weight:700;transition:.1s;overflow:hidden}
.mv:hover{transform:scale(1.1);z-index:10}
.mv.player{background:#ffd700;border-color:#b8860b;animation:pulse 2s infinite;font-size:1rem}
@keyframes pulse{0%,100%{box-shadow:0 0 5px rgba(255,215,0,0.3)}50%{box-shadow:0 0 15px rgba(255,215,0,0.6)}}
.mv.pop-tiny{background:#d4c5a0;border-color:#a09070}.mv.pop-small{background:#c8b888;border-color:#908060;font-size:0.8rem}
.mv.pop-med{background:#b8a878;border-color:#807050;font-size:0.85rem}.mv.pop-large{background:#a89868;border-color:#706040;font-size:0.9rem}
.mv .mv-name{font-size:0.5rem;font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:38px;color:#333;line-height:1}
.mv .mv-icon{font-size:1.1rem;line-height:1}
.mv.tribe-roman{border-color:#c0392b;background:linear-gradient(135deg,#f5c6cb,#e8a0a8)}.mv.tribe-roman .mv-icon{color:#c0392b}
.mv.tribe-teuton{border-color:#27ae60;background:linear-gradient(135deg,#c3e6cb,#a0d8a8)}.mv.tribe-teuton .mv-icon{color:#27ae60}
.mv.tribe-turk{border-color:#2980b9;background:linear-gradient(135deg,#b8d4e8,#90c0d8)}.mv.tribe-turk .mv-icon{color:#2980b9}
.mv.natar{background:#888;border-color:#555}
.map-coords{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:6px 16px;border-radius:20px;font-size:0.8rem;z-index:50;display:flex;gap:12px}
.map-rulers-x{position:sticky;top:0;z-index:20;background:#2d2011;display:flex;height:20px;font-size:0.65rem;color:var(--text-dim)}
.map-rulers-x span{width:60px;text-align:center;flex-shrink:0;border-right:1px solid rgba(255,255,255,0.1);line-height:20px}
.map-rulers-y{position:absolute;left:0;top:20px;z-index:20;background:#2d2011;width:25px;font-size:0.65rem;color:var(--text-dim)}
.map-rulers-y span{display:block;height:60px;text-align:center;line-height:60px;border-bottom:1px solid rgba(255,255,255,0.1)}
.map-tooltip{position:fixed;background:var(--bg-dark);border:2px solid var(--border);padding:10px 14px;border-radius:8px;font-size:0.82rem;pointer-events:none;z-index:200;box-shadow:0 6px 20px rgba(0,0,0,0.7);max-width:220px;display:none}
.map-tooltip .tt-name{font-weight:800;color:var(--gold);font-size:0.95rem}.map-tooltip .tt-coord{color:var(--text-dim);font-size:0.75rem}
.map-tooltip .tt-info{margin-top:4px;font-size:0.78rem;line-height:1.4}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal-box{background:var(--bg-dark);border:2px solid var(--border);border-radius:12px;width:620px;max-width:95vw;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.8);animation:modalIn .2s ease-out}
@keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.modal-header{background:linear-gradient(180deg,#4a3620,#3a2810);padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.modal-header h3{margin:0;font-size:1.1rem}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:1.4rem;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.15s}
.modal-close:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.modal-body{padding:16px;overflow-y:auto;max-height:calc(85vh - 60px)}

/* BUILD ITEMS */
.build-item{display:flex;align-items:center;gap:12px;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);transition:.15s}
.build-item:hover{background:rgba(200,160,80,0.05);border-color:var(--accent)}
.build-item .b-icon{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;background:rgba(200,160,80,0.1)}
.build-item .b-info{flex:1;min-width:0}.build-item .b-name{font-weight:700;color:var(--accent);font-size:0.95rem}
.build-item .b-desc{font-size:0.78rem;color:var(--text-dim);margin-top:2px}
.build-item .b-costs{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.build-item .b-cost{display:flex;align-items:center;gap:3px;font-size:0.78rem;font-weight:600}
.build-item .b-cost.insufficient{color:#e74c3c}
.build-item.disabled{opacity:0.5}.build-item .req-text{font-size:0.75rem;color:#e74c3c;margin-top:4px}

/* QUEUE */
.queue-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.85rem}
.queue-item.active{background:rgba(200,160,80,0.1);border-left:3px solid var(--gold)}
.queue-item .q-time{color:var(--gold);font-weight:700;font-variant-numeric:tabular-nums}
.queue-empty{text-align:center;padding:20px;color:var(--text-dim);font-size:0.85rem}
.prod-row{display:flex;justify-content:space-between;padding:4px 0;font-size:0.85rem;font-weight:600}
.prod-row .prod-label{display:flex;align-items:center;gap:4px}

/* STATS - TOP 10 */
.top10-wrapper{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.top10-box{background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.top10-title{background:linear-gradient(180deg,#4a3620,#3a2810);padding:8px 12px;text-align:center;font-family:'Cinzel',serif;font-size:0.85rem;color:var(--accent);border-bottom:1px solid var(--border)}
.top10-table{width:100%;border-collapse:collapse;font-size:0.82rem}
.top10-table th{background:rgba(200,160,80,0.08);padding:6px 8px;text-align:left;color:var(--accent);font-size:0.75rem;border-bottom:1px solid var(--border)}
.top10-table td{padding:5px 8px;border-bottom:1px solid rgba(255,255,255,0.04)}
.top10-table tr:hover{background:rgba(255,255,255,0.02)}.top10-table tr.me{background:rgba(255,215,0,0.1);font-weight:700}
.top10-table .rank{width:30px;text-align:center;color:var(--text-dim)}.top10-table .val{text-align:right;font-weight:700;color:var(--gold)}

.stats-table{width:100%;border-collapse:collapse;font-size:0.85rem}
.stats-table th{background:rgba(200,160,80,0.1);padding:8px;text-align:left;border-bottom:1px solid var(--border);color:var(--accent);font-size:0.8rem}
.stats-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.05)}
.stats-table tr:hover{background:rgba(255,255,255,0.02)}

.troop-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.report-item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:.1s;font-size:0.85rem}
.report-item:hover{background:rgba(200,160,80,0.05)}
.tab-bar{display:flex;border-bottom:2px solid var(--border);margin-bottom:10px}
.tab-btn{padding:8px 16px;background:transparent;border:none;color:var(--text-dim);font-weight:700;font-size:0.9rem;border-bottom:3px solid transparent;margin-bottom:-2px;transition:.15s}
.tab-btn:hover{color:var(--text)}.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold)}

.divider{border:none;border-top:1px solid var(--border);margin:10px 0}
.text-gold{color:var(--gold)}.text-green{color:var(--success)}.text-red{color:var(--danger)}
.text-center{text-align:center}.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-3{margin-top:16px}.mb-1{margin-bottom:4px}.mb-2{margin-bottom:8px}
.flex{display:flex}.gap-1{gap:4px}.gap-2{gap:8px}.gap-3{gap:16px}.flex-1{flex:1}.items-center{align-items:center}.justify-between{justify-content:space-between}
.fw-700{font-weight:700}.fs-sm{font-size:0.8rem}
select,input[type="number"]{background:var(--bg-dark);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:0.85rem}
input[type="number"]{width:80px}
.clear-btn{background:none;border:none;color:var(--text-dim);font-size:0.7rem;cursor:pointer;margin-left:auto;padding:2px 6px;border-radius:4px}.clear-btn:hover{color:var(--text);background:rgba(255,255,255,0.1)}
@media(max-width:900px){.sidebar-left,.sidebar-right{display:none}.game-body{flex-direction:column}.res-item{min-width:70px;font-size:0.75rem;padding:2px 4px}.top10-wrapper{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="emblem">‚öîÔ∏è</div>
    <h1>YDS Wars</h1>
    <p class="subtitle">Travian Tarzƒ± Strateji Oyunu ‚Ä¢ 10x Hƒ±z</p>
    <div class="login-tabs">
      <button class="active" onclick="showLoginTab('login')">Giri≈ü Yap</button>
      <button onclick="showLoginTab('register')">Kayƒ±t Ol</button>
    </div>
    <div id="loginError" class="login-error"></div>
    <div id="loginForm">
      <div class="form-group"><label>Kullanƒ±cƒ± Adƒ±</label><input type="text" id="loginUser" placeholder="Adƒ±nƒ± yaz..."></div>
      <div class="form-group"><label>≈ûifre</label><input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="btn btn-green btn-block" onclick="doLogin()">‚öîÔ∏è Sava≈üa Gir</button>
    </div>
    <div id="registerForm" class="hidden">
      <div class="form-group"><label>Kullanƒ±cƒ± Adƒ±</label><input type="text" id="regUser" placeholder="Benzersiz isim se√ß..."></div>
      <div class="form-group"><label>≈ûifre</label><input type="password" id="regPass" placeholder="En az 4 karakter"></div>
      <div class="form-group"><label>≈ûifre (Tekrar)</label><input type="password" id="regPass2" placeholder="≈ûifreyi tekrarla"></div>
      <button class="btn btn-gold btn-block" onclick="doRegister()">üìú Hesap Olu≈ütur</button>
    </div>
  </div>
</div>

<!-- TRIBE -->
<div id="tribeScreen" class="hidden">
  <h1 class="tribe-title">‚öîÔ∏è Kabileni Se√ß</h1>
  <p class="tribe-subtitle">Bu karar geri alƒ±namaz! Kabilene uygun strateji belirle.</p>
  <div class="tribe-cards">
    <div class="tribe-card roman" onclick="selectTribe('Roman')">
      <span class="tribe-icon">üèõÔ∏è</span><h3>Romalƒ±lar</h3>
      <p>Dengeli g√º√ß. ƒ∞yi saldƒ±rƒ±, iyi savunma. Pahalƒ± ama g√º√ßl√º birimler.</p>
      <div class="tribe-bonus">‚ú¶ Kaynak + Bina aynƒ± anda<br>‚ú¶ G√º√ßl√º surlar<br>‚ú¶ Kahraman +100 g√º√ß</div>
    </div>
    <div class="tribe-card teuton" onclick="selectTribe('Teuton')">
      <span class="tribe-icon">ü™ì</span><h3>Cermenler</h3>
      <p>Agresif oyun. Ucuz ve hƒ±zlƒ± askerler. Yaƒüma uzmanƒ±.</p>
      <div class="tribe-bonus">‚ú¶ Ucuz piyadeler<br>‚ú¶ Bira Fabrikasƒ±<br>‚ú¶ %20 yaƒüma bonusu</div>
    </div>
    <div class="tribe-card turk" onclick="selectTribe('Turk')">
      <span class="tribe-icon">üèá</span><h3>T√ºrkler</h3>
      <p>Hƒ±zlƒ± atlƒ±lar, m√ºkemmel yaƒüma. G√∂√ßebe taktikleri.</p>
      <div class="tribe-bonus">‚ú¶ En hƒ±zlƒ± s√ºvariler<br>‚ú¶ B√ºy√ºk sƒ±ƒüƒ±naklar<br>‚ú¶ Kahraman +5 hƒ±z</div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen">
  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="nav-icons">
        <div class="nav-icon active" onclick="showView('dorf1')" title="Kaynaklar" id="nav-dorf1">üèòÔ∏è</div>
        <div class="nav-icon" onclick="showView('dorf2')" title="≈ûehir Merkezi" id="nav-dorf2">üè∞</div>
        <div class="nav-icon" onclick="showView('map')" title="Harita" id="nav-map">üó∫Ô∏è</div>
        <div class="nav-icon" onclick="showView('stats')" title="ƒ∞statistikler" id="nav-stats">üìä</div>
        <div class="nav-icon" onclick="showView('reports')" title="Raporlar" id="nav-reports">üìú</div>
        <div class="nav-icon" onclick="showView('alliance')" title="ƒ∞ttifak" id="nav-alliance">üõ°Ô∏è</div>
      </div>
      <div class="res-bar">
        <div class="res-item" title="Odun"><span class="res-dot wood"></span><span id="r-wood">0</span><span style="color:var(--text-dim);font-size:0.7rem;font-weight:400">/<span id="r-wood-cap">800</span></span></div>
        <div class="res-item" title="Tuƒüla"><span class="res-dot clay"></span><span id="r-clay">0</span><span style="color:var(--text-dim);font-size:0.7rem;font-weight:400">/<span id="r-clay-cap">800</span></span></div>
        <div class="res-item" title="Demir"><span class="res-dot iron"></span><span id="r-iron">0</span><span style="color:var(--text-dim);font-size:0.7rem;font-weight:400">/<span id="r-iron-cap">800</span></span></div>
        <div class="res-item" title="Tahƒ±l"><span class="res-dot crop"></span><span id="r-crop">0</span><span style="color:var(--text-dim);font-size:0.7rem;font-weight:400">/<span id="r-crop-cap">800</span></span></div>
        <div class="gold-display" title="YDS Altƒ±nƒ±">ü™ô <span id="r-gold">0</span></div>
      </div>
      <div class="server-time"><span class="speed-badge">10x</span> <span id="serverTime">00:00:00</span></div>
      <div class="nav-icon" onclick="doLogout()" title="√áƒ±kƒ±≈ü">üö™</div>
    </div>
  </div>
  <div class="game-body">
    <div class="sidebar-left">
      <div class="panel"><div class="panel-header">üë§ K√∂y Profili</div>
        <div class="panel-body text-center">
          <div style="font-size:2rem" id="tribeEmoji">üèõÔ∏è</div>
          <div class="fw-700 text-gold" id="tribeName">Romalƒ±lar</div>
          <div class="fs-sm" style="color:var(--text-dim)">N√ºfus: <b id="population">2</b></div>
          <div class="fs-sm" style="color:var(--text-dim)">K√∂y: <b id="villageName">-</b></div>
        </div>
      </div>
      <div class="panel"><div class="panel-header">üìà Saatlik √úretim</div>
        <div class="panel-body">
          <div class="prod-row"><span class="prod-label"><span class="res-dot wood"></span> Odun:</span><span id="p-wood">0</span></div>
          <div class="prod-row"><span class="prod-label"><span class="res-dot clay"></span> Tuƒüla:</span><span id="p-clay">0</span></div>
          <div class="prod-row"><span class="prod-label"><span class="res-dot iron"></span> Demir:</span><span id="p-iron">0</span></div>
          <div class="prod-row"><span class="prod-label"><span class="res-dot crop"></span> Tahƒ±l:</span><span id="p-crop">0</span></div>
        </div>
      </div>
      <div class="panel"><div class="panel-header">ü™ô Altƒ±n D√ºkkanƒ±</div>
        <div class="panel-body">
          <button class="btn btn-gold btn-block btn-sm mb-2" onclick="goldAction('finish')">‚ö° ƒ∞n≈üaat Bitir (5ü™ô)</button>
          <button class="btn btn-gold btn-block btn-sm mb-2" onclick="goldAction('npc')">üîÑ NPC T√ºccar (3ü™ô)</button>
          <button class="btn btn-gold btn-block btn-sm" onclick="goldAction('boost')">üìà +%25 √úretim (10ü™ô)</button>
        </div>
      </div>
      <div class="panel"><div class="panel-header">‚öîÔ∏è Askerler</div><div class="panel-body" id="troopSummary"><div class="queue-empty">Kƒ±≈üla gerekli</div></div></div>
    </div>
    <div class="main-content">
      <div id="view-dorf1"><div class="tab-bar"><button class="tab-btn active">üèòÔ∏è Kaynak Alanlarƒ±</button></div><div class="village-view" id="dorf1Map"></div></div>
      <div id="view-dorf2" class="hidden"><div class="tab-bar"><button class="tab-btn active">üè∞ ≈ûehir Merkezi</button></div><div class="village-view" id="dorf2Map"></div></div>
      <div id="view-map" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active">üó∫Ô∏è D√ºnya Haritasƒ±</button>
          <div style="flex:1"></div>
          <div class="flex items-center gap-2" style="padding:4px">
            <span class="fs-sm">X:</span><input type="number" id="mapGotoX" value="0" style="width:55px">
            <span class="fs-sm">Y:</span><input type="number" id="mapGotoY" value="0" style="width:55px">
            <button class="btn btn-green btn-sm" onclick="mapGoto()">Git</button>
          </div>
        </div>
        <div class="map-outer" id="mapOuter"><div class="map-scroll" id="mapScroll"></div><div class="map-coords"><span>X: <b id="mcX">0</b></span><span>Y: <b id="mcY">0</b></span></div></div>
      </div>
      <div id="view-stats" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active" onclick="showStatTab('top10')">üèÜ Top 10</button>
          <button class="tab-btn" onclick="showStatTab('players')">üë• Oyuncular</button>
          <button class="tab-btn" onclick="showStatTab('alliances')">üõ°Ô∏è ƒ∞ttifaklar</button>
        </div>
        <div id="statsContent"></div>
      </div>
      <div id="view-reports" class="hidden"><div class="tab-bar"><button class="tab-btn active">üìú Raporlar</button></div><div id="reportsContent"></div></div>
      <div id="view-alliance" class="hidden"><div class="tab-bar"><button class="tab-btn active">üõ°Ô∏è ƒ∞ttifak</button></div><div id="allianceContent"></div></div>
    </div>
    <div class="sidebar-right">
      <div class="panel"><div class="panel-header">üî® ƒ∞n≈üaat Kuyruƒüu</div><div class="panel-body" id="buildQueue"><div class="queue-empty">ƒ∞n≈üaat emri yok.</div></div></div>
      <div class="panel"><div class="panel-header">üó°Ô∏è Asker Hareketleri</div><div class="panel-body" id="troopMovements"><div class="queue-empty">Hareket yok.</div></div></div>
      <div class="panel"><div class="panel-header">üìã Bilgi Kutusu <button class="clear-btn" onclick="clearInfo()">Temizle ‚úï</button></div><div class="panel-body" id="infoBox"><div class="fs-sm" style="color:var(--text-dim)">Ho≈ü geldin! K√∂y√ºn√º geli≈ütir.</div></div></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="gameModal" class="modal-overlay hidden">
  <div class="modal-box"><div class="modal-header"><h3 id="modalTitle">-</h3><button class="modal-close" onclick="closeModal()">‚úï</button></div><div class="modal-body" id="modalBody"></div></div>
</div>
<!-- MAP TOOLTIP -->
<div class="map-tooltip" id="mapTip"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   YDS WARS ENGINE v2.0
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SPEED=10,MAP_SIZE=200,BOT_COUNT=1000,TICK_MS=1000;

const DORF1_LAYOUT=[
  {id:1,type:'wood',x:30,y:10},{id:2,type:'crop',x:50,y:5},{id:3,type:'wood',x:70,y:10},
  {id:4,type:'clay',x:15,y:25},{id:5,type:'iron',x:37,y:20},{id:6,type:'crop',x:58,y:18},{id:7,type:'clay',x:82,y:22},
  {id:8,type:'wood',x:8,y:45},{id:9,type:'crop',x:28,y:42},{id:10,type:'crop',x:65,y:40},{id:11,type:'iron',x:90,y:45},
  {id:12,type:'iron',x:15,y:65},{id:13,type:'clay',x:35,y:62},{id:14,type:'wood',x:60,y:62},{id:15,type:'crop',x:83,y:65},
  {id:16,type:'clay',x:28,y:82},{id:17,type:'crop',x:50,y:85},{id:18,type:'iron',x:72,y:82}
];
const DORF2_LAYOUT=[
  {id:19,x:18,y:14},{id:20,x:40,y:8},{id:21,x:60,y:8},{id:22,x:80,y:14},
  {id:23,x:8,y:32},{id:24,x:30,y:26},{id:25,x:68,y:26},{id:26,x:90,y:32},
  {id:27,x:14,y:50},{id:28,x:84,y:50},
  {id:29,x:48,y:40,isMain:true},
  {id:30,x:22,y:66},{id:31,x:42,y:60},{id:32,x:58,y:60},{id:33,x:78,y:66},
  {id:34,x:30,y:78},{id:35,x:50,y:76},{id:36,x:70,y:78},
  {id:37,x:10,y:85},{id:38,x:88,y:85},
  {id:39,x:52,y:22,isRally:true},
  {id:40,x:50,y:95,isWall:true}
];
const BUILDINGS={
  wood:{name:'Oduncu',icon:'ü™µ',desc:'Odun √ºretimini artƒ±rƒ±r.',cat:'field',cost:[40,100,50,60],time:26,prodBase:100},
  clay:{name:'Tuƒüla Ocaƒüƒ±',icon:'üß±',desc:'Tuƒüla √ºretimini artƒ±rƒ±r.',cat:'field',cost:[80,40,80,50],time:26,prodBase:100},
  iron:{name:'Demir Madeni',icon:'‚õèÔ∏è',desc:'Demir √ºretimini artƒ±rƒ±r.',cat:'field',cost:[100,80,30,60],time:26,prodBase:100},
  crop:{name:'Tarla',icon:'üåæ',desc:'Tahƒ±l √ºretimini artƒ±rƒ±r.',cat:'field',cost:[70,90,70,20],time:26,prodBase:100},
  center:{name:'Merkez Bina',icon:'üèõÔ∏è',desc:'ƒ∞n≈üaat s√ºrelerini kƒ±saltƒ±r.',cat:'infra',cost:[70,40,60,20],time:40,req:[]},
  warehouse:{name:'Depo',icon:'üì¶',desc:'Kaynak kapasitesini artƒ±rƒ±r.',cat:'infra',cost:[130,160,90,40],time:40,req:[{b:'center',lvl:1}],capBase:800},
  granary:{name:'Tahƒ±l Ambarƒ±',icon:'üè∫',desc:'Tahƒ±l kapasitesini artƒ±rƒ±r.',cat:'infra',cost:[80,100,70,20],time:35,req:[{b:'center',lvl:1}],capBase:800},
  cranny:{name:'Sƒ±ƒüƒ±nak',icon:'üï≥Ô∏è',desc:'Yaƒümadan korur.',cat:'infra',cost:[40,50,30,10],time:20,req:[]},
  embassy:{name:'El√ßilik',icon:'üè¥',desc:'ƒ∞ttifak kurmanƒ± saƒülar.',cat:'infra',cost:[180,130,150,80],time:60,req:[{b:'center',lvl:1}]},
  rally:{name:'Askeri √ús',icon:'üö©',desc:'Asker toplanma alanƒ±.',cat:'military',cost:[110,160,90,70],time:35,req:[]},
  barracks:{name:'Kƒ±≈üla',icon:'‚öîÔ∏è',desc:'Piyade eƒüitilir.',cat:'military',cost:[210,140,260,120],time:60,req:[{b:'center',lvl:3},{b:'rally',lvl:1}]},
  stable:{name:'Ahƒ±r',icon:'üê¥',desc:'S√ºvari eƒüitilir.',cat:'military',cost:[260,140,220,100],time:80,req:[{b:'center',lvl:5},{b:'barracks',lvl:3}]},
  academy:{name:'Akademi',icon:'üìö',desc:'Yeni birlikleri ara≈ütƒ±rƒ±r.',cat:'military',cost:[220,160,90,40],time:90,req:[{b:'center',lvl:3},{b:'barracks',lvl:3}]},
  blacksmith:{name:'Zƒ±rh D√∂k√ºmhanesi',icon:'üî®',desc:'Zƒ±rhlarƒ± geli≈ütirir.',cat:'military',cost:[170,200,380,130],time:100,req:[{b:'center',lvl:3},{b:'academy',lvl:1}]},
  market:{name:'Pazar Yeri',icon:'üè™',desc:'Kaynak takasƒ±.',cat:'infra',cost:[80,70,120,70],time:50,req:[{b:'center',lvl:1},{b:'warehouse',lvl:1}]},
  wall:{name:'Sur',icon:'üß±',desc:'Savunmayƒ± artƒ±rƒ±r.',cat:'defense',cost:[70,90,170,70],time:40,req:[]}
};
const TROOPS={
  Roman:{
    t1:{name:'Lejyoner',icon:'üó°Ô∏è',att:40,defI:35,defC:50,speed:6,carry:50,crop:1,cost:[120,100,150,30],time:30},
    t2:{name:'Praetorian',icon:'üõ°Ô∏è',att:30,defI:65,defC:35,speed:5,carry:20,crop:1,cost:[100,130,160,70],time:35},
    t3:{name:'ƒ∞mperian',icon:'‚öîÔ∏è',att:70,defI:40,defC:25,speed:7,carry:50,crop:1,cost:[150,160,210,80],time:40},
    t4:{name:'Equites Legati',icon:'üêé',att:0,defI:20,defC:10,speed:16,carry:0,crop:2,cost:[140,160,20,40],time:25},
    t5:{name:'Equites Imperatoris',icon:'üèá',att:120,defI:65,defC:50,speed:14,carry:100,crop:3,cost:[550,440,320,100],time:70},
    ram:{name:'Ko√ßba≈üƒ±',icon:'ü™µ',att:60,defI:30,defC:75,speed:4,carry:0,crop:3,cost:[900,360,500,70],time:120},
    senator:{name:'Senat√∂r',icon:'üëë',att:50,defI:40,defC:30,speed:4,carry:0,crop:5,cost:[5800,5300,5500,400],time:600}
  },
  Teuton:{
    t1:{name:'Sava≈ü√ßƒ±',icon:'ü™ì',att:40,defI:20,defC:5,speed:7,carry:60,crop:1,cost:[95,75,40,40],time:22},
    t2:{name:'Mƒ±zrak√ßƒ±',icon:'üî±',att:10,defI:35,defC:60,speed:7,carry:40,crop:1,cost:[145,70,85,40],time:28},
    t3:{name:'Baltacƒ±',icon:'‚öîÔ∏è',att:60,defI:30,defC:30,speed:6,carry:50,crop:1,cost:[130,120,170,70],time:35},
    t4:{name:'Teutonic Atlƒ±',icon:'üêé',att:55,defI:100,defC:40,speed:10,carry:110,crop:2,cost:[350,450,230,60],time:50},
    t5:{name:'Paladin',icon:'üèá',att:150,defI:50,defC:75,speed:9,carry:80,crop:3,cost:[550,640,800,180],time:80},
    ram:{name:'Ko√ßba≈üƒ±',icon:'ü™µ',att:65,defI:30,defC:80,speed:4,carry:0,crop:3,cost:[1000,300,350,70],time:120},
    chief:{name:'≈ûef',icon:'üëë',att:40,defI:60,defC:40,speed:4,carry:0,crop:4,cost:[35500,26600,25000,27200],time:600}
  },
  Turk:{
    t1:{name:'Akƒ±ncƒ±',icon:'üèπ',att:15,defI:40,defC:50,speed:7,carry:35,crop:1,cost:[100,130,55,30],time:25},
    t2:{name:'Kƒ±lƒ±√ß Ustasƒ±',icon:'üó°Ô∏è',att:45,defI:35,defC:20,speed:6,carry:45,crop:1,cost:[140,150,185,60],time:30},
    t3:{name:'Sipahi',icon:'üêé',att:90,defI:25,defC:40,speed:19,carry:75,crop:2,cost:[350,450,230,60],time:45},
    t4:{name:'Deli Atlƒ±',icon:'üèá',att:120,defI:65,defC:50,speed:16,carry:35,crop:2,cost:[360,330,280,120],time:55},
    t5:{name:'Yeni√ßeri',icon:'‚öîÔ∏è',att:155,defI:80,defC:60,speed:5,carry:50,crop:3,cost:[950,555,330,75],time:80},
    ram:{name:'Ko√ßba≈üƒ±',icon:'ü™µ',att:50,defI:30,defC:105,speed:4,carry:0,crop:3,cost:[950,555,330,75],time:120},
    bey:{name:'Bey',icon:'üëë',att:40,defI:60,defC:40,speed:5,carry:0,crop:4,cost:[30750,27200,24500,25200],time:600}
  }
};

let GS=null,currentUser=null,gameInterval=null;

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
function showLoginTab(t){document.getElementById('loginForm').classList.toggle('hidden',t!=='login');document.getElementById('registerForm').classList.toggle('hidden',t!=='register');document.querySelectorAll('.login-tabs button').forEach((b,i)=>b.classList.toggle('active',(t==='login'?i===0:i===1)));document.getElementById('loginError').style.display='none'}
function showError(m){const e=document.getElementById('loginError');e.textContent=m;e.style.display='block'}
function getUsers(){return JSON.parse(localStorage.getItem('yds_users')||'{}')}
function saveUsers(u){localStorage.setItem('yds_users',JSON.stringify(u))}
function doRegister(){const u=document.getElementById('regUser').value.trim(),p=document.getElementById('regPass').value,p2=document.getElementById('regPass2').value;if(!u||u.length<2)return showError('ƒ∞sim en az 2 karakter.');if(p.length<4)return showError('≈ûifre en az 4 karakter.');if(p!==p2)return showError('≈ûifreler e≈üle≈ümiyor.');const us=getUsers();if(us[u])return showError('Bu isim alƒ±nmƒ±≈ü.');us[u]={pass:p};saveUsers(us);currentUser=u;localStorage.setItem('yds_last_user',u);document.getElementById('loginScreen').classList.add('hidden');document.getElementById('tribeScreen').classList.remove('hidden')}
function doLogin(){const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value;if(!u||!p)return showError('Bilgileri gir.');const us=getUsers();if(!us[u]||us[u].pass!==p)return showError('Hatalƒ± giri≈ü.');currentUser=u;localStorage.setItem('yds_last_user',u);const s=localStorage.getItem('yds_gs_'+u);if(!s){document.getElementById('loginScreen').classList.add('hidden');document.getElementById('tribeScreen').classList.remove('hidden')}else{GS=JSON.parse(s);document.getElementById('loginScreen').classList.add('hidden');startGame()}}
function doLogout(){if(gameInterval)clearInterval(gameInterval);saveGame();currentUser=null;GS=null;document.getElementById('gameScreen').style.display='none';document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('loginUser').value='';document.getElementById('loginPass').value=''}
function selectTribe(t){initNewGame(t);document.getElementById('tribeScreen').classList.add('hidden');startGame()}

// ‚îÄ‚îÄ‚îÄ INIT GAME ‚îÄ‚îÄ‚îÄ
function initNewGame(tribe){
  const bots=generateBots();
  const px=Math.floor(Math.random()*7)-3,py=Math.floor(Math.random()*7)-3;
  GS={tribe,playerName:currentUser,gold:parseInt(localStorage.getItem('yds_game_gold'))||50,
    villages:[{id:1,name:currentUser+"'s K√∂y√º",x:px,y:py,
      resources:{wood:500,clay:500,iron:500,crop:500},warehouse:800,granary:800,
      fields:DORF1_LAYOUT.map(f=>({id:f.id,type:f.type,level:0})),
      buildings:DORF2_LAYOUT.map(b=>{if(b.isMain)return{id:b.id,type:'center',level:1};return{id:b.id,type:'empty',level:0,isRally:!!b.isRally,isWall:!!b.isWall}}),
      troops:{},buildQueue:[],troopQueue:[]}],
    activeVillage:0,population:2,alliance:null,reports:[],prodBoostUntil:0,
    bots,botAlliances:generateBotAlliances(bots),lastUpdate:Date.now(),troopMovements:[],gameStarted:Date.now(),
    botAttackScores:{},botDefenseScores:{},botRaidScores:{}};
  // Generate initial bot scores for Top 10
  bots.forEach(b=>{
    const att=Object.values(b.troops).reduce((s,c)=>s+c,0)*Math.floor(Math.random()*50);
    GS.botAttackScores[b.id]=att;
    GS.botDefenseScores[b.id]=Math.floor(att*0.6+Math.random()*10000);
    GS.botRaidScores[b.id]=Math.floor(att*2+Math.random()*50000);
  });
  saveGame()
}

function generateBots(){
  const bots=[],tribes=['Roman','Teuton','Turk'];
  const names=['Maximus','Brutus','Caesar','Alaric','Attila','Genghis','Timur','Mehmed','Osman','Ertuƒürul','Suleiman','Hannibal','Spartacus','Thor','Ragnar','Bjorn','Ivar','Erik','Harald','Magnus','Sven','Murat','Yavuz','Fatih','Selim','Bayezid','Orhan','Alp','KaraKurt','Ak≈ûahin','G√∂kB√∂r√º','Ate≈üHan','BuzKartal','Kƒ±zƒ±lAslan','DemirBey','Altƒ±nPa≈üa','G√ºm√º≈üKƒ±lƒ±√ß','Yƒ±ldƒ±zKalkan','Rakuns','CooLLegend','PREDATOR','pitu','somnuek','Shake','the_son','tokatci','BOZKURT','XDELI','TEYO','Forza1907','SAMSA','bekay','ada','Kanki','MONDAY','Sensoria','Sara'];
  const used=new Set();
  for(let i=0;i<BOT_COUNT;i++){
    let x,y;do{x=Math.floor(Math.random()*181)-90;y=Math.floor(Math.random()*181)-90}while(used.has(x+','+y)||(Math.abs(x)<4&&Math.abs(y)<4));
    used.add(x+','+y);
    const tribe=tribes[i%3];
    const name=i<names.length?names[i]:(names[Math.floor(Math.random()*names.length)]+(i));
    bots.push({id:i+100,name,tribe,x,y,pop:4+Math.floor(Math.random()*3),level:1,troops:generateBotTroops(tribe,1),alliance:null,lastGrow:Date.now()})
  }
  return bots
}
function generateBotTroops(tribe,lvl){const t={};const types=Object.keys(TROOPS[tribe]);for(let i=0;i<Math.min(2,types.length);i++)t[types[i]]=Math.floor(Math.random()*lvl*5)+2;return t}
function generateBotAlliances(bots){
  const alliances=[],aNames=['Wolfpack','Iron Legion','Storm Riders','Dark Order','Golden Horde','Blood Eagles','Thunder Clan','Fire Nation','Ice Bears','Shadow Guild','Kurtlar Vadisi','Osmanlƒ± Torunlarƒ±','Bozkurt ƒ∞ttifakƒ±','Kƒ±zƒ±l Elma','Turan Birliƒüi','Roma ƒ∞mparatorluƒüu','Cermen Karde≈üliƒüi','Akdeniz Birliƒüi','Vikingler','≈û√∂valyeler'];
  for(let i=0;i<20;i++){const members=[];const start=Math.floor(Math.random()*bots.length);const size=Math.floor(Math.random()*40)+10;for(let j=0;j<size&&members.length<60;j++){const idx=(start+j)%bots.length;if(!bots[idx].alliance){bots[idx].alliance=i;members.push(bots[idx].id)}}if(members.length>0)alliances.push({id:i,name:aNames[i]||('ƒ∞ttifak-'+(i+1)),leader:members[0],members})}
  return alliances
}
function saveGame(){if(GS&&currentUser)localStorage.setItem('yds_gs_'+currentUser,JSON.stringify(GS))}

// ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ
function startGame(){
  document.getElementById('gameScreen').style.display='block';
  const now=Date.now(),off=Math.floor((now-GS.lastUpdate)/1000);
  if(off>0)processOffline(off);
  GS.lastUpdate=now;
  const qg=parseInt(localStorage.getItem('yds_game_gold'))||0;
  if(qg>GS.gold)GS.gold=qg;
  updateTribeDisplay();renderDorf1();renderDorf2();updateUI();
  if(gameInterval)clearInterval(gameInterval);
  gameInterval=setInterval(gameTick,TICK_MS)
}

// ‚îÄ‚îÄ‚îÄ TICK ‚îÄ‚îÄ‚îÄ
function gameTick(){
  const now=Date.now(),v=GS.villages[GS.activeVillage];
  const prod=calcProduction(v),boost=(GS.prodBoostUntil>now)?1.25:1;
  v.resources.wood=Math.min(v.warehouse,v.resources.wood+(prod.wood*boost)/3600);
  v.resources.clay=Math.min(v.warehouse,v.resources.clay+(prod.clay*boost)/3600);
  v.resources.iron=Math.min(v.warehouse,v.resources.iron+(prod.iron*boost)/3600);
  v.resources.crop=Math.min(v.granary,v.resources.crop+(prod.crop*boost)/3600);
  processBuildQueue(v);processTroopQueue(v);processTroopMovements();
  if(now%30000<1100)botAI();
  GS.lastUpdate=now;updateUI();
  if(now%30000<1100)saveGame();
  // Sync gold from quiz
  const qg=parseInt(localStorage.getItem('yds_game_gold'))||0;
  if(qg>GS.gold){addInfo('Quiz\'den +'+(qg-GS.gold)+' altƒ±n geldi!','ü™ô');GS.gold=qg}
}
function calcProduction(v){
  let w=20*SPEED,c=20*SPEED,i=20*SPEED,cr=20*SPEED;
  v.fields.forEach(f=>{if(f.level>0){const p=Math.floor((BUILDINGS[f.type].prodBase||100)*Math.pow(1.25,f.level-1)*SPEED/10);if(f.type==='wood')w+=p;if(f.type==='clay')c+=p;if(f.type==='iron')i+=p;if(f.type==='crop')cr+=p}});
  let tc=0;const tt=TROOPS[GS.tribe];Object.entries(v.troops||{}).forEach(([k,cnt])=>{if(tt[k])tc+=tt[k].crop*cnt});
  cr-=tc*SPEED;return{wood:w,clay:c,iron:i,crop:cr}
}
function processBuildQueue(v){
  if(!v.buildQueue.length)return;
  let active=[];
  if(GS.tribe==='Roman'){const f=v.buildQueue.find(t=>t.isField),b=v.buildQueue.find(t=>!t.isField);if(f)active.push(f);if(b)active.push(b)}else active.push(v.buildQueue[0]);
  active.forEach(task=>{task.timeLeft-=SPEED;if(task.timeLeft<=0)completeConstruction(v,task)})
}
function completeConstruction(v,task){
  if(task.isField){const f=v.fields.find(x=>x.id===task.targetId);if(f)f.level++}
  else{const b=v.buildings.find(x=>x.id===task.targetId);if(b){if(b.type==='empty')b.type=task.type;b.level++;if(task.type==='warehouse')v.warehouse=800+b.level*400;if(task.type==='granary')v.granary=800+b.level*400}}
  GS.population+=Math.floor(Math.random()*3)+1;v.buildQueue=v.buildQueue.filter(t=>t.qId!==task.qId);
  addInfo(task.name+' tamamlandƒ±!','‚úÖ');renderDorf1();renderDorf2()
}
function processTroopQueue(v){if(!v.troopQueue||!v.troopQueue.length)return;v.troopQueue.forEach(tq=>{tq.timeLeft-=SPEED;if(tq.timeLeft<=0){v.troops[tq.type]=(v.troops[tq.type]||0)+tq.count;addInfo(tq.count+' '+TROOPS[GS.tribe][tq.type].name+' eƒüitildi!','‚öîÔ∏è')}});v.troopQueue=v.troopQueue.filter(t=>t.timeLeft>0)}
function processTroopMovements(){if(!GS.troopMovements||!GS.troopMovements.length)return;GS.troopMovements.forEach(mv=>{mv.timeLeft-=SPEED;if(mv.timeLeft<=0){if(mv.type==='attack')resolveAttack(mv);else if(mv.type==='return')resolveReturn(mv)}});GS.troopMovements=GS.troopMovements.filter(m=>m.timeLeft>0)}
function resolveAttack(mv){
  const target=GS.bots.find(b=>b.id===mv.targetId);if(!target)return;
  let attP=0;const tt=TROOPS[GS.tribe];Object.entries(mv.troops).forEach(([k,c])=>{if(tt[k])attP+=tt[k].att*c});
  let defP=0;const dt=TROOPS[target.tribe];Object.entries(target.troops).forEach(([k,c])=>{if(dt[k])defP+=(dt[k].defI+dt[k].defC)/2*c});
  defP*=1.02;const ratio=attP/(attP+defP+1),won=ratio>0.5;
  let loot={wood:0,clay:0,iron:0,crop:0},attL={},defL={};
  if(won){const lr=1-ratio;Object.entries(mv.troops).forEach(([k,c])=>{attL[k]=Math.floor(c*lr*0.8);mv.troops[k]=c-attL[k]});Object.entries(target.troops).forEach(([k,c])=>{defL[k]=c});target.troops={};let carry=0;Object.entries(mv.troops).forEach(([k,c])=>{if(tt[k])carry+=tt[k].carry*c});const bl=Math.min(carry/4,target.pop*10);loot={wood:Math.floor(bl),clay:Math.floor(bl),iron:Math.floor(bl),crop:Math.floor(bl)};target.pop=Math.max(4,target.pop-5)}
  else{Object.entries(mv.troops).forEach(([k,c])=>{attL[k]=Math.floor(c*0.9);mv.troops[k]=c-attL[k]});Object.entries(target.troops).forEach(([k,c])=>{defL[k]=Math.floor(c*(1-ratio)*0.3);target.troops[k]=c-defL[k]})}
  GS.reports.unshift({time:Date.now(),type:'attack',target:target.name,targetCoord:{x:target.x,y:target.y},won,attLosses:attL,defLosses:defL,loot});
  if(Object.values(mv.troops).some(c=>c>0)){const d=Math.sqrt((mv.fromX-target.x)**2+(mv.fromY-target.y)**2);const rt=Math.max(10,Math.floor(d*100/SPEED));GS.troopMovements.push({type:'return',troops:{...mv.troops},loot,villageId:mv.villageId,timeLeft:rt,totalTime:rt,fromName:target.name})}
  addInfo(won?'Zafer! Yaƒüma: '+Object.values(loot).reduce((a,b)=>a+b,0):'Saldƒ±rƒ± ba≈üarƒ±sƒ±z.',won?'‚öîÔ∏è':'üíÄ')
}
function resolveReturn(mv){const v=GS.villages.find(vl=>vl.id===mv.villageId);if(!v)return;Object.entries(mv.troops).forEach(([k,c])=>{v.troops[k]=(v.troops[k]||0)+c});if(mv.loot){v.resources.wood=Math.min(v.warehouse,v.resources.wood+mv.loot.wood);v.resources.clay=Math.min(v.warehouse,v.resources.clay+mv.loot.clay);v.resources.iron=Math.min(v.warehouse,v.resources.iron+mv.loot.iron);v.resources.crop=Math.min(v.granary,v.resources.crop+mv.loot.crop)}addInfo('Askerler d√∂nd√º!','üè†')}
function processOffline(s){const v=GS.villages[GS.activeVillage];const p=calcProduction(v);v.resources.wood=Math.min(v.warehouse,v.resources.wood+(p.wood/3600)*s);v.resources.clay=Math.min(v.warehouse,v.resources.clay+(p.clay/3600)*s);v.resources.iron=Math.min(v.warehouse,v.resources.iron+(p.iron/3600)*s);v.resources.crop=Math.min(v.granary,v.resources.crop+(p.crop/3600)*s);for(let i=0;i<Math.min(s,3600);i++){processBuildQueue(v);processTroopQueue(v)}}

// ‚îÄ‚îÄ‚îÄ BOT AI ‚îÄ‚îÄ‚îÄ
function botAI(){
  const now=Date.now();
  GS.bots.forEach(bot=>{
    if(now-bot.lastGrow>60000){
      bot.level=Math.min(20,bot.level+0.05);
      bot.pop+=Math.floor(Math.random()*2)+1;
      const types=Object.keys(TROOPS[bot.tribe]);
      const rT=types[Math.floor(Math.random()*Math.min(3,types.length))];
      bot.troops[rT]=(bot.troops[rT]||0)+Math.floor(Math.random()*2)+1;
      bot.lastGrow=now;
      // Update scores gradually
      if(GS.botAttackScores){GS.botAttackScores[bot.id]=(GS.botAttackScores[bot.id]||0)+Math.floor(Math.random()*100);GS.botDefenseScores[bot.id]=(GS.botDefenseScores[bot.id]||0)+Math.floor(Math.random()*80);GS.botRaidScores[bot.id]=(GS.botRaidScores[bot.id]||0)+Math.floor(Math.random()*500)}
    }
  })
}

// ‚îÄ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ
function updateUI(){
  const v=GS.villages[GS.activeVillage],prod=calcProduction(v),boost=(GS.prodBoostUntil>Date.now())?1.25:1;
  document.getElementById('r-wood').textContent=fN(Math.floor(v.resources.wood));
  document.getElementById('r-clay').textContent=fN(Math.floor(v.resources.clay));
  document.getElementById('r-iron').textContent=fN(Math.floor(v.resources.iron));
  document.getElementById('r-crop').textContent=fN(Math.floor(v.resources.crop));
  document.getElementById('r-wood-cap').textContent=fN(v.warehouse);
  document.getElementById('r-clay-cap').textContent=fN(v.warehouse);
  document.getElementById('r-iron-cap').textContent=fN(v.warehouse);
  document.getElementById('r-crop-cap').textContent=fN(v.granary);
  document.getElementById('r-gold').textContent=GS.gold;
  document.getElementById('p-wood').textContent=fN(Math.floor(prod.wood*boost));
  document.getElementById('p-clay').textContent=fN(Math.floor(prod.clay*boost));
  document.getElementById('p-iron').textContent=fN(Math.floor(prod.iron*boost));
  document.getElementById('p-crop').textContent=fN(Math.floor(prod.crop*boost));
  document.getElementById('population').textContent=GS.population;
  document.getElementById('villageName').textContent=v.name;
  renderBuildQueue(v);renderTroopSummary(v);renderTroopMovements();
  const d=new Date();document.getElementById('serverTime').textContent=String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0')
}
function updateTribeDisplay(){const ic={Roman:'üèõÔ∏è',Teuton:'ü™ì',Turk:'üèá'},nm={Roman:'Romalƒ±lar',Teuton:'Cermenler',Turk:'T√ºrkler'};document.getElementById('tribeEmoji').textContent=ic[GS.tribe];document.getElementById('tribeName').textContent=nm[GS.tribe]}
function renderBuildQueue(v){
  const el=document.getElementById('buildQueue');
  if(!v.buildQueue.length&&(!v.troopQueue||!v.troopQueue.length)){el.innerHTML='<div class="queue-empty">ƒ∞n≈üaat emri yok.</div>';return}
  let h='';v.buildQueue.forEach((t,i)=>{let act=false;if(GS.tribe==='Roman'){if(t===v.buildQueue.find(x=>x.isField)||t===v.buildQueue.find(x=>!x.isField))act=true}else if(i===0)act=true;h+=`<div class="queue-item ${act?'active':''}"><span class="fw-700">${t.name} Sv.${t.targetLevel}</span><span class="q-time">${act?fT(Math.max(0,t.timeLeft)):'‚è∏Ô∏è'}</span></div>`});
  if(v.troopQueue)v.troopQueue.forEach(tq=>{h+=`<div class="queue-item active"><span class="fw-700">üó°Ô∏è ${tq.count}x ${TROOPS[GS.tribe][tq.type]?.name||tq.type}</span><span class="q-time">${fT(Math.max(0,tq.timeLeft))}</span></div>`});
  el.innerHTML=h
}
function renderTroopSummary(v){
  const el=document.getElementById('troopSummary'),tt=TROOPS[GS.tribe];
  if(!v.troops||!Object.keys(v.troops).length){el.innerHTML=`<div class="queue-empty">${v.buildings.some(b=>b.type==='barracks'&&b.level>0)?'Asker yok.':'Kƒ±≈üla gerekli'}</div>`;return}
  let h='';Object.entries(v.troops).forEach(([k,c])=>{if(c>0&&tt[k])h+=`<div class="troop-row"><span style="font-size:1.2rem">${tt[k].icon}</span><div style="flex:1"><div class="fw-700 fs-sm">${tt[k].name}</div></div><span class="fw-700 text-gold" style="font-size:1.1rem">${c}</span></div>`});
  el.innerHTML=h||'<div class="queue-empty">Asker yok.</div>'
}
function renderTroopMovements(){const el=document.getElementById('troopMovements');if(!GS.troopMovements||!GS.troopMovements.length){el.innerHTML='<div class="queue-empty">Hareket yok.</div>';return}let h='';GS.troopMovements.forEach(mv=>{h+=`<div class="queue-item active"><span class="fw-700">${mv.type==='attack'?'‚öîÔ∏è Saldƒ±rƒ±':'üè† D√∂n√º≈ü'}</span><span class="q-time">${fT(Math.max(0,mv.timeLeft))}</span></div>`});el.innerHTML=h}

// ‚îÄ‚îÄ‚îÄ RENDER DORF1 (Resource Fields with Icons) ‚îÄ‚îÄ‚îÄ
function renderDorf1(){
  const v=GS.villages[GS.activeVillage],map=document.getElementById('dorf1Map');
  let h='<div class="village-bg dorf1-bg"></div>';
  // Rivers
  h+='<div class="river" style="top:20%;left:5%;width:90%;transform:rotate(-12deg)"></div>';
  h+='<div class="river" style="bottom:25%;left:0;width:85%;transform:rotate(8deg)"></div>';
  // Resource zone backgrounds
  v.fields.forEach(f=>{
    const l=DORF1_LAYOUT.find(x=>x.id===f.id);
    if(f.level>0)h+=`<div class="res-zone ${f.type}-zone" style="left:calc(${l.x}% - 30px);top:calc(${l.y}% - 30px);width:60px;height:60px"></div>`;
  });
  // Center village
  h+='<div class="village-center">üè†</div>';
  // Slots with icons
  v.fields.forEach(f=>{
    const l=DORF1_LAYOUT.find(x=>x.id===f.id);
    const icons={wood:'ü™µ',clay:'üß±',iron:'‚õèÔ∏è',crop:'üåæ'};
    if(f.level>0){
      h+=`<div class="village-slot s-${f.type}" style="left:calc(${l.x}% - 22px);top:calc(${l.y}% - 22px)" onclick="openBuildModal(${f.id},'field')"><span class="slot-icon">${icons[f.type]}</span><span class="slot-lvl">${f.level}</span></div>`;
    }else{
      h+=`<div class="village-slot empty" style="left:calc(${l.x}% - 22px);top:calc(${l.y}% - 22px)" onclick="openBuildModal(${f.id},'field')"></div>`;
    }
  });
  map.innerHTML=h
}

// ‚îÄ‚îÄ‚îÄ RENDER DORF2 (City with Icons) ‚îÄ‚îÄ‚îÄ
function renderDorf2(){
  const v=GS.villages[GS.activeVillage],map=document.getElementById('dorf2Map');
  let h='<div class="village-bg dorf2-bg"></div>';
  h+='<div class="river" style="top:15%;left:0;width:100%;transform:rotate(-5deg)"></div>';
  h+='<div class="village-center">üè∞</div>';
  v.buildings.forEach(b=>{
    const l=DORF2_LAYOUT.find(x=>x.id===b.id);
    const info=BUILDINGS[b.type];
    if(b.level>0&&b.type!=='empty'){
      let cls=b.type==='center'?'s-main':l.isRally?'s-rally':l.isWall?'s-wall':'s-building';
      const icon=info?info.icon:'üèóÔ∏è';
      if(l.isWall)h+=`<div class="village-slot ${cls}" style="left:calc(${l.x}% - 60px);top:calc(${l.y}% - 15px)" onclick="openBuildModal(${b.id},'building')">${icon} ${info?.name||''} ${b.level}</div>`;
      else h+=`<div class="village-slot ${cls}" style="left:calc(${l.x}% - ${l.isMain?28:22}px);top:calc(${l.y}% - ${l.isMain?28:22}px)" onclick="openBuildModal(${b.id},'building')"><span class="slot-icon">${icon}</span><span class="slot-lvl">${b.level}</span></div>`;
    }else{
      h+=`<div class="village-slot empty" style="left:calc(${l.x}% - 22px);top:calc(${l.y}% - 22px)" onclick="openBuildModal(${b.id},'building')"></div>`;
    }
  });
  map.innerHTML=h
}

// ‚îÄ‚îÄ‚îÄ WORLD MAP (Improved) ‚îÄ‚îÄ‚îÄ
let mapBuilt=false;
function buildMap(){
  if(mapBuilt)return;mapBuilt=true;
  const scroll=document.getElementById('mapScroll'),v=GS.villages[GS.activeVillage];
  const range=20,cx=v.x||0,cy=v.y||0;
  // Build village lookup
  const vLookup={};vLookup[cx+','+cy]={type:'player',data:v};
  GS.bots.forEach(b=>{vLookup[b.x+','+b.y]={type:'bot',data:b}});
  // Build table
  let h='<table class="map-grid-table"><thead><tr><td style="width:25px;min-width:25px;background:#2d2011"></td>';
  for(let dx=-range;dx<=range;dx++)h+=`<td style="background:#2d2011;font-size:0.65rem;color:var(--text-dim);padding:2px">${cx+dx}</td>`;
  h+='</tr></thead><tbody>';
  for(let dy=-range;dy<=range;dy++){
    h+=`<tr><td style="background:#2d2011;font-size:0.65rem;color:var(--text-dim);padding:2px;min-width:25px">${cy-dy}</td>`;
    for(let dx=-range;dx<=range;dx++){
      const wx=cx+dx,wy=cy-dy;
      const key=wx+','+wy;
      const vil=vLookup[key];
      // Terrain - NO water if there's a village
      let terrain='terrain-grass';
      if(!vil){
        const n=Math.sin(wx*0.3)*Math.cos(wy*0.3);
        const n2=Math.sin(wx*0.1+wy*0.15);
        if(n2>0.85)terrain='terrain-water';
        else if(n>0.5)terrain='terrain-forest';
        else if(n<-0.6)terrain='terrain-mountain';
        else if(Math.abs(wx)%7===0&&Math.abs(wy)%5===0)terrain='terrain-grass2';
      }
      h+=`<td class="${terrain}" data-x="${wx}" data-y="${wy}" onmouseover="mapHover(event,${wx},${wy})" onmouseout="mapHoverOut()">`;
      if(vil){
        if(vil.type==='player'){
          h+=`<div class="mv player" onclick="showVInfo(0,'player')">üè†</div>`;
        }else{
          const b=vil.data;
          const pc=b.pop<100?'pop-tiny':b.pop<250?'pop-small':b.pop<500?'pop-med':'pop-large';
          const tc='tribe-'+b.tribe.toLowerCase();
          const icons={Roman:'üèõÔ∏è',Teuton:'ü™ì',Turk:'üèá'};
          // Village visual based on pop
          const vIcon=b.pop<100?'üèïÔ∏è':b.pop<250?'üèòÔ∏è':b.pop<500?'üè∞':'üè∞';
          h+=`<div class="mv ${pc} ${tc}" onclick="showVInfo(${b.id},'bot')"><span class="mv-icon">${b.pop>=250?'üè∞':b.pop>=100?'üèòÔ∏è':'üèïÔ∏è'}</span><span class="mv-name">${b.name.substring(0,6)}</span></div>`;
        }
      } else if(terrain==='terrain-forest'){
        h+='<span style="font-size:0.8rem;opacity:0.5">üå≤</span>';
      } else if(terrain==='terrain-mountain'){
        h+='<span style="font-size:0.8rem;opacity:0.5">‚õ∞Ô∏è</span>';
      } else if(terrain==='terrain-water'){
        h+='<span style="font-size:0.8rem;opacity:0.5">üåä</span>';
      }
      h+='</td>';
    }
    h+='</tr>';
  }
  h+='</tbody></table>';
  scroll.innerHTML=h;
  // Center on player
  requestAnimationFrame(()=>{
    const cellW=60,offset=range;
    scroll.scrollLeft=offset*cellW-scroll.clientWidth/2+cellW/2+25;
    scroll.scrollTop=offset*cellW-scroll.clientHeight/2+cellW/2
  })
}
function mapHover(e,x,y){
  const tip=document.getElementById('mapTip');
  const key=x+','+y;
  const v=GS.villages[GS.activeVillage];
  let vilData=null;
  if(x===v.x&&y===v.y)vilData={name:v.name,tribe:GS.tribe,pop:GS.population,type:'player'};
  else{const b=GS.bots.find(b=>b.x===x&&b.y===y);if(b){const aName=b.alliance!==null?GS.botAlliances.find(a=>a.id===b.alliance)?.name:null;vilData={name:b.name,tribe:b.tribe,pop:b.pop,alliance:aName,type:'bot'}}}
  if(vilData){
    tip.innerHTML=`<div class="tt-name">${vilData.name}</div><div class="tt-coord">(${x}|${y})</div><div class="tt-info">Oyuncu: ${vilData.name}<br>N√ºfus: ${vilData.pop}<br>Halk: ${vilData.tribe==='Roman'?'Romalƒ±lar':vilData.tribe==='Teuton'?'Cermenler':'T√ºrkler'}${vilData.alliance?'<br>Birlik: '+vilData.alliance:''}</div>`;
    tip.style.display='block'
  }else{
    tip.innerHTML=`<div class="tt-coord">(${x}|${y})</div><div class="tt-info">Bo≈ü arazi</div>`;
    tip.style.display='block'
  }
  tip.style.left=Math.min(e.clientX+15,window.innerWidth-230)+'px';
  tip.style.top=Math.min(e.clientY+15,window.innerHeight-100)+'px';
  document.getElementById('mcX').textContent=x;document.getElementById('mcY').textContent=y
}
function mapHoverOut(){document.getElementById('mapTip').style.display='none'}
function mapGoto(){mapBuilt=false;const v=GS.villages[GS.activeVillage];const x=parseInt(document.getElementById('mapGotoX').value)||0;const y=parseInt(document.getElementById('mapGotoY').value)||0;v.x_view=x;v.y_view=y;buildMap()}

function showVInfo(id,type){
  const t=document.getElementById('modalTitle'),bd=document.getElementById('modalBody');
  if(type==='player'){const v=GS.villages[0];t.textContent='üè† '+v.name;bd.innerHTML=`<div>Koordinat: (${v.x}, ${v.y})</div><div>N√ºfus: ${GS.population}</div><div>Kabile: ${GS.tribe}</div><div class="mt-2"><button class="btn btn-green btn-sm" onclick="closeModal();showView('dorf1')">K√∂ye Git</button></div>`}
  else{const b=GS.bots.find(x=>x.id===id);if(!b)return;const a=b.alliance!==null?GS.botAlliances.find(x=>x.id===b.alliance):null;t.textContent='üèòÔ∏è '+b.name;
    let th='';const dt=TROOPS[b.tribe];Object.entries(b.troops).forEach(([k,c])=>{if(c>0&&dt[k])th+=`<div class="fs-sm">${dt[k].icon} ${dt[k].name}: ~${Math.floor(c*0.7)}+</div>`});
    bd.innerHTML=`<div class="flex gap-2 items-center mb-2"><span style="font-size:1.5rem">${b.tribe==='Roman'?'üèõÔ∏è':b.tribe==='Teuton'?'ü™ì':'üèá'}</span><b>${b.tribe==='Roman'?'Romalƒ±lar':b.tribe==='Teuton'?'Cermenler':'T√ºrkler'}</b></div><div class="fs-sm mb-1">Koordinat: (${b.x}, ${b.y})</div><div class="fs-sm mb-1">N√ºfus: ~${b.pop}</div>${a?'<div class="fs-sm mb-1">ƒ∞ttifak: üõ°Ô∏è '+a.name+'</div>':''}<hr class="divider"><h4 style="font-size:0.9rem">Ke≈üif (Tahmini):</h4><div class="mt-1">${th||'<div class="fs-sm" style="color:var(--text-dim)">Bilgi yok</div>'}</div><hr class="divider"><button class="btn btn-red btn-sm" onclick="closeModal();prefillAttack(${b.x},${b.y})">‚öîÔ∏è Saldƒ±r</button>`}
  document.getElementById('gameModal').classList.remove('hidden')
}
function prefillAttack(x,y){openAttackModal();setTimeout(()=>{const xe=document.getElementById('attX'),ye=document.getElementById('attY');if(xe)xe.value=x;if(ye)ye.value=y},100)}

// ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ
function showView(view){['dorf1','dorf2','map','stats','reports','alliance'].forEach(v=>{document.getElementById('view-'+v).classList.toggle('hidden',v!==view);document.getElementById('nav-'+v)?.classList.toggle('active',v===view)});if(view==='stats')renderTop10();if(view==='reports')renderReports();if(view==='alliance')renderAlliance();if(view==='map')setTimeout(()=>buildMap(),50)}

// ‚îÄ‚îÄ‚îÄ TOP 10 STATISTICS ‚îÄ‚îÄ‚îÄ
function renderTop10(){
  const el=document.getElementById('statsContent');
  if(!GS.botAttackScores)GS.botAttackScores={};
  // Sort bots by various scores
  const byAtt=[...GS.bots].sort((a,b)=>(GS.botAttackScores[b.id]||0)-(GS.botAttackScores[a.id]||0)).slice(0,10);
  const byDef=[...GS.bots].sort((a,b)=>(GS.botDefenseScores[b.id]||0)-(GS.botDefenseScores[a.id]||0)).slice(0,10);
  const byRaid=[...GS.bots].sort((a,b)=>(GS.botRaidScores[b.id]||0)-(GS.botRaidScores[a.id]||0)).slice(0,10);
  const byPop=[...GS.bots].sort((a,b)=>b.pop-a.pop).slice(0,10);

  function makeTable(title,data,scoreFn,scoreLabel){
    let h=`<div class="top10-box"><div class="top10-title">${title}</div><table class="top10-table"><thead><tr><th class="rank">‚Ññ</th><th>Oyuncu</th><th style="text-align:right">${scoreLabel}</th></tr></thead><tbody>`;
    data.forEach((b,i)=>{h+=`<tr><td class="rank">${i+1}.</td><td>${b.name}</td><td class="val">${fN(scoreFn(b))}</td></tr>`});
    // Player row
    h+=`<tr class="me"><td class="rank">?</td><td>‚≠ê ${GS.playerName}</td><td class="val">0</td></tr>`;
    h+='</tbody></table></div>';return h
  }
  el.innerHTML=`<div class="top10-wrapper">
    ${makeTable('‚öîÔ∏è Haftanƒ±n Saldƒ±rƒ±da En ƒ∞yileri',byAtt,b=>GS.botAttackScores[b.id]||0,'Puanlar')}
    ${makeTable('üõ°Ô∏è Haftanƒ±n Savunmada En ƒ∞yileri',byDef,b=>GS.botDefenseScores[b.id]||0,'Puanlar')}
    ${makeTable('üí∞ Haftanƒ±n Yaƒümada En ƒ∞yileri',byRaid,b=>GS.botRaidScores[b.id]||0,'Kaynaklar')}
    ${makeTable('üëë En Kalabalƒ±k K√∂yler',byPop,b=>b.pop,'N√ºfus')}
  </div>`
}
function showStatTab(tab){
  document.querySelectorAll('#view-stats .tab-btn').forEach((b,i)=>b.classList.toggle('active',(tab==='top10'&&i===0)||(tab==='players'&&i===1)||(tab==='alliances'&&i===2)));
  const el=document.getElementById('statsContent');
  if(tab==='top10')return renderTop10();
  if(tab==='players'){
    let all=[{name:GS.playerName,tribe:GS.tribe,pop:GS.population,isP:true}];GS.bots.forEach(b=>all.push({name:b.name,tribe:b.tribe,pop:b.pop,isP:false}));all.sort((a,b)=>b.pop-a.pop);
    let h='<table class="stats-table"><thead><tr><th>#</th><th>Oyuncu</th><th>Kabile</th><th>N√ºfus</th></tr></thead><tbody>';
    all.slice(0,100).forEach((p,i)=>{const ic={Roman:'üèõÔ∏è',Teuton:'ü™ì',Turk:'üèá'};h+=`<tr style="${p.isP?'background:rgba(255,215,0,0.1);font-weight:700':''}"><td>${i+1}</td><td>${ic[p.tribe]} ${p.name}${p.isP?' ‚≠ê':''}</td><td>${p.tribe}</td><td>${p.pop}</td></tr>`});
    h+='</tbody></table>';el.innerHTML=h
  }
  if(tab==='alliances'){
    let h='<table class="stats-table"><thead><tr><th>#</th><th>ƒ∞ttifak</th><th>√úye</th><th>Toplam N√ºfus</th></tr></thead><tbody>';
    const sorted=[...GS.botAlliances].map(a=>{let tp=0;a.members.forEach(mid=>{const b=GS.bots.find(x=>x.id===mid);if(b)tp+=b.pop});return{...a,tp}}).sort((a,b)=>b.tp-a.tp);
    sorted.forEach((a,i)=>{h+=`<tr><td>${i+1}</td><td>üõ°Ô∏è ${a.name}</td><td>${a.members.length}</td><td>${a.tp}</td></tr>`});
    h+='</tbody></table>';el.innerHTML=h
  }
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ
function renderReports(){const el=document.getElementById('reportsContent');if(!GS.reports||!GS.reports.length){el.innerHTML='<div class="queue-empty" style="padding:30px">Hen√ºz rapor yok.</div>';return}let h='';GS.reports.forEach((r,i)=>{const d=new Date(r.time);const ts=String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');h+=`<div class="report-item" onclick="showReport(${i})"><div class="flex justify-between"><span class="fw-700" style="color:${r.won?'var(--success)':'var(--danger)'}">${r.won?'‚öîÔ∏è Zafer':'üíÄ Yenilgi'}</span><span class="fs-sm" style="color:var(--text-dim)">${ts}</span></div><div class="fs-sm">Hedef: ${r.target} (${r.targetCoord.x},${r.targetCoord.y})</div>${r.loot?`<div class="fs-sm text-green">Yaƒüma: ü™µ${r.loot.wood} üß±${r.loot.clay} ‚õèÔ∏è${r.loot.iron} üåæ${r.loot.crop}</div>`:''}</div>`});el.innerHTML=h}
function showReport(i){const r=GS.reports[i];if(!r)return;document.getElementById('modalTitle').textContent=(r.won?'‚öîÔ∏è Zafer':'üíÄ Yenilgi')+' - '+r.target;let al='';Object.entries(r.attLosses||{}).forEach(([k,c])=>{if(c>0)al+=`<div class="fs-sm text-red">-${c} ${TROOPS[GS.tribe][k]?.name||k}</div>`});document.getElementById('modalBody').innerHTML=`<div class="mb-2"><b>Hedef:</b> ${r.target} (${r.targetCoord.x}, ${r.targetCoord.y})</div><div class="mb-2"><b>Sonu√ß:</b> <span class="${r.won?'text-green':'text-red'}">${r.won?'ZAFER':'YENƒ∞LGƒ∞'}</span></div>${r.loot?`<div class="mb-2"><b>Yaƒüma:</b> ü™µ${r.loot.wood} üß±${r.loot.clay} ‚õèÔ∏è${r.loot.iron} üåæ${r.loot.crop}</div>`:''}<hr class="divider"><div class="mb-1"><b>Kayƒ±plarƒ±mƒ±z:</b></div>${al||'<div class="fs-sm text-green">Kayƒ±p yok</div>'}`;document.getElementById('gameModal').classList.remove('hidden')}

// ‚îÄ‚îÄ‚îÄ ALLIANCE ‚îÄ‚îÄ‚îÄ
function renderAlliance(){const el=document.getElementById('allianceContent'),v=GS.villages[GS.activeVillage];const hasE=v.buildings.some(b=>b.type==='embassy'&&b.level>0);if(!hasE){el.innerHTML='<div class="panel"><div class="panel-body text-center" style="padding:30px"><div style="font-size:3rem">üè¥</div><h3 class="mt-2">El√ßilik Gerekli</h3><p class="fs-sm" style="color:var(--text-dim)">ƒ∞ttifak i√ßin El√ßilik binasƒ± in≈üa et.</p></div></div>';return}if(!GS.alliance){let h='<div class="panel"><div class="panel-header">üõ°Ô∏è ƒ∞ttifak Kur / Katƒ±l</div><div class="panel-body"><div class="mb-2"><input type="text" id="newAN" placeholder="ƒ∞ttifak adƒ±..." style="width:100%;padding:8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;color:var(--text)"><button class="btn btn-green btn-block mt-1" onclick="createAlliance()">üõ°Ô∏è Yeni ƒ∞ttifak Kur</button></div><hr class="divider"><h4 style="font-size:0.9rem;margin-bottom:8px">Mevcut ƒ∞ttifaklar:</h4>';GS.botAlliances.slice(0,10).forEach(a=>{h+=`<div class="flex justify-between items-center mb-1" style="padding:6px;border:1px solid var(--border);border-radius:4px"><span class="fs-sm fw-700">üõ°Ô∏è ${a.name} (${a.members.length})</span><button class="btn btn-green btn-sm" onclick="joinAlliance(${a.id})">Katƒ±l</button></div>`});h+='</div></div>';el.innerHTML=h}else{const a=GS.alliance;let h=`<div class="panel"><div class="panel-header">üõ°Ô∏è ${a.name}</div><div class="panel-body"><div class="mb-2 fs-sm">√úye: <b>${a.members.length+1}</b></div><div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05)" class="flex justify-between"><b>‚≠ê ${GS.playerName}</b><span>${GS.population}</span></div>`;a.members.forEach(mid=>{const b=GS.bots.find(x=>x.id===mid);if(b)h+=`<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.85rem" class="flex justify-between"><span>${b.name}</span><span>${b.pop}</span></div>`});h+=`<hr class="divider"><button class="btn btn-red btn-sm" onclick="leaveAlliance()">ƒ∞ttifaktan Ayrƒ±l</button></div></div>`;el.innerHTML=h}}
function createAlliance(){const n=document.getElementById('newAN')?.value?.trim();if(!n||n.length<2){alert('ƒ∞sim gerekli!');return}GS.alliance={name:n,members:[],created:Date.now()};addInfo('ƒ∞ttifak kuruldu: '+n,'üõ°Ô∏è');renderAlliance()}
function joinAlliance(id){const a=GS.botAlliances.find(x=>x.id===id);if(!a)return;GS.alliance={name:a.name,members:a.members.slice(0,20),created:Date.now()};addInfo(a.name+' ittifakƒ±na katƒ±ldƒ±n!','üõ°Ô∏è');renderAlliance()}
function leaveAlliance(){GS.alliance=null;addInfo('ƒ∞ttifaktan ayrƒ±ldƒ±n.','üõ°Ô∏è');renderAlliance()}

// ‚îÄ‚îÄ‚îÄ BUILD / TRAIN / ATTACK MODALS ‚îÄ‚îÄ‚îÄ
function openBuildModal(id,mapType){const v=GS.villages[GS.activeVillage];let item;if(mapType==='field')item=v.fields.find(f=>f.id===id);else item=v.buildings.find(b=>b.id===id);if(!item)return;const t=document.getElementById('modalTitle'),bd=document.getElementById('modalBody');
  if(item.type&&item.type!=='empty'&&item.level>0){const info=BUILDINGS[item.type];if(!info)return;const nl=item.level+1,costs=calcCost(info.cost,item.level),time=calcTime(info.time,item.level,v);const ok=v.resources.wood>=costs[0]&&v.resources.clay>=costs[1]&&v.resources.iron>=costs[2]&&v.resources.crop>=costs[3];
    t.textContent=info.name+' - Seviye '+item.level;
    bd.innerHTML=`<div class="flex gap-3 items-center mb-2"><span style="font-size:2.5rem">${info.icon}</span><div><div class="fw-700 text-gold" style="font-size:1.1rem">${info.name} <span style="color:var(--text-dim);font-size:0.85rem">Sv.${item.level}</span></div><div class="fs-sm" style="color:var(--text-dim)">${info.desc}</div>${info.prodBase?`<div class="mt-1 fs-sm text-green">√úretim: ${Math.floor(info.prodBase*Math.pow(1.25,item.level-1)*SPEED/10)} ‚Üí ${Math.floor(info.prodBase*Math.pow(1.25,nl-1)*SPEED/10)}/saat</div>`:''}</div></div><hr class="divider"><h4 style="font-size:0.9rem;margin-bottom:8px">Seviye ${nl} Maliyeti:</h4><div class="flex gap-3 mb-2" style="flex-wrap:wrap"><div class="b-cost ${v.resources.wood<costs[0]?'insufficient':''}"><span class="res-dot wood"></span> ${fN(costs[0])}</div><div class="b-cost ${v.resources.clay<costs[1]?'insufficient':''}"><span class="res-dot clay"></span> ${fN(costs[1])}</div><div class="b-cost ${v.resources.iron<costs[2]?'insufficient':''}"><span class="res-dot iron"></span> ${fN(costs[2])}</div><div class="b-cost ${v.resources.crop<costs[3]?'insufficient':''}"><span class="res-dot crop"></span> ${fN(costs[3])}</div><div class="b-cost">‚è±Ô∏è ${fT(time)}</div></div><button class="btn ${ok?'btn-green':'btn-red'} btn-block" ${ok?`onclick="issueUpgrade(${id},'${item.type}',${mapType==='field'},${nl})"`:''}>‚¨ÜÔ∏è ${ok?'Seviye '+nl+' Yap':'Yetersiz Kaynak'}</button>${item.type==='barracks'||item.type==='stable'?`<hr class="divider"><button class="btn btn-gold btn-block" onclick="closeModal();openTroopModal('${item.type}')">üó°Ô∏è Asker Eƒüit</button>`:''} ${item.type==='rally'?`<hr class="divider"><button class="btn btn-red btn-block" onclick="closeModal();openAttackModal()">‚öîÔ∏è Saldƒ±rƒ± G√∂nder</button>`:''} ${item.type==='embassy'?`<hr class="divider"><button class="btn btn-green btn-block" onclick="closeModal();showView('alliance')">üõ°Ô∏è ƒ∞ttifak</button>`:''}`
  }else{
    const layout=mapType==='building'?DORF2_LAYOUT.find(l=>l.id===id):null;t.textContent=mapType==='field'?'Kaynak Y√ºkselt':'Yeni Bina ƒ∞n≈üa Et';let h='';
    if(mapType==='field'){const fi=v.fields.find(f=>f.id===id);const info=BUILDINGS[fi.type];const costs=calcCost(info.cost,0),time=calcTime(info.time,0,v);const ok=v.resources.wood>=costs[0]&&v.resources.clay>=costs[1]&&v.resources.iron>=costs[2]&&v.resources.crop>=costs[3];h=`<div class="build-item"><div class="b-icon">${info.icon}</div><div class="b-info"><div class="b-name">${info.name}</div><div class="b-desc">${info.desc}</div><div class="b-costs"><div class="b-cost ${v.resources.wood<costs[0]?'insufficient':''}"><span class="res-dot wood"></span>${fN(costs[0])}</div><div class="b-cost ${v.resources.clay<costs[1]?'insufficient':''}"><span class="res-dot clay"></span>${fN(costs[1])}</div><div class="b-cost ${v.resources.iron<costs[2]?'insufficient':''}"><span class="res-dot iron"></span>${fN(costs[2])}</div><div class="b-cost ${v.resources.crop<costs[3]?'insufficient':''}"><span class="res-dot crop"></span>${fN(costs[3])}</div><div class="b-cost">‚è±Ô∏è${fT(time)}</div></div></div><div>${ok?`<button class="btn btn-green btn-sm" onclick="issueUpgrade(${id},'${fi.type}',true,1)">ƒ∞n≈üa Et</button>`:'<button class="btn btn-red btn-sm" disabled>‚ùå</button>'}</div></div>`}
    else{const ft=['wood','clay','iron','crop'];Object.entries(BUILDINGS).forEach(([type,info])=>{if(ft.includes(type))return;if(layout?.isWall&&type!=='wall')return;if(layout&&!layout.isWall&&type==='wall')return;if(layout?.isRally&&type!=='rally')return;if(layout&&!layout.isRally&&type==='rally')return;const ab=v.buildings.some(b=>b.type===type&&b.level>0);if(ab&&!['cranny','warehouse','granary'].includes(type))return;let canB=true,rt='';(info.req||[]).forEach(r=>{if(!v.buildings.find(b=>b.type===r.b&&b.level>=r.lvl)){canB=false;rt+=BUILDINGS[r.b].name+' Sv.'+r.lvl+', '}});const costs=info.cost,time=calcTime(info.time,0,v);const ok=canB&&v.resources.wood>=costs[0]&&v.resources.clay>=costs[1]&&v.resources.iron>=costs[2]&&v.resources.crop>=costs[3];h+=`<div class="build-item ${!canB?'disabled':''}"><div class="b-icon">${info.icon}</div><div class="b-info"><div class="b-name">${info.name}</div><div class="b-desc">${info.desc}</div>${!canB?`<div class="req-text">‚ùå ${rt.slice(0,-2)}</div>`:''}<div class="b-costs"><div class="b-cost"><span class="res-dot wood"></span>${fN(costs[0])}</div><div class="b-cost"><span class="res-dot clay"></span>${fN(costs[1])}</div><div class="b-cost"><span class="res-dot iron"></span>${fN(costs[2])}</div><div class="b-cost"><span class="res-dot crop"></span>${fN(costs[3])}</div><div class="b-cost">‚è±Ô∏è${fT(time)}</div></div></div><div>${ok?`<button class="btn btn-green btn-sm" onclick="issueConstruct(${id},'${type}')">ƒ∞n≈üa Et</button>`:'<button class="btn btn-red btn-sm" disabled>‚ùå</button>'}</div></div>`})}
    bd.innerHTML=h
  }
  document.getElementById('gameModal').classList.remove('hidden')
}
function issueUpgrade(id,type,isField,tl){const v=GS.villages[GS.activeVillage],info=BUILDINGS[type],item=isField?v.fields.find(f=>f.id===id):v.buildings.find(b=>b.id===id);const costs=calcCost(info.cost,item.level),time=calcTime(info.time,item.level,v);if(v.resources.wood<costs[0]||v.resources.clay<costs[1]||v.resources.iron<costs[2]||v.resources.crop<costs[3])return;v.resources.wood-=costs[0];v.resources.clay-=costs[1];v.resources.iron-=costs[2];v.resources.crop-=costs[3];v.buildQueue.push({qId:Date.now()+Math.random(),targetId:id,type,name:info.name,isField,timeLeft:time,totalTime:time,targetLevel:tl});closeModal();updateUI()}
function issueConstruct(id,type){const v=GS.villages[GS.activeVillage],info=BUILDINGS[type],costs=info.cost,time=calcTime(info.time,0,v);if(v.resources.wood<costs[0]||v.resources.clay<costs[1]||v.resources.iron<costs[2]||v.resources.crop<costs[3])return;v.resources.wood-=costs[0];v.resources.clay-=costs[1];v.resources.iron-=costs[2];v.resources.crop-=costs[3];const b=v.buildings.find(x=>x.id===id);if(b)b.type=type;v.buildQueue.push({qId:Date.now()+Math.random(),targetId:id,type,name:info.name,isField:false,timeLeft:time,totalTime:time,targetLevel:1});closeModal();renderDorf2();updateUI()}
function openTroopModal(bt){const tt=TROOPS[GS.tribe],v=GS.villages[GS.activeVillage];document.getElementById('modalTitle').textContent=bt==='barracks'?'‚öîÔ∏è Kƒ±≈üla':'üê¥ Ahƒ±r';let h='';Object.entries(tt).forEach(([k,tr])=>{if(bt==='barracks'&&['t4','t5','ram','senator','chief','bey'].includes(k))return;if(bt==='stable'&&['t1','t2','t3'].includes(k))return;h+=`<div class="build-item"><div class="b-icon">${tr.icon}</div><div class="b-info"><div class="b-name">${tr.name}</div><div class="b-desc">Sld:${tr.att} | Sv:${tr.defI}/${tr.defC} | Hƒ±z:${tr.speed} | Ta≈üƒ±ma:${tr.carry}</div><div class="b-costs"><div class="b-cost"><span class="res-dot wood"></span>${tr.cost[0]}</div><div class="b-cost"><span class="res-dot clay"></span>${tr.cost[1]}</div><div class="b-cost"><span class="res-dot iron"></span>${tr.cost[2]}</div><div class="b-cost"><span class="res-dot crop"></span>${tr.cost[3]}</div><div class="b-cost">‚è±Ô∏è${fT(Math.floor(tr.time/SPEED*10))}</div></div></div><div class="flex gap-1 items-center"><input type="number" id="train_${k}" value="1" min="1" max="100" style="width:55px"><button class="btn btn-green btn-sm" onclick="trainTroops('${k}')">Eƒüit</button></div></div>`});document.getElementById('modalBody').innerHTML=h;document.getElementById('gameModal').classList.remove('hidden')}
function trainTroops(k){const v=GS.villages[GS.activeVillage],tr=TROOPS[GS.tribe][k];let c=parseInt(document.getElementById('train_'+k).value)||1;c=Math.min(c,Math.floor(v.resources.wood/tr.cost[0]),Math.floor(v.resources.clay/tr.cost[1]),Math.floor(v.resources.iron/tr.cost[2]),Math.floor(v.resources.crop/tr.cost[3]));if(c<=0){alert('Yetersiz kaynak!');return}v.resources.wood-=tr.cost[0]*c;v.resources.clay-=tr.cost[1]*c;v.resources.iron-=tr.cost[2]*c;v.resources.crop-=tr.cost[3]*c;if(!v.troopQueue)v.troopQueue=[];v.troopQueue.push({type:k,count:c,timeLeft:Math.floor(tr.time*c/SPEED*10),totalTime:Math.floor(tr.time*c/SPEED*10)});closeModal();addInfo(c+'x '+tr.name+' eƒüitimi ba≈üladƒ±!','‚öîÔ∏è');updateUI()}
function openAttackModal(){const t=document.getElementById('modalTitle'),bd=document.getElementById('modalBody');t.textContent='‚öîÔ∏è Saldƒ±rƒ± G√∂nder';const v=GS.villages[GS.activeVillage],tt=TROOPS[GS.tribe];let ti='';Object.entries(v.troops||{}).forEach(([k,c])=>{if(c>0&&tt[k])ti+=`<div class="flex items-center gap-2 mb-1"><span>${tt[k].icon} ${tt[k].name} (${c})</span><input type="number" id="att_${k}" value="0" min="0" max="${c}" style="width:65px"></div>`});if(!ti){bd.innerHTML='<div class="queue-empty">Askerin yok!</div>';document.getElementById('gameModal').classList.remove('hidden');return}bd.innerHTML=`<div class="mb-2"><label class="fs-sm fw-700" style="color:var(--accent)">Hedef:</label><div class="flex gap-2 mt-1"><div>X: <input type="number" id="attX" value="0" style="width:65px"></div><div>Y: <input type="number" id="attY" value="0" style="width:65px"></div></div></div><hr class="divider"><div class="mb-2"><label class="fs-sm fw-700" style="color:var(--accent)">Askerler:</label><div class="mt-1">${ti}</div></div><button class="btn btn-red btn-block" onclick="sendAttack()">‚öîÔ∏è Saldƒ±r!</button>`;document.getElementById('gameModal').classList.remove('hidden')}
function sendAttack(){const v=GS.villages[GS.activeVillage],x=parseInt(document.getElementById('attX').value)||0,y=parseInt(document.getElementById('attY').value)||0;const target=GS.bots.find(b=>b.x===x&&b.y===y);if(!target){alert('K√∂y bulunamadƒ±!');return}const troops={};let any=false;const tt=TROOPS[GS.tribe];Object.entries(v.troops||{}).forEach(([k,c])=>{const sc=parseInt(document.getElementById('att_'+k)?.value)||0;if(sc>0&&sc<=c){troops[k]=sc;v.troops[k]-=sc;any=true}});if(!any){alert('Asker se√ß!');return}const d=Math.sqrt((v.x-x)**2+(v.y-y)**2);let ms=Infinity;Object.entries(troops).forEach(([k])=>{if(tt[k])ms=Math.min(ms,tt[k].speed)});const tt2=Math.max(10,Math.floor(d*100/(ms*SPEED)));GS.troopMovements.push({type:'attack',troops,targetId:target.id,villageId:v.id,fromX:v.x,fromY:v.y,timeLeft:tt2,totalTime:tt2});closeModal();addInfo('Saldƒ±rƒ± g√∂nderildi! Varƒ±≈ü: '+fT(tt2),'‚öîÔ∏è');updateUI()}

// ‚îÄ‚îÄ‚îÄ GOLD ‚îÄ‚îÄ‚îÄ
function goldAction(type){const v=GS.villages[GS.activeVillage];if(type==='finish'){if(!v.buildQueue.length){alert('Kuyruk bo≈ü!');return}if(!useGold(5))return;[...v.buildQueue].forEach(t=>completeConstruction(v,t));v.buildQueue=[];renderDorf1();renderDorf2()}else if(type==='npc'){if(!useGold(3))return;const t=v.resources.wood+v.resources.clay+v.resources.iron+v.resources.crop;const a=t/4;v.resources={wood:Math.min(v.warehouse,a),clay:Math.min(v.warehouse,a),iron:Math.min(v.warehouse,a),crop:Math.min(v.granary,a)}}else if(type==='boost'){if(!useGold(10))return;GS.prodBoostUntil=Date.now()+(24*3600*1000);addInfo('+%25 √ºretim (24s)!','üìà')}updateUI()}
function useGold(a){const qg=parseInt(localStorage.getItem('yds_game_gold'))||0;if(qg>GS.gold)GS.gold=qg;if(GS.gold>=a){GS.gold-=a;localStorage.setItem('yds_game_gold',GS.gold);return true}alert('Yetersiz altƒ±n! ('+GS.gold+') Test √ß√∂zerek kazan.');return false}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function calcCost(base,lvl){return base.map(c=>Math.floor(c*Math.pow(1.28,lvl)))}
function calcTime(base,lvl,v){let t=Math.floor(base*Math.pow(1.2,lvl));const mb=v.buildings.find(b=>b.type==='center');if(mb&&mb.level>1)t=Math.floor(t*(1-mb.level*0.03));return Math.max(5,Math.floor(t/SPEED*10))}
function fT(s){s=Math.max(0,Math.floor(s));const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return h>0?h+':'+String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'):String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0')}
function fN(n){if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e4)return(n/1e3).toFixed(1)+'K';return Math.floor(n).toLocaleString('tr-TR')}
function closeModal(){document.getElementById('gameModal').classList.add('hidden')}
let infoMsgs=[];
function addInfo(msg,icon='‚ÑπÔ∏è'){infoMsgs.unshift({msg,icon,time:Date.now()});if(infoMsgs.length>15)infoMsgs.pop();document.getElementById('infoBox').innerHTML=infoMsgs.map(m=>`<div class="fs-sm mb-1">${m.icon} ${m.msg}</div>`).join('')}
function clearInfo(){infoMsgs=[];document.getElementById('infoBox').innerHTML='<div class="fs-sm" style="color:var(--text-dim)">Temizlendi.</div>'}

// ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT')return;if(e.key==='1')showView('dorf1');if(e.key==='2')showView('dorf2');if(e.key==='3')showView('map');if(e.key==='4')showView('stats');if(e.key==='Escape')closeModal()});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',()=>{const lu=localStorage.getItem('yds_last_user');if(lu)document.getElementById('loginUser').value=lu});
</script>
</body>
</html>
