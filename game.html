<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Wars - Köy Görünümü</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background-color: #e4e4e4; font-family: 'Tahoma', sans-serif; user-select: none; }
        
        /* --- ÜST BAR (KAYNAKLAR) --- */
        .top-bar { background-color: #fff; border-bottom: 3px solid #b8860b; padding: 10px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .res-box { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 1.1rem; margin-right: 15px; }
        .res-box img { width: 24px; height: 24px; }
        .gold-text { color: #d4af37; font-weight: 900; font-size: 1.2rem; display:flex; align-items:center; gap:5px; }

        /* --- HARİTA VE KOORDİNATLAR --- */
        .map-container {
            width: 600px; height: 450px; margin: 0 auto; position: relative;
            background: #8ecb57; /* Çimen yeşili */
            border-radius: 50%; border: 6px solid #5a8f29; box-shadow: inset 0 0 50px rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .map-container.dorf2 { background: #b0d87a; } /* Şehir merkezi biraz daha açık yeşil */
        
        /* Tıklanabilir Yuvarlak Slotlar */
        .slot {
            position: absolute; width: 44px; height: 44px; border-radius: 50%;
            background: #fff; border: 3px solid #333; 
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 1.1rem; cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); transition: 0.1s; z-index: 10;
        }
        .slot:hover { transform: scale(1.15); border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; z-index: 20; }
        
        /* Seviyesi 0 olan boş alanlar */
        .slot.empty { background: rgba(255,255,255,0.4); border-color: #777; color: transparent; }
        .slot.empty:hover { background: #f1c40f; border-color: #000; }
        
        /* Hammadde Renkleri */
        .wood { border-color: #2e7d32; color: #2e7d32; background: #e8f5e9; }
        .clay { border-color: #d84315; color: #d84315; background: #fbe9e7; }
        .iron { border-color: #424242; color: #424242; background: #eeeeee; }
        .crop { border-color: #f57f17; color: #f57f17; background: #fffde7; }
        
        /* Binalar */
        .building { border-color: #1565c0; color: #1565c0; background: #e3f2fd; }
        .main-building { border-color: #6a1b9a; width: 56px; height: 56px; font-size: 1.3rem; }
        .rally-point { border-color: #c62828; border-radius: 10px; } /* Askeri Üs karemsi */

        /* --- MENÜLER VE KUTULAR --- */
        .side-box { background: white; border: 1px solid #c0c0c0; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        .side-box-header { background: linear-gradient(to bottom, #fcfcfc, #e4e4e4); color: #333; padding: 8px; font-weight: bold; text-align: center; border-bottom: 1px solid #c0c0c0; }
        .side-box-content { padding: 10px; font-size: 0.9rem; }
        
        .premium-btn { width: 100%; text-align: left; margin-bottom: 5px; background: linear-gradient(to bottom, #f1c40f, #e67e22); border: 1px solid #b8860b; font-weight: bold; color: #000; }
        .premium-btn:hover { background: linear-gradient(to bottom, #e67e22, #d35400); color: white;}

        .q-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 0.85rem;}
        .q-item.active { color: #d35400; font-weight: bold; background: #fff3e0; padding-left: 5px; border-left: 3px solid #f39c12;}

        .nav-tabs .nav-link { color: #333; font-weight: bold; font-size: 1.1rem; }
        .nav-tabs .nav-link.active { background-color: #34495e; color: white; border-color: #34495e; }

        /* Icon yerine geçici renkli yuvarlaklar (Görsellik için) */
        .res-icon { display: inline-block; width: 16px; height: 16px; border-radius: 50%; border: 1px solid #000; margin-right: 4px; vertical-align: middle;}
        .ico-wood { background: #2e7d32; } .ico-clay { background: #d84315; } .ico-iron { background: #424242; } .ico-crop { background: #f1c40f; }
    </style>
</head>
<body>

<!-- Irk Seçim Modalı -->
<div class="modal fade" id="tribeModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">Irkını Seç!</h5></div>
            <div class="modal-body text-center">
                <p>Oyun <b>10x Hızında</b> akar. YDS Puanların <b>Altın</b> yerine geçer.</p>
                <div class="d-grid gap-3">
                    <button class="btn btn-outline-danger btn-lg" onclick="selectTribe('Turk')"><b>TÜRKLER</b><br><small>Hızlı atlılar, mükemmel yağma.</small></button>
                    <button class="btn btn-outline-primary btn-lg" onclick="selectTribe('Roman')"><b>ROMALILAR</b><br><small>Aynı anda 1 tarla + 1 bina basabilir.</small></button>
                    <button class="btn btn-outline-success btn-lg" onclick="selectTribe('Teuton')"><b>CERMENLER</b><br><small>Ucuz piyadeler, agresif oyun.</small></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- İNŞAAT MODALI -->
<div class="modal fade" id="buildModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="buildModalTitle">İnşaat</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="buildModalBody" style="max-height: 70vh; overflow-y: auto;">
                <!-- JS İçeriği Buraya Gelecek -->
            </div>
        </div>
    </div>
</div>

<!-- ÜST BAR -->
<div class="top-bar sticky-top">
    <div class="container d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex align-items-center flex-wrap">
            <div class="res-box" title="Odun"><span class="res-icon ico-wood"></span> <span id="res-wood">0</span></div>
            <div class="res-box" title="Tuğla"><span class="res-icon ico-clay"></span> <span id="res-clay">0</span></div>
            <div class="res-box" title="Demir"><span class="res-icon ico-iron"></span> <span id="res-iron">0</span></div>
            <div class="res-box" title="Tahıl"><span class="res-icon ico-crop"></span> <span id="res-crop">0</span></div>
        </div>
        <div class="d-flex align-items-center gap-3 mt-2 mt-md-0">
            <div class="gold-text" title="YDS Altını"><i class="bi bi-circle-fill text-warning border border-dark rounded-circle"></i> <span id="gold-amount">0</span></div>
            <button class="btn btn-sm btn-outline-dark fw-bold" onclick="refreshGold()"><i class="bi bi-arrow-clockwise"></i> Altını Çek</button>
        </div>
    </div>
</div>

<div class="container mt-3">
    <div class="row">
        <!-- SOL MENÜ -->
        <div class="col-md-3">
            <div class="side-box">
                <div class="side-box-header">Köy Profili</div>
                <div class="side-box-content text-center">
                    <h5 class="fw-bold text-primary mb-0" id="tribe-name">-</h5>
                    <small class="text-muted">Nüfus: <b id="population">2</b></small>
                </div>
            </div>

            <div class="side-box">
                <div class="side-box-header">Saatlik Üretim (10x)</div>
                <div class="side-box-content fw-bold">
                    <div class="d-flex justify-content-between mb-1"><span><span class="res-icon ico-wood"></span> Odun:</span> <span id="prod-wood">100</span></div>
                    <div class="d-flex justify-content-between mb-1"><span><span class="res-icon ico-clay"></span> Tuğla:</span> <span id="prod-clay">100</span></div>
                    <div class="d-flex justify-content-between mb-1"><span><span class="res-icon ico-iron"></span> Demir:</span> <span id="prod-iron">100</span></div>
                    <div class="d-flex justify-content-between"><span><span class="res-icon ico-crop"></span> Tahıl:</span> <span id="prod-crop">100</span></div>
                </div>
            </div>
            
            <div class="side-box">
                <div class="side-box-header bg-warning text-dark"><i class="bi bi-star-fill"></i> Plus / Altın Kulübü</div>
                <div class="side-box-content p-2">
                    <button class="btn premium-btn" onclick="instantFinish()"><i class="bi bi-lightning-charge"></i> İnşaatları Bitir <span class="badge bg-dark">5</span></button>
                    <button class="btn premium-btn" onclick="npcMerchant()"><i class="bi bi-arrow-left-right"></i> NPC Tüccar <span class="badge bg-dark">3</span></button>
                    <button class="btn premium-btn" onclick="boostProduction()"><i class="bi bi-graph-up-arrow"></i> %25 Üretim (+24s) <span class="badge bg-dark">10</span></button>
                </div>
            </div>
        </div>

        <!-- OYUN ALANI (Ortası) -->
        <div class="col-md-6">
            <ul class="nav nav-tabs" id="gameTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dorf1">Kaynaklar</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#dorf2">Şehir Merkezi</a></li>
                <li class="nav-item"><a class="nav-link text-success" data-bs-toggle="tab" href="#map"><i class="bi bi-map-fill"></i> Harita</a></li>
            </ul>

            <div class="tab-content mt-3">
                <!-- DORF 1 (KAYNAKLAR) -->
                <div class="tab-pane fade show active" id="dorf1">
                    <div class="map-container" id="dorf1-map">
                        <!-- Kaynaklar JS ile basılacak -->
                    </div>
                </div>

                <!-- DORF 2 (ŞEHİR MERKEZİ) -->
                <div class="tab-pane fade" id="dorf2">
                    <div class="map-container dorf2" id="dorf2-map">
                        <!-- Binalar JS ile basılacak -->
                    </div>
                </div>

                <!-- HARİTA -->
                <div class="tab-pane fade" id="map">
                    <div class="card p-5 text-center shadow-sm border-success">
                        <h3 class="text-success"><i class="bi bi-shield-lock-fill"></i> Dünya Haritası</h3>
                        <p class="mt-3"><b>1000 Adet AI Bot</b> ve <b>Savaş Sistemi</b> bir sonraki aşamada buraya eklenecek.</p>
                        <p>Lütfen Dorf1 ve Dorf2'de binaları yükseltmeyi, altınları harcamayı ve Romalı kuyruk sistemini test et.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAĞ MENÜ -->
        <div class="col-md-3 mt-3 mt-md-0">
            <div class="side-box">
                <div class="side-box-header" style="background:#2c3e50; color:white;"><i class="bi bi-hammer"></i> İnşaat Kuyruğu</div>
                <div class="side-box-content" id="build-queue">
                    <div class="text-muted text-center py-3">İnşaat emri yok.</div>
                </div>
            </div>
            
            <div class="side-box">
                <div class="side-box-header bg-danger text-white"><i class="bi bi-shield-sword"></i> Askerler</div>
                <div class="side-box-content text-center py-2">
                    <p class="mb-0 text-muted">Kışla Gereklidir</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* ================= 1. VERİTABANI VE KURALLAR ================= */
    
    // Orijinal Travian Dorf1 (18 Tarla) Koordinatları (Yüzde cinsinden)
    const dorf1Layout =;

    // Orijinal Travian Dorf2 (22 Alan) Koordinatları
    const dorf2Layout =;

    // Binaların Maliyetleri, Süreleri (10x hızlandırılmış) ve Gereksinimleri
    const buildingsInfo = {
        'wood': { name: 'Oduncu', cost:, time: 15, req:[] },
        'clay': { name: 'Tuğla Ocağı', cost:, time: 15, req:[] },
        'iron': { name: 'Demir Madeni', cost:, time: 15, req:[] },
        'crop': { name: 'Tarla', cost:, time: 15, req:[] },
        'center': { name: 'Merkez Bina', desc: 'İnşaat sürelerini kısaltır.', cost:, time: 20, req:[] },
        'warehouse': { name: 'Depo', desc: 'Odun, tuğla ve demir saklar.', cost:, time: 20, req: },
        'granary': { name: 'Tahıl Ambarı', desc: 'Tahıl saklar.', cost:, time: 18, req: },
        'cranny': { name: 'Sığınak', desc: 'Hammaddeleri yağmadan korur.', cost:, time: 10, req:[] },
        'embassy': { name: 'Elçilik', desc: 'İttifak kurmanı sağlar.', cost:, time: 20, req: },
        'rally': { name: 'Askeri Üs', desc: 'Askerlerin toplandığı alan.', cost:, time: 10, req:[] },
        'barracks': { name: 'Kışla', desc: 'Piyade asker eğitilir.', cost:, time: 30, req: },
        'academy': { name: 'Akademi', desc: 'Yeni askerleri araştırır.', cost:, time: 35, req: },
        'blacksmith': { name: 'Zırh Dökümhanesi', desc: 'Askerlerin zırhını geliştirir.', cost:, time: 40, req: },
        'stable': { name: 'Ahır', desc: 'Süvari birlikleri eğitilir.', cost:, time: 45, req: },
        'market': { name: 'Pazar Yeri', desc: 'Hammadde takası sağlar.', cost:, time: 25, req: },
        'wall': { name: 'Sur / Çit', desc: 'Köy savunmasını artırır.', cost:, time: 20, req:[] }
    };

    /* ================= 2. OYUN MOTORU DURUMU ================= */
    let gameState = JSON.parse(localStorage.getItem('yds_game_state')) || null;
    let ydsGold = parseInt(localStorage.getItem('yds_game_gold')) || 0;
    let gameLoop;
    let selectedSlotId = null;

    window.onload = function() {
        refreshGold();
        if (!gameState) {
            new bootstrap.Modal(document.getElementById('tribeModal')).show();
        } else {
            initGame();
        }
    };

    function selectTribe(tribe) {
        gameState = {
            tribe: tribe,
            population: 2,
            resources: { wood: 1000, clay: 1000, iron: 1000, crop: 1000 },
            prodBoostUntil: 0,
            fields: dorf1Layout.map(f => ({ id: f.id, type: f.type, level: 0 })),
            buildings: dorf2Layout.map(b => ({ id: b.id, type: b.isMain ? 'center' : (b.isRally ? 'empty' : (b.isWall ? 'empty' : 'empty')), level: b.isMain ? 1 : 0 })),
            buildQueue:[],
            lastUpdate: Date.now()
        };
        saveState();
        bootstrap.Modal.getInstance(document.getElementById('tribeModal')).hide();
        initGame();
    }

    function initGame() {
        let tName = "Romalılar"; if(gameState.tribe==='Turk') tName="Türkler"; if(gameState.tribe==='Teuton') tName="Cermenler";
        document.getElementById('tribe-name').innerText = tName;
        
        // Çevrimdışı Üretimi Ekle
        let now = Date.now();
        let diffSec = Math.floor((now - gameState.lastUpdate) / 1000);
        if(diffSec > 0) calculateOfflineProduction(diffSec);
        
        drawMaps();
        gameLoop = setInterval(updateEngine, 1000); // Saniyede 1 tık
    }

    /* ================= 3. ÇİZİM (HARİTAYI OLUŞTURMA) ================= */
    function drawMaps() {
        const map1 = document.getElementById('dorf1-map');
        const map2 = document.getElementById('dorf2-map');
        map1.innerHTML = ''; map2.innerHTML = '';

        // Dorf1 (Kaynaklar)
        gameState.fields.forEach(f => {
            let layout = dorf1Layout.find(l => l.id === f.id);
            let cls = f.level > 0 ? f.type : 'empty';
            let label = f.level > 0 ? f.level : '';
            map1.innerHTML += `<div class="slot ${cls}" style="left:calc(${layout.x}% - 22px); top:calc(${layout.y}% - 22px);" onclick="openBuildModal(${f.id}, 'field')">${label}</div>`;
        });

        // Dorf2 (Binalar)
        gameState.buildings.forEach(b => {
            let layout = dorf2Layout.find(l => l.id === b.id);
            let cls = b.level > 0 ? 'building' : 'empty';
            if (b.type === 'center') cls += ' main-building';
            if (layout.isRally && b.level > 0) cls += ' rally-point';
            
            let label = b.level > 0 ? b.level : '';
            map2.innerHTML += `<div class="slot ${cls}" style="left:calc(${layout.x}% - 22px); top:calc(${layout.y}% - 22px);" onclick="openBuildModal(${b.id}, 'building')">${label}</div>`;
        });
    }

    /* ================= 4. İNŞAAT MODALI ================= */
    function openBuildModal(id, mapType) {
        selectedSlotId = id;
        const modalBody = document.getElementById('buildModalBody');
        let item = mapType === 'field' ? gameState.fields.find(f => f.id === id) : gameState.buildings.find(b => b.id === id);
        
        // Eğer slot doluysa (Seviye Yükseltme Ekranı)
        if (item.type !== 'empty') {
            let info = buildingsInfo;
            let nextLvl = item.level + 1;
            
            // Fiyat artış formülü: Base * (1.28 ^ level)
            let cw = Math.floor(info.cost * Math.pow(1.28, item.level));
            let cc = Math.floor(info.cost * Math.pow(1.28, item.level));
            let ci = Math.floor(info.cost * Math.pow(1.28, item.level));
            let cr = Math.floor(info.cost * Math.pow(1.28, item.level));
            let time = Math.floor(info.time * Math.pow(1.1, item.level)); // Süre artışı

            modalBody.innerHTML = `
                <div class="mb-3 border-bottom pb-2">
                    <h4 class="text-primary fw-bold">${info.name} <span class="badge bg-secondary fs-6">Seviye ${item.level}</span></h4>
                    <small class="text-muted">${info.desc || 'Köyünün ekonomisini güçlendirir.'}</small>
                </div>
                <h6 class="fw-bold">Geliştirme Masrafları (Seviye ${nextLvl}):</h6>
                <div class="d-flex justify-content-between bg-light p-2 rounded mb-3 border font-monospace">
                    <span><span class="res-icon ico-wood"></span> ${cw}</span>
                    <span><span class="res-icon ico-clay"></span> ${cc}</span>
                    <span><span class="res-icon ico-iron"></span> ${ci}</span>
                    <span><span class="res-icon ico-crop"></span> ${cr}</span>
                    <span><i class="bi bi-clock"></i> ${formatTime(time)}</span>
                </div>
                <div class="text-center">
                    <button class="btn btn-success fw-bold px-4" onclick="issueCommand(${id}, '${item.type}', ${cw}, ${cc}, ${ci}, ${cr}, ${time})">
                        Seviye ${nextLvl} Olarak Geliştir
                    </button>
                </div>
            `;
        } 
        // Eğer slot boşsa (Yeni Bina Listesi)
        else {
            let html = '<h5 class="mb-3 fw-bold">Yeni Bina İnşa Et</h5><div class="list-group">';
            
            // Sur sadece dışarıya (40), Askeri Üs sadece (39) numaraya
            let layout = dorf2Layout.find(l => l.id === id);
            
            for (const of Object.entries(buildingsInfo)) {
                // Sadece binaları göster (tarlaları değil)
                if (.includes(type)) continue;
                
                // Özel Alan Kontrolleri
                if (layout.isWall && type !== 'wall') continue;
                if (!layout.isWall && type === 'wall') continue;
                if (layout.isRally && type !== 'rally') continue;
                if (!layout.isRally && type === 'rally') continue;

                // Gereksinim Kontrolü (Örn: Kışla için Merkez 3 lazımsa)
                let canBuild = true;
                let reqText = "";
                info.req.forEach(r => {
                    // Köydeki binalarda bu req var mı?
                    let found = gameState.buildings.find(b => b.type === r.b && b.level >= r.lvl);
                    if (!found) {
                        canBuild = false;
                        reqText += `${buildingsInfo.name} Seviye ${r.lvl}, `;
                    }
                });

                if (canBuild) {
                    html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-primary fw-bold">${info.name}</h6>
                            <small class="text-muted d-block">${info.desc}</small>
                            <div class="mt-1 small font-monospace d-flex gap-3">
                                <span><span class="res-icon ico-wood"></span> ${info.cost}</span>
                                <span><span class="res-icon ico-clay"></span> ${info.cost}</span>
                                <span><span class="res-icon ico-iron"></span> ${info.cost}</span>
                                <span><span class="res-icon ico-crop"></span> ${info.cost}</span>
                                <span><i class="bi bi-clock"></i> ${formatTime(info.time)}</span>
                            </div>
                        </div>
                        <button class="btn btn-outline-success btn-sm" onclick="issueCommand(${id}, '${type}', ${info.cost}, ${info.cost}, ${info.cost}, ${info.cost}, ${info.time})">İnşa Et</button>
                    </div>`;
                } else {
                    html += `
                    <div class="list-group-item bg-light text-muted">
                        <h6 class="mb-1 fw-bold">${info.name}</h6>
                        <small class="text-danger"><i class="bi bi-x-circle"></i> Gereksinim: ${reqText.slice(0, -2)}</small>
                    </div>`;
                }
            }
            html += '</div>';
            modalBody.innerHTML = html;
        }

        new bootstrap.Modal(document.getElementById('buildModal')).show();
    }

    /* ================= 5. EMİR VERME ================= */
    function issueCommand(id, type, cw, cc, ci, cr, time) {
        if (gameState.resources.wood < cw || gameState.resources.clay < cc || gameState.resources.iron < ci || gameState.resources.crop < cr) {
            alert("Yeterli hammeddeniz yok!"); return;
        }

        // Hammaddeyi Düş
        gameState.resources.wood -= cw;
        gameState.resources.clay -= cc;
        gameState.resources.iron -= ci;
        gameState.resources.crop -= cr;

        let isField =.includes(type);
        
        // Kuyruğa Ekle
        gameState.buildQueue.push({
            qId: Date.now(),
            targetId: id,
            type: type,
            name: buildingsInfo.name,
            isField: isField,
            timeLeft: time,
            totalTime: time
        });

        bootstrap.Modal.getInstance(document.getElementById('buildModal')).hide();
        updateUI();
    }

    /* ================= 6. ANA OYUN DÖNGÜSÜ (HER SANİYE) ================= */
    function updateEngine() {
        let now = Date.now();
        
        // --- 1. Üretim Hesaplama (10x Server Base = 1000/saat) ---
        let boost = (gameState.prodBoostUntil > now) ? 1.25 : 1;
        let pWood = 1000, pClay = 1000, pIron = 1000, pCrop = 1000;
        
        // Tarlaların seviyelerine göre üretimi artır (Seviye başı +250)
        gameState.fields.forEach(f => {
            if(f.level > 0) {
                if(f.type === 'wood') pWood += (f.level * 250);
                if(f.type === 'clay') pClay += (f.level * 250);
                if(f.type === 'iron') pIron += (f.level * 250);
                if(f.type === 'crop') pCrop += (f.level * 250);
            }
        });

        // Saniyede ekle (Saatlik üretim / 3600)
        gameState.resources.wood += (pWood * boost) / 3600;
        gameState.resources.clay += (pClay * boost) / 3600;
        gameState.resources.iron += (pIron * boost) / 3600;
        gameState.resources.crop += (pCrop * boost) / 3600;

        // Ekrana yansıt
        document.getElementById('prod-wood').innerText = Math.floor(pWood * boost);
        document.getElementById('prod-clay').innerText = Math.floor(pClay * boost);
        document.getElementById('prod-iron').innerText = Math.floor(pIron * boost);
        document.getElementById('prod-crop').innerText = Math.floor(pCrop * boost);

        // --- 2. İnşaat Kuyruğunu İşleme (ROMALI MANTIĞI) ---
        if (gameState.buildQueue.length > 0) {
            let activeTasks =[];
            
            if (gameState.tribe === 'Roman') {
                // Romalı: Kuyruktaki İlk Tarlayı ve İlk Binayı AYNI ANDA yapar
                let fTask = gameState.buildQueue.find(t => t.isField);
                let bTask = gameState.buildQueue.find(t => !t.isField);
                if (fTask) activeTasks.push(fTask);
                if (bTask) activeTasks.push(bTask);
            } else {
                // Diğerleri: Sadece en üsttekini yapar
                activeTasks.push(gameState.buildQueue);
            }

            activeTasks.forEach(task => {
                task.timeLeft--;
                if (task.timeLeft <= 0) completeTask(task);
            });
        }

        gameState.lastUpdate = now;
        saveState();
        updateUI();
    }

    function completeTask(task) {
        if (task.isField) {
            let f = gameState.fields.find(x => x.id === task.targetId);
            f.level++;
        } else {
            let b = gameState.buildings.find(x => x.id === task.targetId);
            b.type = task.type; // Boşsa tipini değiştir
            b.level++;
        }
        gameState.population += Math.floor(Math.random() * 3) + 1; // Nüfus artar
        gameState.buildQueue = gameState.buildQueue.filter(t => t.qId !== task.qId);
        drawMaps(); // Haritayı yeniden çiz ki şekiller güncellensin
    }

    function calculateOfflineProduction(seconds) {
        let pWood = 1000, pClay = 1000, pIron = 1000, pCrop = 1000;
        gameState.fields.forEach(f => {
            if(f.level > 0) {
                if(f.type==='wood') pWood += (f.level*250);
                if(f.type==='clay') pClay += (f.level*250);
                if(f.type==='iron') pIron += (f.level*250);
                if(f.type==='crop') pCrop += (f.level*250);
            }
        });
        gameState.resources.wood += (pWood / 3600) * seconds;
        gameState.resources.clay += (pClay / 3600) * seconds;
        gameState.resources.iron += (pIron / 3600) * seconds;
        gameState.resources.crop += (pCrop / 3600) * seconds;
    }

    /* ================= 7. ARAYÜZ (UI) GÜNCELLEMESİ ================= */
    function updateUI() {
        document.getElementById('res-wood').innerText = Math.floor(gameState.resources.wood);
        document.getElementById('res-clay').innerText = Math.floor(gameState.resources.clay);
        document.getElementById('res-iron').innerText = Math.floor(gameState.resources.iron);
        document.getElementById('res-crop').innerText = Math.floor(gameState.resources.crop);
        document.getElementById('population').innerText = gameState.population;

        // Kuyruk Alanı
        const qBox = document.getElementById('build-queue');
        if (gameState.buildQueue.length === 0) {
            qBox.innerHTML = '<div class="text-muted text-center py-3">İnşaat emri yok.</div>';
        } else {
            let html = "";
            gameState.buildQueue.forEach((t, i) => {
                let isActive = false;
                if (gameState.tribe === 'Roman') {
                    if (t === gameState.buildQueue.find(x => x.isField) || t === gameState.buildQueue.find(x => !x.isField)) isActive = true;
                } else {
                    if (i === 0) isActive = true;
                }
                
                let targetItem = t.isField ? gameState.fields.find(f => f.id === t.targetId) : gameState.buildings.find(b => b.id === t.targetId);
                let targetLvl = targetItem.level + 1;

                html += `<div class="q-item ${isActive ? 'active' : ''}">
                            <span>${t.name} (Seviye ${targetLvl})</span>
                            <span>${isActive ? formatTime(t.timeLeft) : '<i class="bi bi-pause-circle"></i>'}</span>
                         </div>`;
            });
            qBox.innerHTML = html;
        }
    }

    function formatTime(sec) {
        let h = Math.floor(sec / 3600);
        let m = Math.floor((sec % 3600) / 60);
        let s = sec % 60;
        if(h > 0) return `${h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
    }

    /* ================= 8. ALTIN (YDS) KULLANIMI ================= */
    function refreshGold() {
        ydsGold = parseInt(localStorage.getItem('yds_game_gold')) || 0;
        document.getElementById('gold-amount').innerText = ydsGold;
    }

    function useGold(amount) {
        refreshGold();
        if (ydsGold >= amount) {
            ydsGold -= amount;
            localStorage.setItem('yds_game_gold', ydsGold);
            document.getElementById('gold-amount').innerText = ydsGold;
            return true;
        }
        alert("Yeterli YDS Altının yok! Test çözerek altın kazanmalısın.");
        return false;
    }

    function instantFinish() {
        if(gameState.buildQueue.length === 0) { alert("Kuyruk zaten boş!"); return; }
        if(useGold(5)) {
            // Referans hatası yaşamamak için kuyruğu kopyala ve tek tek bitir
            let tasks =; 
            tasks.forEach(t => completeTask(t));
        }
    }

    function npcMerchant() {
        if(useGold(3)) {
            let total = gameState.resources.wood + gameState.resources.clay + gameState.resources.iron + gameState.resources.crop;
            let avg = total / 4;
            gameState.resources = { wood: avg, clay: avg, iron: avg, crop: avg };
            updateUI();
        }
    }

    function boostProduction() {
        if(useGold(10)) {
            gameState.prodBoostUntil = Date.now() + (24 * 3600 * 1000); // 24 Saat
            alert("Üretimler %25 arttırıldı! (24 Saat)");
        }
    }

    function saveState() {
        localStorage.setItem('yds_game_state', JSON.stringify(gameState));
    }
</script>
</body>
</html>
