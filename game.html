<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YDS Wars - Travian TarzÄ± Strateji Oyunu</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=MedievalSharp&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YDS WARS - COMPLETE TRAVIAN-STYLE STRATEGY GAME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --wood:#4a7c29; --clay:#c45a1a; --iron:#5a5a5a; --crop:#d4a017;
  --bg-dark:#1a1208; --bg-medium:#2d2011; --bg-light:#3d2e1a;
  --gold:#ffd700; --silver:#c0c0c0; --text:#f0e6d2; --text-dim:#a89878;
  --border:#6b5530; --accent:#c8a050; --danger:#c0392b; --success:#27ae60;
  --panel-bg:linear-gradient(180deg,#3a2a18 0%,#2a1c10 100%);
  --btn-green:linear-gradient(180deg,#5a9e2f 0%,#3d7a1a 100%);
  --btn-gold:linear-gradient(180deg,#e8b830 0%,#c49020 100%);
  --btn-red:linear-gradient(180deg,#c0392b 0%,#962d22 100%);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#0d0a05;color:var(--text);font-family:'Nunito',sans-serif;overflow-x:hidden;min-height:100vh;}
::-webkit-scrollbar{width:8px;} ::-webkit-scrollbar-track{background:#1a1208;} ::-webkit-scrollbar-thumb{background:#6b5530;border-radius:4px;}
.hidden{display:none!important;}
button{cursor:pointer;font-family:inherit;}
h1,h2,h3,h4{font-family:'Cinzel',serif;color:var(--accent);}

/* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€ */
#loginScreen{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0a0705 0%,#1a1208 50%,#0d0a05 100%);}
#loginScreen::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c8a050' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;}
.login-box{position:relative;z-index:1;background:var(--panel-bg);border:2px solid var(--border);border-radius:12px;padding:40px;width:420px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,0.8);}
.login-box h1{text-align:center;font-size:2.2rem;margin-bottom:6px;color:var(--gold);text-shadow:0 2px 10px rgba(255,215,0,0.3);}
.login-box .subtitle{text-align:center;color:var(--text-dim);margin-bottom:24px;font-size:0.9rem;}
.login-box .emblem{text-align:center;font-size:3.5rem;margin-bottom:10px;}
.form-group{margin-bottom:16px;}
.form-group label{display:block;font-weight:700;margin-bottom:4px;color:var(--accent);font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;}
.form-group input{width:100%;padding:10px 14px;background:#1a1208;border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:1rem;outline:none;transition:border-color .2s;}
.form-group input:focus{border-color:var(--gold);}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 20px;border:1px solid rgba(0,0,0,0.3);border-radius:6px;font-weight:700;font-size:0.95rem;transition:all .15s;text-shadow:0 1px 2px rgba(0,0,0,0.5);}
.btn-green{background:var(--btn-green);color:#fff;border-bottom:2px solid #2d6010;}
.btn-green:hover{filter:brightness(1.15);transform:translateY(-1px);}
.btn-gold{background:var(--btn-gold);color:#1a1208;border-bottom:2px solid #9a7010;}
.btn-gold:hover{filter:brightness(1.15);}
.btn-red{background:var(--btn-red);color:#fff;border-bottom:2px solid #7a2018;}
.btn-sm{padding:6px 12px;font-size:0.8rem;}
.btn-block{width:100%;justify-content:center;}
.login-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border);}
.login-tabs button{flex:1;padding:10px;background:transparent;border:none;color:var(--text-dim);font-weight:700;font-size:0.95rem;transition:.2s;}
.login-tabs button.active{color:var(--gold);border-bottom:2px solid var(--gold);margin-bottom:-2px;}
.login-error{background:rgba(192,57,43,0.2);border:1px solid var(--danger);padding:8px 12px;border-radius:6px;color:#e74c3c;font-size:0.85rem;margin-bottom:12px;display:none;}

/* â”€â”€â”€ TRIBE SELECTION â”€â”€â”€ */
#tribeScreen{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;flex-direction:column;
  background:linear-gradient(135deg,#0a0705,#1a1208,#0d0a05);}
.tribe-title{font-family:'Cinzel',serif;font-size:2.5rem;color:var(--gold);text-shadow:0 2px 20px rgba(255,215,0,0.3);margin-bottom:8px;}
.tribe-subtitle{color:var(--text-dim);margin-bottom:30px;font-size:1rem;}
.tribe-cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:900px;}
.tribe-card{width:260px;background:var(--panel-bg);border:2px solid var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;}
.tribe-card:hover{border-color:var(--gold);transform:translateY(-6px);box-shadow:0 12px 40px rgba(255,215,0,0.15);}
.tribe-card .tribe-icon{font-size:4rem;margin-bottom:10px;display:block;}
.tribe-card h3{font-size:1.4rem;margin-bottom:8px;}
.tribe-card p{font-size:0.85rem;color:var(--text-dim);line-height:1.5;}
.tribe-card .tribe-bonus{margin-top:12px;padding:8px;background:rgba(200,160,80,0.1);border:1px solid rgba(200,160,80,0.2);border-radius:6px;font-size:0.8rem;color:var(--accent);}
.tribe-card.roman:hover{border-color:#e74c3c;} .tribe-card.roman h3{color:#e74c3c;}
.tribe-card.teuton:hover{border-color:#27ae60;} .tribe-card.teuton h3{color:#27ae60;}
.tribe-card.turk:hover{border-color:#3498db;} .tribe-card.turk h3{color:#3498db;}

/* â”€â”€â”€ MAIN GAME LAYOUT â”€â”€â”€ */
#gameScreen{display:none;min-height:100vh;}
.top-bar{background:linear-gradient(180deg,#2d2011 0%,#1a1208 100%);border-bottom:2px solid var(--border);padding:0;position:sticky;top:0;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,0.5);}
.top-bar-inner{display:flex;align-items:center;max-width:1300px;margin:0 auto;padding:0 10px;}
.nav-icons{display:flex;gap:0;}
.nav-icon{width:52px;height:48px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:var(--text-dim);cursor:pointer;transition:.15s;border-bottom:3px solid transparent;position:relative;}
.nav-icon:hover,.nav-icon.active{color:var(--gold);background:rgba(200,160,80,0.1);border-bottom-color:var(--gold);}
.nav-icon .badge{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;font-size:0.6rem;padding:1px 4px;border-radius:8px;font-weight:700;}
.res-bar{display:flex;align-items:center;gap:2px;flex:1;justify-content:center;flex-wrap:wrap;}
.res-item{display:flex;align-items:center;gap:4px;padding:4px 8px;border-radius:4px;font-size:0.85rem;font-weight:700;min-width:90px;}
.res-dot{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,0.3);flex-shrink:0;}
.res-dot.wood{background:var(--wood);} .res-dot.clay{background:var(--clay);} .res-dot.iron{background:var(--iron);} .res-dot.crop{background:var(--crop);}
.res-val{color:var(--text);}
.res-cap{color:var(--text-dim);font-size:0.7rem;font-weight:400;}
.gold-display{display:flex;align-items:center;gap:6px;padding:4px 12px;color:var(--gold);font-weight:800;font-size:1rem;}
.gold-icon{font-size:1.2rem;}

/* â”€â”€â”€ GAME CONTENT AREA â”€â”€â”€ */
.game-body{display:flex;max-width:1300px;margin:0 auto;min-height:calc(100vh - 50px);}
.sidebar-left{width:220px;flex-shrink:0;padding:10px;display:flex;flex-direction:column;gap:10px;}
.sidebar-right{width:240px;flex-shrink:0;padding:10px;display:flex;flex-direction:column;gap:10px;}
.main-content{flex:1;padding:10px;min-width:0;}

.panel{background:var(--panel-bg);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.panel-header{background:linear-gradient(180deg,#4a3620 0%,#3a2810 100%);padding:8px 12px;font-family:'Cinzel',serif;font-size:0.85rem;color:var(--accent);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;}
.panel-body{padding:10px;}

/* â”€â”€â”€ DORF1 - RESOURCE VIEW â”€â”€â”€ */
.village-view{position:relative;width:100%;padding-top:75%;background:radial-gradient(ellipse at center,#6aaa35 0%,#4a8a20 40%,#3a7015 70%,#2a5510 100%);border-radius:50%;border:4px solid #2a5510;box-shadow:inset 0 0 60px rgba(0,0,0,0.3),0 8px 30px rgba(0,0,0,0.5);overflow:visible;}
.village-view.dorf2{background:radial-gradient(ellipse at center,#80b840 0%,#60a030 40%,#4a8020 70%,#3a6818 100%);}
.village-slot{position:absolute;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:0.95rem;cursor:pointer;transition:all .15s;z-index:10;box-shadow:2px 3px 8px rgba(0,0,0,0.4);border:2px solid;}
.village-slot:hover{transform:scale(1.2);z-index:20;box-shadow:0 0 15px rgba(255,215,0,0.5);}
.village-slot.empty{background:rgba(255,255,255,0.25);border-color:rgba(255,255,255,0.4);color:transparent;}
.village-slot.empty:hover{background:rgba(255,215,0,0.3);border-color:var(--gold);}
.village-slot.s-wood{background:#e8f5e9;border-color:#2e7d32;color:#2e7d32;}
.village-slot.s-clay{background:#fbe9e7;border-color:#d84315;color:#d84315;}
.village-slot.s-iron{background:#eeeeee;border-color:#424242;color:#424242;}
.village-slot.s-crop{background:#fffde7;border-color:#f57f17;color:#f57f17;}
.village-slot.s-building{background:#e3f2fd;border-color:#1565c0;color:#1565c0;}
.village-slot.s-main{background:#f3e5f5;border-color:#6a1b9a;color:#6a1b9a;width:54px;height:54px;font-size:1.1rem;}
.village-slot.s-rally{background:#ffebee;border-color:#c62828;color:#c62828;border-radius:8px;}
.village-slot.s-wall{background:#fce4ec;border-color:#880e4f;color:#880e4f;border-radius:4px;width:120px;height:30px;font-size:0.75rem;}
.village-center-img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;z-index:5;pointer-events:none;filter:drop-shadow(2px 4px 6px rgba(0,0,0,0.4));}
/* River decorations */
.village-view::before{content:'';position:absolute;top:10%;left:-5%;width:110%;height:6px;background:linear-gradient(90deg,transparent,#4a90d9,#5aa0e9,#4a90d9,transparent);border-radius:50%;opacity:0.4;transform:rotate(-15deg);z-index:2;}
.village-view::after{content:'';position:absolute;bottom:15%;left:-5%;width:110%;height:5px;background:linear-gradient(90deg,transparent,#4a90d9,#5aa0e9,transparent);border-radius:50%;opacity:0.3;transform:rotate(10deg);z-index:2;}

/* â”€â”€â”€ WORLD MAP â”€â”€â”€ */
.map-container{position:relative;width:100%;height:calc(100vh - 100px);overflow:hidden;background:#5a8a25;border:2px solid var(--border);border-radius:8px;}
.map-grid{position:absolute;cursor:grab;}
.map-grid:active{cursor:grabbing;}
.map-cell{position:absolute;width:40px;height:40px;border:1px solid rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:center;font-size:0.5rem;transition:background .1s;}
.map-cell.has-village{cursor:pointer;}
.map-cell.has-village:hover{z-index:10;box-shadow:0 0 10px rgba(255,215,0,0.5);}
.map-village{width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;border:2px solid;box-shadow:1px 2px 4px rgba(0,0,0,0.3);}
.map-village.player{background:#ffd700;border-color:#c49020;animation:pulse 2s infinite;}
.map-village.bot-roman{background:#e8c0c0;border-color:#c0392b;}
.map-village.bot-teuton{background:#c0e8c0;border-color:#27ae60;}
.map-village.bot-turk{background:#c0d0e8;border-color:#2980b9;}
.map-village.natar{background:#888;border-color:#555;}
@keyframes pulse{0%,100%{box-shadow:0 0 5px rgba(255,215,0,0.3);}50%{box-shadow:0 0 15px rgba(255,215,0,0.6);}}
.map-tooltip{position:absolute;background:var(--bg-dark);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-size:0.8rem;pointer-events:none;z-index:100;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.map-coords{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:6px 16px;border-radius:20px;font-size:0.8rem;z-index:50;display:flex;gap:12px;}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px);}
.modal-box{background:var(--bg-dark);border:2px solid var(--border);border-radius:12px;width:600px;max-width:95vw;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.8);animation:modalIn .2s ease-out;}
@keyframes modalIn{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
.modal-header{background:linear-gradient(180deg,#4a3620,#3a2810);padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.modal-header h3{margin:0;font-size:1.1rem;}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:1.4rem;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.15s;}
.modal-close:hover{background:rgba(255,255,255,0.1);color:var(--text);}
.modal-body{padding:16px;overflow-y:auto;max-height:calc(85vh - 60px);}

/* â”€â”€â”€ BUILD LIST â”€â”€â”€ */
.build-item{display:flex;align-items:center;gap:12px;padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);transition:.15s;}
.build-item:hover{background:rgba(200,160,80,0.05);border-color:var(--accent);}
.build-item .b-icon{width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;}
.build-item .b-info{flex:1;min-width:0;}
.build-item .b-name{font-weight:700;color:var(--accent);font-size:0.95rem;}
.build-item .b-desc{font-size:0.78rem;color:var(--text-dim);margin-top:2px;}
.build-item .b-costs{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;}
.build-item .b-cost{display:flex;align-items:center;gap:3px;font-size:0.78rem;font-weight:600;}
.build-item .b-cost.insufficient{color:#e74c3c;}
.build-item .b-action{flex-shrink:0;}
.build-item.disabled{opacity:0.5;}
.build-item .req-text{font-size:0.75rem;color:#e74c3c;margin-top:4px;}

/* â”€â”€â”€ BUILD QUEUE â”€â”€â”€ */
.queue-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.85rem;}
.queue-item.active{background:rgba(200,160,80,0.1);border-left:3px solid var(--gold);}
.queue-item .q-name{font-weight:600;}
.queue-item .q-time{color:var(--gold);font-weight:700;font-variant-numeric:tabular-nums;}
.queue-empty{text-align:center;padding:20px;color:var(--text-dim);font-size:0.85rem;}

/* â”€â”€â”€ PRODUCTION DISPLAY â”€â”€â”€ */
.prod-row{display:flex;justify-content:space-between;padding:4px 0;font-size:0.85rem;font-weight:600;}
.prod-row .prod-label{display:flex;align-items:center;gap:4px;}

/* â”€â”€â”€ TROOP LIST â”€â”€â”€ */
.troop-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.troop-icon{font-size:1.2rem;}
.troop-info{flex:1;}
.troop-name{font-weight:700;font-size:0.85rem;}
.troop-stats{font-size:0.72rem;color:var(--text-dim);}
.troop-count{font-weight:800;font-size:1.1rem;color:var(--gold);min-width:40px;text-align:right;}

/* â”€â”€â”€ ALLIANCE â”€â”€â”€ */
.alliance-member{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.85rem;}

/* â”€â”€â”€ STATS TABLE â”€â”€â”€ */
.stats-table{width:100%;border-collapse:collapse;font-size:0.85rem;}
.stats-table th{background:rgba(200,160,80,0.1);padding:8px;text-align:left;border-bottom:1px solid var(--border);color:var(--accent);font-size:0.8rem;}
.stats-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.05);}
.stats-table tr:hover{background:rgba(255,255,255,0.02);}

/* â”€â”€â”€ REPORTS â”€â”€â”€ */
.report-item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:.1s;font-size:0.85rem;}
.report-item:hover{background:rgba(200,160,80,0.05);}
.report-item .r-result{font-weight:700;}
.report-item .r-result.win{color:var(--success);}.report-item .r-result.loss{color:var(--danger);}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tab-bar{display:flex;border-bottom:2px solid var(--border);margin-bottom:10px;}
.tab-btn{padding:8px 16px;background:transparent;border:none;color:var(--text-dim);font-weight:700;font-size:0.9rem;border-bottom:3px solid transparent;margin-bottom:-2px;transition:.15s;}
.tab-btn:hover{color:var(--text);}
.tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);}

/* â”€â”€â”€ MISC â”€â”€â”€ */
.server-time{font-size:0.75rem;color:var(--text-dim);padding:4px 10px;white-space:nowrap;}
.speed-badge{background:var(--danger);color:#fff;padding:1px 6px;border-radius:10px;font-size:0.65rem;font-weight:800;}
.divider{border:none;border-top:1px solid var(--border);margin:10px 0;}
.text-gold{color:var(--gold);} .text-green{color:var(--success);} .text-red{color:var(--danger);}
.text-center{text-align:center;} .text-right{text-align:right;}
.mt-1{margin-top:4px;} .mt-2{margin-top:8px;} .mt-3{margin-top:16px;}
.mb-1{margin-bottom:4px;} .mb-2{margin-bottom:8px;}
.flex{display:flex;} .gap-1{gap:4px;} .gap-2{gap:8px;} .gap-3{gap:16px;}
.flex-1{flex:1;} .items-center{align-items:center;} .justify-between{justify-content:space-between;}
.fw-700{font-weight:700;} .fs-sm{font-size:0.8rem;}
select{background:var(--bg-dark);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:0.85rem;}
input[type="number"]{background:var(--bg-dark);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:0.85rem;width:80px;}

@media(max-width:900px){
  .sidebar-left,.sidebar-right{display:none;}
  .game-body{flex-direction:column;}
  .res-bar{gap:0;}
  .res-item{min-width:70px;font-size:0.75rem;padding:2px 4px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="login-box">
    <div class="emblem">âš”ï¸</div>
    <h1>YDS Wars</h1>
    <p class="subtitle">Travian TarzÄ± Strateji Oyunu â€¢ 10x HÄ±z</p>
    <div class="login-tabs">
      <button class="active" onclick="showLoginTab('login')">GiriÅŸ Yap</button>
      <button onclick="showLoginTab('register')">KayÄ±t Ol</button>
    </div>
    <div id="loginError" class="login-error"></div>
    <div id="loginForm">
      <div class="form-group">
        <label>KullanÄ±cÄ± AdÄ±</label>
        <input type="text" id="loginUser" placeholder="AdÄ±nÄ± yaz...">
      </div>
      <div class="form-group">
        <label>Åifre</label>
        <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-green btn-block" onclick="doLogin()">âš”ï¸ SavaÅŸa Gir</button>
    </div>
    <div id="registerForm" class="hidden">
      <div class="form-group">
        <label>KullanÄ±cÄ± AdÄ±</label>
        <input type="text" id="regUser" placeholder="Benzersiz isim seÃ§...">
      </div>
      <div class="form-group">
        <label>Åifre</label>
        <input type="password" id="regPass" placeholder="En az 4 karakter">
      </div>
      <div class="form-group">
        <label>Åifre (Tekrar)</label>
        <input type="password" id="regPass2" placeholder="Åifreyi tekrarla">
      </div>
      <button class="btn btn-gold btn-block" onclick="doRegister()">ğŸ“œ Hesap OluÅŸtur</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRIBE SELECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tribeScreen" class="hidden">
  <h1 class="tribe-title">âš”ï¸ Kabileni SeÃ§</h1>
  <p class="tribe-subtitle">Bu karar geri alÄ±namaz! Kabilene uygun strateji belirle.</p>
  <div class="tribe-cards">
    <div class="tribe-card roman" onclick="selectTribe('Roman')">
      <span class="tribe-icon">ğŸ›ï¸</span>
      <h3>RomalÄ±lar</h3>
      <p>Dengeli gÃ¼Ã§. Ä°yi saldÄ±rÄ±, iyi savunma. PahalÄ± ama gÃ¼Ã§lÃ¼ birimler.</p>
      <div class="tribe-bonus">âœ¦ Kaynak + Bina aynÄ± anda inÅŸa<br>âœ¦ GÃ¼Ã§lÃ¼ surlar (+%100 savunma)<br>âœ¦ Kahraman +100 gÃ¼Ã§/puan</div>
    </div>
    <div class="tribe-card teuton" onclick="selectTribe('Teuton')">
      <span class="tribe-icon">ğŸª“</span>
      <h3>Cermenler</h3>
      <p>Agresif oyun. Ucuz ve hÄ±zlÄ± askerler. YaÄŸma uzmanÄ±.</p>
      <div class="tribe-bonus">âœ¦ Ucuz piyadeler, hÄ±zlÄ± eÄŸitim<br>âœ¦ Bira FabrikasÄ± (+saldÄ±rÄ±)<br>âœ¦ Kahraman %20 yaÄŸma bonusu</div>
    </div>
    <div class="tribe-card turk" onclick="selectTribe('Turk')">
      <span class="tribe-icon">ğŸ‡</span>
      <h3>TÃ¼rkler</h3>
      <p>HÄ±zlÄ± atlÄ±lar, mÃ¼kemmel yaÄŸma. GÃ¶Ã§ebe taktikleri.</p>
      <div class="tribe-bonus">âœ¦ En hÄ±zlÄ± sÃ¼vari birimleri<br>âœ¦ BÃ¼yÃ¼k sÄ±ÄŸÄ±naklar (1.5x)<br>âœ¦ Kahraman +5 hÄ±z (atlÄ±)</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN GAME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gameScreen">
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="nav-icons">
        <div class="nav-icon active" onclick="showView('dorf1')" title="Kaynaklar" id="nav-dorf1">ğŸ˜ï¸</div>
        <div class="nav-icon" onclick="showView('dorf2')" title="Åehir Merkezi" id="nav-dorf2">ğŸ°</div>
        <div class="nav-icon" onclick="showView('map')" title="Harita" id="nav-map">ğŸ—ºï¸</div>
        <div class="nav-icon" onclick="showView('stats')" title="Ä°statistikler" id="nav-stats">ğŸ“Š</div>
        <div class="nav-icon" onclick="showView('reports')" title="Raporlar" id="nav-reports">ğŸ“œ<span class="badge hidden" id="reportBadge">0</span></div>
        <div class="nav-icon" onclick="showView('alliance')" title="Ä°ttifak" id="nav-alliance">ğŸ›¡ï¸</div>
      </div>
      <div class="res-bar">
        <div class="res-item" title="Odun">
          <span class="res-dot wood"></span>
          <span class="res-val" id="r-wood">0</span>
          <span class="res-cap">/<span id="r-wood-cap">800</span></span>
        </div>
        <div class="res-item" title="TuÄŸla">
          <span class="res-dot clay"></span>
          <span class="res-val" id="r-clay">0</span>
          <span class="res-cap">/<span id="r-clay-cap">800</span></span>
        </div>
        <div class="res-item" title="Demir">
          <span class="res-dot iron"></span>
          <span class="res-val" id="r-iron">0</span>
          <span class="res-cap">/<span id="r-iron-cap">800</span></span>
        </div>
        <div class="res-item" title="TahÄ±l">
          <span class="res-dot crop"></span>
          <span class="res-val" id="r-crop">0</span>
          <span class="res-cap">/<span id="r-crop-cap">800</span></span>
        </div>
        <div class="gold-display" title="YDS AltÄ±nÄ±">
          <span class="gold-icon">ğŸª™</span>
          <span id="r-gold">0</span>
        </div>
      </div>
      <div class="server-time">
        <span class="speed-badge">10x</span>
        <span id="serverTime">00:00:00</span>
      </div>
      <div class="nav-icon" onclick="doLogout()" title="Ã‡Ä±kÄ±ÅŸ">ğŸšª</div>
    </div>
  </div>

  <!-- GAME BODY -->
  <div class="game-body">
    <!-- LEFT SIDEBAR -->
    <div class="sidebar-left">
      <div class="panel">
        <div class="panel-header">ğŸ‘¤ KÃ¶y Profili</div>
        <div class="panel-body text-center">
          <div style="font-size:2rem;" id="tribeEmoji">ğŸ›ï¸</div>
          <div class="fw-700 text-gold" id="tribeName">RomalÄ±lar</div>
          <div class="fs-sm" style="color:var(--text-dim)">NÃ¼fus: <b id="population">2</b></div>
          <div class="fs-sm" style="color:var(--text-dim)">KÃ¶y: <b id="villageName">-</b></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">ğŸ“ˆ Saatlik Ãœretim</div>
        <div class="panel-body">
          <div class="prod-row"><span class="prod-label"><span class="res-dot wood"></span> Odun:</span><span id="p-wood">0</span></div>
          <div class="prod-row"><span class="prod-label"><span class="res-dot clay"></span> TuÄŸla:</span><span id="p-clay">0</span></div>
          <div class="prod-row"><span class="prod-label"><span class="res-dot iron"></span> Demir:</span><span id="p-iron">0</span></div>
          <div class="prod-row"><span class="prod-label"><span class="res-dot crop"></span> TahÄ±l:</span><span id="p-crop">0</span></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">ğŸª™ AltÄ±n DÃ¼kkanÄ±</div>
        <div class="panel-body">
          <button class="btn btn-gold btn-block btn-sm mb-2" onclick="goldAction('finish')">âš¡ Ä°nÅŸaat Bitir (5ğŸª™)</button>
          <button class="btn btn-gold btn-block btn-sm mb-2" onclick="goldAction('npc')">ğŸ”„ NPC TÃ¼ccar (3ğŸª™)</button>
          <button class="btn btn-gold btn-block btn-sm" onclick="goldAction('boost')">ğŸ“ˆ +%25 Ãœretim (10ğŸª™)</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">âš”ï¸ Askerler</div>
        <div class="panel-body" id="troopSummary">
          <div class="queue-empty">KÄ±ÅŸla gerekli</div>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- DORF1 VIEW -->
      <div id="view-dorf1">
        <div class="tab-bar">
          <button class="tab-btn active">ğŸ˜ï¸ Kaynak AlanlarÄ±</button>
        </div>
        <div class="village-view" id="dorf1Map"></div>
      </div>
      <!-- DORF2 VIEW -->
      <div id="view-dorf2" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active">ğŸ° Åehir Merkezi</button>
        </div>
        <div class="village-view dorf2" id="dorf2Map"></div>
      </div>
      <!-- MAP VIEW -->
      <div id="view-map" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active">ğŸ—ºï¸ DÃ¼nya HaritasÄ±</button>
          <div style="flex:1"></div>
          <div class="flex items-center gap-2" style="padding:4px;">
            <span class="fs-sm">X:</span><input type="number" id="mapGotoX" value="0" style="width:60px;">
            <span class="fs-sm">Y:</span><input type="number" id="mapGotoY" value="0" style="width:60px;">
            <button class="btn btn-green btn-sm" onclick="mapGoto()">Git</button>
          </div>
        </div>
        <div class="map-container" id="mapContainer">
          <div class="map-grid" id="mapGrid"></div>
          <div class="map-coords"><span>X: <b id="mapCoordX">0</b></span><span>Y: <b id="mapCoordY">0</b></span></div>
        </div>
      </div>
      <!-- STATS VIEW -->
      <div id="view-stats" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active" onclick="showStatTab('players')">ğŸ† Oyuncular</button>
          <button class="tab-btn" onclick="showStatTab('alliances')">ğŸ›¡ï¸ Ä°ttifaklar</button>
          <button class="tab-btn" onclick="showStatTab('attackers')">âš”ï¸ SaldÄ±rganlar</button>
        </div>
        <div id="statsContent"></div>
      </div>
      <!-- REPORTS VIEW -->
      <div id="view-reports" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active">ğŸ“œ Raporlar</button>
        </div>
        <div id="reportsContent"></div>
      </div>
      <!-- ALLIANCE VIEW -->
      <div id="view-alliance" class="hidden">
        <div class="tab-bar">
          <button class="tab-btn active">ğŸ›¡ï¸ Ä°ttifak</button>
        </div>
        <div id="allianceContent"></div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="sidebar-right">
      <div class="panel">
        <div class="panel-header">ğŸ”¨ Ä°nÅŸaat KuyruÄŸu</div>
        <div class="panel-body" id="buildQueue">
          <div class="queue-empty">Ä°nÅŸaat emri yok.</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">ğŸ—¡ï¸ Asker Hareketleri</div>
        <div class="panel-body" id="troopMovements">
          <div class="queue-empty">Hareket yok.</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">ğŸ“‹ Bilgi Kutusu</div>
        <div class="panel-body" id="infoBox">
          <div class="fs-sm" style="color:var(--text-dim)">HoÅŸ geldin! KÃ¶yÃ¼nÃ¼ geliÅŸtirmeye baÅŸla.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gameModal" class="modal-overlay hidden">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modalTitle">-</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME ENGINE - COMPLETE TRAVIAN CLONE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€â”€ CONSTANTS & DATA â”€â”€â”€
const SPEED = 10; // 10x speed
const MAP_SIZE = 200; // -100 to +100
const BOT_COUNT = 1000;
const TICK_MS = 1000;

// Dorf1 layout - 18 resource fields (percentages)
const DORF1_LAYOUT = [
  {id:1,type:'wood',x:28,y:12},{id:2,type:'wood',x:48,y:6},{id:3,type:'wood',x:68,y:10},
  {id:4,type:'crop',x:15,y:28},{id:5,type:'iron',x:35,y:22},{id:6,type:'crop',x:55,y:20},{id:7,type:'iron',x:75,y:25},
  {id:8,type:'clay',x:10,y:48},{id:9,type:'crop',x:30,y:42},{id:10,type:'crop',x:60,y:40},{id:11,type:'clay',x:85,y:46},
  {id:12,type:'wood',x:15,y:65},{id:13,type:'iron',x:38,y:62},{id:14,type:'clay',x:58,y:60},{id:15,type:'wood',x:80,y:63},
  {id:16,type:'crop',x:28,y:78},{id:17,type:'clay',x:50,y:82},{id:18,type:'crop',x:72,y:78}
];

// Dorf2 layout - 22 building slots
const DORF2_LAYOUT = [
  {id:19,x:18,y:18},{id:20,x:38,y:10},{id:21,x:58,y:8},{id:22,x:76,y:15},
  {id:23,x:8,y:35},{id:24,x:28,y:28},{id:25,x:68,y:26},{id:26,x:88,y:33},
  {id:27,x:15,y:52},{id:28,x:82,y:50},
  {id:29,x:45,y:42,isMain:true}, // Main Building
  {id:30,x:25,y:68},{id:31,x:42,y:60},{id:32,x:58,y:58},{id:33,x:75,y:65},
  {id:34,x:35,y:78},{id:35,x:55,y:76},{id:36,x:72,y:80},
  {id:37,x:10,y:82},{id:38,x:88,y:78},
  {id:39,x:50,y:25,isRally:true}, // Rally Point
  {id:40,x:50,y:95,isWall:true}   // Wall
];

// Building definitions
const BUILDINGS = {
  wood:{name:'Oduncu',icon:'ğŸªµ',desc:'Odun Ã¼retimini artÄ±rÄ±r.',cat:'field',
    cost:[40,100,50,60],time:26,prodBase:100},
  clay:{name:'TuÄŸla OcaÄŸÄ±',icon:'ğŸ§±',desc:'TuÄŸla Ã¼retimini artÄ±rÄ±r.',cat:'field',
    cost:[80,40,80,50],time:26,prodBase:100},
  iron:{name:'Demir Madeni',icon:'â›ï¸',desc:'Demir Ã¼retimini artÄ±rÄ±r.',cat:'field',
    cost:[100,80,30,60],time:26,prodBase:100},
  crop:{name:'Tarla',icon:'ğŸŒ¾',desc:'TahÄ±l Ã¼retimini artÄ±rÄ±r.',cat:'field',
    cost:[70,90,70,20],time:26,prodBase:100},
  center:{name:'Merkez Bina',icon:'ğŸ›ï¸',desc:'Ä°nÅŸaat sÃ¼relerini kÄ±saltÄ±r. Her seviye -%3.',cat:'infra',
    cost:[70,40,60,20],time:40,req:[]},
  warehouse:{name:'Depo',icon:'ğŸ“¦',desc:'Odun, tuÄŸla ve demir kapasitesini artÄ±rÄ±r.',cat:'infra',
    cost:[130,160,90,40],time:40,req:[{b:'center',lvl:1}],capBase:800},
  granary:{name:'TahÄ±l AmbarÄ±',icon:'ğŸº',desc:'TahÄ±l kapasitesini artÄ±rÄ±r.',cat:'infra',
    cost:[80,100,70,20],time:35,req:[{b:'center',lvl:1}],capBase:800},
  cranny:{name:'SÄ±ÄŸÄ±nak',icon:'ğŸ•³ï¸',desc:'KaynaklarÄ±nÄ± yaÄŸmadan korur.',cat:'infra',
    cost:[40,50,30,10],time:20,req:[]},
  embassy:{name:'ElÃ§ilik',icon:'ğŸ´',desc:'Ä°ttifak kurmanÄ± saÄŸlar.',cat:'infra',
    cost:[180,130,150,80],time:60,req:[{b:'center',lvl:1}]},
  rally:{name:'Askeri Ãœs',icon:'ğŸš©',desc:'Askerlerin toplandÄ±ÄŸÄ± alan.',cat:'military',
    cost:[110,160,90,70],time:35,req:[]},
  barracks:{name:'KÄ±ÅŸla',icon:'âš”ï¸',desc:'Piyade eÄŸitilir.',cat:'military',
    cost:[210,140,260,120],time:60,req:[{b:'center',lvl:3},{b:'rally',lvl:1}]},
  stable:{name:'AhÄ±r',icon:'ğŸ´',desc:'SÃ¼vari eÄŸitilir.',cat:'military',
    cost:[260,140,220,100],time:80,req:[{b:'center',lvl:5},{b:'barracks',lvl:3}]},
  academy:{name:'Akademi',icon:'ğŸ“š',desc:'Yeni birlikleri araÅŸtÄ±rÄ±r.',cat:'military',
    cost:[220,160,90,40],time:90,req:[{b:'center',lvl:3},{b:'barracks',lvl:3}]},
  blacksmith:{name:'ZÄ±rh DÃ¶kÃ¼mhanesi',icon:'ğŸ”¨',desc:'Asker zÄ±rhÄ±nÄ± geliÅŸtirir.',cat:'military',
    cost:[170,200,380,130],time:100,req:[{b:'center',lvl:3},{b:'academy',lvl:1}]},
  market:{name:'Pazar Yeri',icon:'ğŸª',desc:'Kaynak takasÄ± ve ticareti.',cat:'infra',
    cost:[80,70,120,70],time:50,req:[{b:'center',lvl:1},{b:'warehouse',lvl:1}]},
  wall:{name:'Sur',icon:'ğŸ§±',desc:'KÃ¶y savunmasÄ±nÄ± artÄ±rÄ±r.',cat:'defense',
    cost:[70,90,170,70],time:40,req:[]}
};

// Troop definitions per tribe
const TROOPS = {
  Roman:{
    t1:{name:'Lejyoner',icon:'ğŸ—¡ï¸',att:40,defI:35,defC:50,speed:6,carry:50,crop:1,
      cost:[120,100,150,30],time:30},
    t2:{name:'Praetorian',icon:'ğŸ›¡ï¸',att:30,defI:65,defC:35,speed:5,carry:20,crop:1,
      cost:[100,130,160,70],time:35},
    t3:{name:'Ä°mperian',icon:'âš”ï¸',att:70,defI:40,defC:25,speed:7,carry:50,crop:1,
      cost:[150,160,210,80],time:40},
    t4:{name:'Equites Legati',icon:'ğŸ',att:0,defI:20,defC:10,speed:16,carry:0,crop:2,
      cost:[140,160,20,40],time:25},
    t5:{name:'Equites Imperatoris',icon:'ğŸ‡',att:120,defI:65,defC:50,speed:14,carry:100,crop:3,
      cost:[550,440,320,100],time:70},
    ram:{name:'KoÃ§baÅŸÄ±',icon:'ğŸªµ',att:60,defI:30,defC:75,speed:4,carry:0,crop:3,
      cost:[900,360,500,70],time:120},
    senator:{name:'SenatÃ¶r',icon:'ğŸ‘‘',att:50,defI:40,defC:30,speed:4,carry:0,crop:5,
      cost:[5800,5300,5500,400],time:600}
  },
  Teuton:{
    t1:{name:'SavaÅŸÃ§Ä±',icon:'ğŸª“',att:40,defI:20,defC:5,speed:7,carry:60,crop:1,
      cost:[95,75,40,40],time:22},
    t2:{name:'MÄ±zrakÃ§Ä±',icon:'ğŸ”±',att:10,defI:35,defC:60,speed:7,carry:40,crop:1,
      cost:[145,70,85,40],time:28},
    t3:{name:'BaltacÄ±',icon:'âš”ï¸',att:60,defI:30,defC:30,speed:6,carry:50,crop:1,
      cost:[130,120,170,70],time:35},
    t4:{name:'Teutonic AtlÄ±',icon:'ğŸ',att:55,defI:100,defC:40,speed:10,carry:110,crop:2,
      cost:[350,450,230,60],time:50},
    t5:{name:'Paladin',icon:'ğŸ‡',att:150,defI:50,defC:75,speed:9,carry:80,crop:3,
      cost:[550,640,800,180],time:80},
    ram:{name:'KoÃ§baÅŸÄ±',icon:'ğŸªµ',att:65,defI:30,defC:80,speed:4,carry:0,crop:3,
      cost:[1000,300,350,70],time:120},
    chief:{name:'Åef',icon:'ğŸ‘‘',att:40,defI:60,defC:40,speed:4,carry:0,crop:4,
      cost:[35500,26600,25000,27200],time:600}
  },
  Turk:{
    t1:{name:'AkÄ±ncÄ±',icon:'ğŸ¹',att:15,defI:40,defC:50,speed:7,carry:35,crop:1,
      cost:[100,130,55,30],time:25},
    t2:{name:'KÄ±lÄ±Ã§ UstasÄ±',icon:'ğŸ—¡ï¸',att:45,defI:35,defC:20,speed:6,carry:45,crop:1,
      cost:[140,150,185,60],time:30},
    t3:{name:'Sipahi',icon:'ğŸ',att:90,defI:25,defC:40,speed:19,carry:75,crop:2,
      cost:[350,450,230,60],time:45},
    t4:{name:'Deli AtlÄ±',icon:'ğŸ‡',att:120,defI:65,defC:50,speed:16,carry:35,crop:2,
      cost:[360,330,280,120],time:55},
    t5:{name:'YeniÃ§eri',icon:'âš”ï¸',att:155,defI:80,defC:60,speed:5,carry:50,crop:3,
      cost:[950,555,330,75],time:80},
    ram:{name:'KoÃ§baÅŸÄ±',icon:'ğŸªµ',att:50,defI:30,defC:105,speed:4,carry:0,crop:3,
      cost:[950,555,330,75],time:120},
    bey:{name:'Bey',icon:'ğŸ‘‘',att:40,defI:60,defC:40,speed:5,carry:0,crop:4,
      cost:[30750,27200,24500,25200],time:600}
  }
};

// â”€â”€â”€ STATE MANAGEMENT â”€â”€â”€
let GS = null; // Game State
let currentUser = null;
let gameInterval = null;
let mapDragState = {dragging:false,startX:0,startY:0,scrollX:0,scrollY:0};

// â”€â”€â”€ LOGIN / REGISTER â”€â”€â”€
function showLoginTab(tab) {
  document.getElementById('loginForm').classList.toggle('hidden', tab!=='login');
  document.getElementById('registerForm').classList.toggle('hidden', tab!=='register');
  document.querySelectorAll('.login-tabs button').forEach((b,i)=> b.classList.toggle('active',(tab==='login'?i===0:i===1)));
  document.getElementById('loginError').style.display='none';
}

function showError(msg){
  const el=document.getElementById('loginError');
  el.textContent=msg; el.style.display='block';
}

function getUsers(){return JSON.parse(localStorage.getItem('yds_users')||'{}');}
function saveUsers(u){localStorage.setItem('yds_users',JSON.stringify(u));}

function doRegister(){
  const user=document.getElementById('regUser').value.trim();
  const pass=document.getElementById('regPass').value;
  const pass2=document.getElementById('regPass2').value;
  if(!user||user.length<2)return showError('KullanÄ±cÄ± adÄ± en az 2 karakter olmalÄ±.');
  if(pass.length<4)return showError('Åifre en az 4 karakter olmalÄ±.');
  if(pass!==pass2)return showError('Åifreler eÅŸleÅŸmiyor.');
  const users=getUsers();
  if(users[user])return showError('Bu kullanÄ±cÄ± adÄ± zaten alÄ±nmÄ±ÅŸ.');
  users[user]={pass:pass,created:Date.now()};
  saveUsers(users);
  currentUser=user;
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('tribeScreen').classList.remove('hidden');
}

function doLogin(){
  const user=document.getElementById('loginUser').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!user||!pass)return showError('KullanÄ±cÄ± adÄ± ve ÅŸifreyi gir.');
  const users=getUsers();
  if(!users[user]||users[user].pass!==pass)return showError('HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre.');
  currentUser=user;
  const state=localStorage.getItem('yds_gs_'+user);
  if(!state){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('tribeScreen').classList.remove('hidden');
  } else {
    GS=JSON.parse(state);
    document.getElementById('loginScreen').classList.add('hidden');
    startGame();
  }
}

function doLogout(){
  if(gameInterval)clearInterval(gameInterval);
  saveGame();
  currentUser=null; GS=null;
  document.getElementById('gameScreen').style.display='none';
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
}

// â”€â”€â”€ TRIBE SELECTION â”€â”€â”€
function selectTribe(tribe){
  initNewGame(tribe);
  document.getElementById('tribeScreen').classList.add('hidden');
  startGame();
}

// â”€â”€â”€ INITIALIZE NEW GAME STATE â”€â”€â”€
function initNewGame(tribe){
  // Generate world with bots
  const bots = generateBots();
  // Player position near center
  const px = Math.floor(Math.random()*11)-5;
  const py = Math.floor(Math.random()*11)-5;

  GS = {
    tribe: tribe,
    playerName: currentUser,
    gold: parseInt(localStorage.getItem('yds_game_gold'))||50,
    villages: [{
      id: 1,
      name: currentUser+"'s KÃ¶yÃ¼",
      x: px, y: py,
      resources: {wood:500,clay:500,iron:500,crop:500},
      warehouse: 800,
      granary: 800,
      fields: DORF1_LAYOUT.map(f=>({id:f.id,type:f.type,level:0})),
      buildings: DORF2_LAYOUT.map(b=>{
        if(b.isMain)return{id:b.id,type:'center',level:1};
        if(b.isRally)return{id:b.id,type:'empty',level:0,isRally:true};
        if(b.isWall)return{id:b.id,type:'empty',level:0,isWall:true};
        return{id:b.id,type:'empty',level:0};
      }),
      troops:{},
      buildQueue:[],
      troopQueue:[]
    }],
    activeVillage: 0,
    population: 2,
    alliance: null,
    reports: [],
    prodBoostUntil: 0,
    bots: bots,
    botAlliances: generateBotAlliances(bots),
    lastUpdate: Date.now(),
    troopMovements: [],
    gameStarted: Date.now()
  };
  saveGame();
}

function generateBots(){
  const bots=[];
  const tribes=['Roman','Teuton','Turk'];
  const prefixes=['Kara','Ak','GÃ¶k','AteÅŸ','Buz','KÄ±zÄ±l','Demir','AltÄ±n','GÃ¼mÃ¼ÅŸ','YÄ±ldÄ±z'];
  const suffixes=['Han','Bey','PaÅŸa','Kurt','Arslan','Kartal','Åahin','Barut','KÄ±lÄ±Ã§','Kalkan'];
  const names2=['Maximus','Brutus','Caesar','Alaric','Wotan','Attila','Genghis','Timur','Mehmed','Osman','ErtuÄŸrul','Suleiman','Hannibal','Spartacus','Vercingetorix','Boudicca','Arminius','Thor','Ragnar','Bjorn','Ivar','Floki','Erik','Leif','Sigurd','Harald','Olaf','Magnus','Sven','Gunnar','Rurik','Igor','Svyatoslav','Murat','Yavuz','Fatih','Selim','Bayezid','Orhan','Alp'];
  const usedCoords=new Set();

  for(let i=0;i<BOT_COUNT;i++){
    let x,y;
    do{
      x=Math.floor(Math.random()*181)-90;
      y=Math.floor(Math.random()*181)-90;
    }while(usedCoords.has(x+','+y)||(Math.abs(x)<3&&Math.abs(y)<3));
    usedCoords.add(x+','+y);

    const tribe=tribes[Math.floor(Math.random()*3)];
    let name;
    if(Math.random()<0.5){
      name=prefixes[Math.floor(Math.random()*prefixes.length)]+suffixes[Math.floor(Math.random()*suffixes.length)];
    } else {
      name=names2[Math.floor(Math.random()*names2.length)]+(Math.floor(Math.random()*99)+1);
    }

    const baseLevel=Math.max(1,Math.floor(Math.random()*5)+1);
    bots.push({
      id:i+100,
      name:name,
      tribe:tribe,
      x:x, y:y,
      pop: baseLevel*20+Math.floor(Math.random()*50),
      level: baseLevel,
      troops: generateBotTroops(tribe,baseLevel),
      alliance: null,
      lastGrow: Date.now()
    });
  }
  return bots;
}

function generateBotTroops(tribe,level){
  const t={};
  const types=Object.keys(TROOPS[tribe]);
  const count=Math.min(3,types.length);
  for(let i=0;i<count;i++){
    t[types[i]]=Math.floor(Math.random()*level*15)+level*5;
  }
  return t;
}

function generateBotAlliances(bots){
  const alliances=[];
  const allianceNames=['Wolfpack','Iron Legion','Storm Riders','Dark Order','Golden Horde','Blood Eagles','Thunder Clan','Fire Nation','Ice Bears','Shadow Guild',
    'Kurtlar Vadisi','OsmanlÄ± TorunlarÄ±','Bozkurt Ä°ttifakÄ±','KÄ±zÄ±l Elma','Turan BirliÄŸi','Roma Ä°mparatorluÄŸu','Cermen KardeÅŸliÄŸi','Akdeniz BirliÄŸi','Vikingler','ÅÃ¶valyeler'];

  for(let i=0;i<20;i++){
    const members=[];
    const start=Math.floor(Math.random()*bots.length);
    const size=Math.floor(Math.random()*40)+10;
    for(let j=0;j<size&&members.length<60;j++){
      const idx=(start+j)%bots.length;
      if(!bots[idx].alliance){
        bots[idx].alliance=i;
        members.push(bots[idx].id);
      }
    }
    if(members.length>0){
      alliances.push({id:i,name:allianceNames[i]||('Ä°ttifak-'+(i+1)),leader:members[0],members:members});
    }
  }
  return alliances;
}

// â”€â”€â”€ SAVE / LOAD â”€â”€â”€
function saveGame(){
  if(GS&&currentUser) localStorage.setItem('yds_gs_'+currentUser,JSON.stringify(GS));
}

// â”€â”€â”€ START GAME â”€â”€â”€
function startGame(){
  document.getElementById('gameScreen').style.display='block';
  // Calculate offline progress
  const now=Date.now();
  const offlineSec=Math.floor((now-GS.lastUpdate)/1000);
  if(offlineSec>0) processOffline(offlineSec);
  GS.lastUpdate=now;

  // Refresh gold from quiz system
  const quizGold=parseInt(localStorage.getItem('yds_game_gold'))||0;
  if(quizGold>GS.gold) GS.gold=quizGold;

  updateTribeDisplay();
  renderDorf1();
  renderDorf2();
  updateUI();
  initMap();

  if(gameInterval)clearInterval(gameInterval);
  gameInterval=setInterval(gameTick,TICK_MS);
}

// â”€â”€â”€ MAIN GAME TICK (every second) â”€â”€â”€
function gameTick(){
  const now=Date.now();
  const v=GS.villages[GS.activeVillage];

  // 1. Resource Production
  const prod=calcProduction(v);
  const boost=(GS.prodBoostUntil>now)?1.25:1;
  v.resources.wood=Math.min(v.warehouse, v.resources.wood+(prod.wood*boost)/3600);
  v.resources.clay=Math.min(v.warehouse, v.resources.clay+(prod.clay*boost)/3600);
  v.resources.iron=Math.min(v.warehouse, v.resources.iron+(prod.iron*boost)/3600);
  v.resources.crop=Math.min(v.granary, v.resources.crop+(prod.crop*boost)/3600);

  // 2. Process Build Queue
  processBuildQueue(v);

  // 3. Process Troop Queue
  processTroopQueue(v);

  // 4. Process Troop Movements
  processTroopMovements();

  // 5. Bot AI (every 30 seconds)
  if(now%30000<1100) botAI();

  // 6. Update UI
  GS.lastUpdate=now;
  updateUI();

  // Auto-save every 30 seconds
  if(now%30000<1100) saveGame();
}

function calcProduction(v){
  let wood=20*SPEED, clay=20*SPEED, iron=20*SPEED, crop=20*SPEED; // base
  v.fields.forEach(f=>{
    if(f.level>0){
      const base=BUILDINGS[f.type].prodBase||100;
      const prod=Math.floor(base*Math.pow(1.25,f.level-1)*SPEED/10);
      if(f.type==='wood') wood+=prod;
      if(f.type==='clay') clay+=prod;
      if(f.type==='iron') iron+=prod;
      if(f.type==='crop') crop+=prod;
    }
  });
  // Troop crop consumption
  let troopCrop=0;
  const troops=v.troops;
  const tribeTroops=TROOPS[GS.tribe];
  Object.entries(troops).forEach(([k,count])=>{
    if(tribeTroops[k]) troopCrop+=tribeTroops[k].crop*count;
  });
  crop-=troopCrop*SPEED;
  return{wood,clay,iron,crop};
}

function processBuildQueue(v){
  if(v.buildQueue.length===0) return;

  let activeTasks=[];
  if(GS.tribe==='Roman'){
    // Romans: 1 field + 1 building simultaneously
    const fTask=v.buildQueue.find(t=>t.isField);
    const bTask=v.buildQueue.find(t=>!t.isField);
    if(fTask) activeTasks.push(fTask);
    if(bTask) activeTasks.push(bTask);
  } else {
    // Others: All tasks process (unlimited queue)
    activeTasks.push(v.buildQueue[0]);
  }

  activeTasks.forEach(task=>{
    task.timeLeft-=SPEED;
    if(task.timeLeft<=0) completeConstruction(v,task);
  });
}

function completeConstruction(v,task){
  if(task.isField){
    const f=v.fields.find(x=>x.id===task.targetId);
    if(f) f.level++;
  } else {
    const b=v.buildings.find(x=>x.id===task.targetId);
    if(b){
      if(b.type==='empty') b.type=task.type;
      b.level++;
      // Update capacities
      if(task.type==='warehouse') v.warehouse=800+b.level*400;
      if(task.type==='granary') v.granary=800+b.level*400;
    }
  }
  GS.population+=Math.floor(Math.random()*3)+1;
  v.buildQueue=v.buildQueue.filter(t=>t.qId!==task.qId);
  addInfo(task.name+' tamamlandÄ±!','âœ…');
  renderDorf1(); renderDorf2();
}

function processTroopQueue(v){
  if(!v.troopQueue||v.troopQueue.length===0) return;
  v.troopQueue.forEach(tq=>{
    tq.timeLeft-=SPEED;
    if(tq.timeLeft<=0){
      v.troops[tq.type]=(v.troops[tq.type]||0)+tq.count;
      addInfo(tq.count+' '+TROOPS[GS.tribe][tq.type].name+' eÄŸitildi!','âš”ï¸');
    }
  });
  v.troopQueue=v.troopQueue.filter(t=>t.timeLeft>0);
}

function processTroopMovements(){
  if(!GS.troopMovements||GS.troopMovements.length===0) return;
  GS.troopMovements.forEach(mv=>{
    mv.timeLeft-=SPEED;
    if(mv.timeLeft<=0){
      if(mv.type==='attack') resolveAttack(mv);
      else if(mv.type==='return') resolveReturn(mv);
    }
  });
  GS.troopMovements=GS.troopMovements.filter(m=>m.timeLeft>0);
}

function resolveAttack(mv){
  const target=GS.bots.find(b=>b.id===mv.targetId);
  if(!target)return;

  let attPower=0;
  const tribeTroops=TROOPS[GS.tribe];
  Object.entries(mv.troops).forEach(([k,count])=>{
    if(tribeTroops[k]) attPower+=tribeTroops[k].att*count;
  });

  let defPower=0;
  const defTribe=TROOPS[target.tribe];
  Object.entries(target.troops).forEach(([k,count])=>{
    if(defTribe[k]) defPower+=(defTribe[k].defI+defTribe[k].defC)/2*count;
  });

  // Wall bonus
  defPower*=1.02;

  const attRatio=attPower/(attPower+defPower+1);
  const won=attRatio>0.5;

  let loot={wood:0,clay:0,iron:0,crop:0};
  let attLosses={}, defLosses={};

  if(won){
    // Attacker wins
    const lossRatio=1-attRatio;
    Object.entries(mv.troops).forEach(([k,count])=>{
      attLosses[k]=Math.floor(count*lossRatio*0.8);
      mv.troops[k]=count-attLosses[k];
    });
    // Destroy all defenders
    Object.entries(target.troops).forEach(([k,count])=>{
      defLosses[k]=count;
    });
    target.troops={};
    // Loot
    let carryTotal=0;
    Object.entries(mv.troops).forEach(([k,count])=>{
      if(tribeTroops[k]) carryTotal+=tribeTroops[k].carry*count;
    });
    const baseLoot=Math.min(carryTotal/4, target.pop*10);
    loot={wood:Math.floor(baseLoot),clay:Math.floor(baseLoot),iron:Math.floor(baseLoot),crop:Math.floor(baseLoot)};
    target.pop=Math.max(5,target.pop-5);
  } else {
    // Defender wins
    const lossRatio=attRatio;
    Object.entries(mv.troops).forEach(([k,count])=>{
      attLosses[k]=Math.floor(count*0.9);
      mv.troops[k]=count-attLosses[k];
    });
    Object.entries(target.troops).forEach(([k,count])=>{
      defLosses[k]=Math.floor(count*(1-lossRatio)*0.3);
      target.troops[k]=count-defLosses[k];
    });
  }

  // Add report
  GS.reports.unshift({
    time:Date.now(),
    type:'attack',
    target:target.name,
    targetCoord:{x:target.x,y:target.y},
    won:won,
    attLosses:attLosses,
    defLosses:defLosses,
    loot:loot
  });

  // Send surviving troops back with loot
  if(Object.values(mv.troops).some(c=>c>0)){
    const dist=Math.sqrt(Math.pow(mv.fromX-target.x,2)+Math.pow(mv.fromY-target.y,2));
    const returnTime=Math.max(10,Math.floor(dist*100/SPEED));
    GS.troopMovements.push({
      type:'return',
      troops:{...mv.troops},
      loot:loot,
      villageId:mv.villageId,
      timeLeft:returnTime,
      totalTime:returnTime,
      fromName:target.name
    });
  }
  addInfo(won?'SaldÄ±rÄ± zaferle sonuÃ§landÄ±!':'SaldÄ±rÄ± baÅŸarÄ±sÄ±z oldu.', won?'âš”ï¸':'ğŸ’€');
}

function resolveReturn(mv){
  const v=GS.villages.find(vl=>vl.id===mv.villageId);
  if(!v)return;
  // Return troops
  Object.entries(mv.troops).forEach(([k,count])=>{
    v.troops[k]=(v.troops[k]||0)+count;
  });
  // Add loot
  if(mv.loot){
    v.resources.wood=Math.min(v.warehouse,v.resources.wood+mv.loot.wood);
    v.resources.clay=Math.min(v.warehouse,v.resources.clay+mv.loot.clay);
    v.resources.iron=Math.min(v.warehouse,v.resources.iron+mv.loot.iron);
    v.resources.crop=Math.min(v.granary,v.resources.crop+mv.loot.crop);
  }
  addInfo('Askerler '+mv.loot.wood+' yaÄŸma ile dÃ¶ndÃ¼!','ğŸ ');
}

function processOffline(seconds){
  const v=GS.villages[GS.activeVillage];
  const prod=calcProduction(v);
  v.resources.wood=Math.min(v.warehouse,v.resources.wood+(prod.wood/3600)*seconds);
  v.resources.clay=Math.min(v.warehouse,v.resources.clay+(prod.clay/3600)*seconds);
  v.resources.iron=Math.min(v.warehouse,v.resources.iron+(prod.iron/3600)*seconds);
  v.resources.crop=Math.min(v.granary,v.resources.crop+(prod.crop/3600)*seconds);
  // Process queues
  const ticks=Math.floor(seconds);
  for(let i=0;i<Math.min(ticks,3600);i++){
    processBuildQueue(v);
    processTroopQueue(v);
  }
}

// â”€â”€â”€ BOT AI â”€â”€â”€
function botAI(){
  const now=Date.now();
  GS.bots.forEach(bot=>{
    // Grow every ~60 seconds
    if(now-bot.lastGrow>60000){
      bot.level=Math.min(20,bot.level+0.1);
      bot.pop+=Math.floor(Math.random()*3)+1;
      // Regenerate some troops
      const types=Object.keys(TROOPS[bot.tribe]);
      const rType=types[Math.floor(Math.random()*Math.min(3,types.length))];
      bot.troops[rType]=(bot.troops[rType]||0)+Math.floor(Math.random()*3)+1;
      bot.lastGrow=now;
    }
  });
}

// â”€â”€â”€ UI UPDATE â”€â”€â”€
function updateUI(){
  const v=GS.villages[GS.activeVillage];
  const prod=calcProduction(v);
  const boost=(GS.prodBoostUntil>Date.now())?1.25:1;

  // Resources
  document.getElementById('r-wood').textContent=formatNum(Math.floor(v.resources.wood));
  document.getElementById('r-clay').textContent=formatNum(Math.floor(v.resources.clay));
  document.getElementById('r-iron').textContent=formatNum(Math.floor(v.resources.iron));
  document.getElementById('r-crop').textContent=formatNum(Math.floor(v.resources.crop));
  document.getElementById('r-wood-cap').textContent=formatNum(v.warehouse);
  document.getElementById('r-clay-cap').textContent=formatNum(v.warehouse);
  document.getElementById('r-iron-cap').textContent=formatNum(v.warehouse);
  document.getElementById('r-crop-cap').textContent=formatNum(v.granary);

  // Gold
  document.getElementById('r-gold').textContent=GS.gold;

  // Production
  document.getElementById('p-wood').textContent=formatNum(Math.floor(prod.wood*boost));
  document.getElementById('p-clay').textContent=formatNum(Math.floor(prod.clay*boost));
  document.getElementById('p-iron').textContent=formatNum(Math.floor(prod.iron*boost));
  document.getElementById('p-crop').textContent=formatNum(Math.floor(prod.crop*boost));

  // Population
  document.getElementById('population').textContent=GS.population;
  document.getElementById('villageName').textContent=v.name;

  // Build queue
  renderBuildQueue(v);

  // Troop summary
  renderTroopSummary(v);

  // Troop movements
  renderTroopMovements();

  // Server time
  const d=new Date();
  document.getElementById('serverTime').textContent=
    String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
}

function updateTribeDisplay(){
  const icons={Roman:'ğŸ›ï¸',Teuton:'ğŸª“',Turk:'ğŸ‡'};
  const names={Roman:'RomalÄ±lar',Teuton:'Cermenler',Turk:'TÃ¼rkler'};
  document.getElementById('tribeEmoji').textContent=icons[GS.tribe]||'âš”ï¸';
  document.getElementById('tribeName').textContent=names[GS.tribe]||GS.tribe;
}

function renderBuildQueue(v){
  const el=document.getElementById('buildQueue');
  if(v.buildQueue.length===0){
    el.innerHTML='<div class="queue-empty">Ä°nÅŸaat emri yok.</div>';
    return;
  }
  let html='';
  v.buildQueue.forEach((t,i)=>{
    let isActive=false;
    if(GS.tribe==='Roman'){
      if(t===v.buildQueue.find(x=>x.isField)||t===v.buildQueue.find(x=>!x.isField)) isActive=true;
    } else {
      if(i===0) isActive=true;
    }
    html+=`<div class="queue-item ${isActive?'active':''}">
      <span class="q-name">${t.name} Sv.${t.targetLevel}</span>
      <span class="q-time">${isActive?formatTime(Math.max(0,t.timeLeft)):'â¸ï¸'}</span>
    </div>`;
  });
  // Troop queue
  if(v.troopQueue&&v.troopQueue.length>0){
    v.troopQueue.forEach(tq=>{
      html+=`<div class="queue-item active">
        <span class="q-name">ğŸ—¡ï¸ ${tq.count}x ${TROOPS[GS.tribe][tq.type]?.name||tq.type}</span>
        <span class="q-time">${formatTime(Math.max(0,tq.timeLeft))}</span>
      </div>`;
    });
  }
  el.innerHTML=html;
}

function renderTroopSummary(v){
  const el=document.getElementById('troopSummary');
  const tribeTroops=TROOPS[GS.tribe];
  if(!v.troops||Object.keys(v.troops).length===0){
    const hasBarracks=v.buildings.some(b=>b.type==='barracks'&&b.level>0);
    el.innerHTML=`<div class="queue-empty">${hasBarracks?'Asker yok.':'KÄ±ÅŸla gerekli'}</div>`;
    return;
  }
  let html='';
  Object.entries(v.troops).forEach(([k,count])=>{
    if(count>0&&tribeTroops[k]){
      html+=`<div class="troop-row">
        <span class="troop-icon">${tribeTroops[k].icon}</span>
        <div class="troop-info">
          <div class="troop-name">${tribeTroops[k].name}</div>
        </div>
        <span class="troop-count">${count}</span>
      </div>`;
    }
  });
  el.innerHTML=html||'<div class="queue-empty">Asker yok.</div>';
}

function renderTroopMovements(){
  const el=document.getElementById('troopMovements');
  if(!GS.troopMovements||GS.troopMovements.length===0){
    el.innerHTML='<div class="queue-empty">Hareket yok.</div>';
    return;
  }
  let html='';
  GS.troopMovements.forEach(mv=>{
    const icon=mv.type==='attack'?'âš”ï¸':'ğŸ ';
    const label=mv.type==='attack'?'SaldÄ±rÄ±':'DÃ¶nÃ¼ÅŸ';
    html+=`<div class="queue-item active">
      <span class="q-name">${icon} ${label}</span>
      <span class="q-time">${formatTime(Math.max(0,mv.timeLeft))}</span>
    </div>`;
  });
  el.innerHTML=html;
}

// â”€â”€â”€ RENDER VILLAGE MAPS â”€â”€â”€
function renderDorf1(){
  const v=GS.villages[GS.activeVillage];
  const map=document.getElementById('dorf1Map');
  let html='<div class="village-center-img">ğŸ </div>';
  v.fields.forEach(f=>{
    const layout=DORF1_LAYOUT.find(l=>l.id===f.id);
    const cls=f.level>0?'s-'+f.type:'empty';
    const label=f.level>0?f.level:'';
    html+=`<div class="village-slot ${cls}" style="left:calc(${layout.x}% - 22px);top:calc(${layout.y}% - 22px);" onclick="openBuildModal(${f.id},'field')">${label}</div>`;
  });
  map.innerHTML=html;
}

function renderDorf2(){
  const v=GS.villages[GS.activeVillage];
  const map=document.getElementById('dorf2Map');
  let html='<div class="village-center-img">ğŸ°</div>';
  v.buildings.forEach(b=>{
    const layout=DORF2_LAYOUT.find(l=>l.id===b.id);
    let cls='empty';
    if(b.level>0){
      if(b.type==='center') cls='s-main';
      else if(layout.isRally) cls='s-rally';
      else if(layout.isWall) cls='s-wall';
      else cls='s-building';
    }
    if(layout.isWall) cls+=' s-wall';
    const label=b.level>0?(layout.isWall?BUILDINGS[b.type]?.name+' '+b.level:b.level):'';
    html+=`<div class="village-slot ${cls}" style="left:calc(${layout.x}% - ${layout.isWall?60:22}px);top:calc(${layout.y}% - ${layout.isWall?15:22}px);" onclick="openBuildModal(${b.id},'building')">${label}</div>`;
  });
  map.innerHTML=html;
}

// â”€â”€â”€ BUILD MODAL â”€â”€â”€
function openBuildModal(id,mapType){
  const v=GS.villages[GS.activeVillage];
  let item;
  if(mapType==='field') item=v.fields.find(f=>f.id===id);
  else item=v.buildings.find(b=>b.id===id);
  if(!item)return;

  const modal=document.getElementById('gameModal');
  const title=document.getElementById('modalTitle');
  const body=document.getElementById('modalBody');

  if(item.type&&item.type!=='empty'&&item.level>0){
    // Upgrade existing
    const info=BUILDINGS[item.type];
    if(!info)return;
    const nextLvl=item.level+1;
    const costs=calcCost(info.cost,item.level);
    const time=calcTime(info.time,item.level,v);
    const canAfford=v.resources.wood>=costs[0]&&v.resources.clay>=costs[1]&&v.resources.iron>=costs[2]&&v.resources.crop>=costs[3];

    title.textContent=info.name+' - Seviye '+item.level;
    body.innerHTML=`
      <div class="build-item" style="border:none;padding:0;">
        <div class="b-icon" style="background:rgba(200,160,80,0.1);font-size:2rem;">${info.icon}</div>
        <div class="b-info">
          <div class="b-name" style="font-size:1.1rem;">${info.name} <span style="color:var(--text-dim);font-size:0.85rem;">Seviye ${item.level}</span></div>
          <div class="b-desc">${info.desc}</div>
          ${info.prodBase?`<div class="mt-1 fs-sm text-green">Ãœretim: ${Math.floor(info.prodBase*Math.pow(1.25,item.level-1)*SPEED/10)}/saat â†’ ${Math.floor(info.prodBase*Math.pow(1.25,nextLvl-1)*SPEED/10)}/saat</div>`:''}
          ${info.capBase?`<div class="mt-1 fs-sm text-green">Kapasite: ${800+item.level*400} â†’ ${800+nextLvl*400}</div>`:''}
        </div>
      </div>
      <hr class="divider">
      <h4 style="font-size:0.9rem;margin-bottom:8px;">Seviye ${nextLvl} iÃ§in Gerekli:</h4>
      <div class="flex gap-3 mb-2" style="flex-wrap:wrap;">
        <div class="b-cost ${v.resources.wood<costs[0]?'insufficient':''}"><span class="res-dot wood"></span> ${formatNum(costs[0])}</div>
        <div class="b-cost ${v.resources.clay<costs[1]?'insufficient':''}"><span class="res-dot clay"></span> ${formatNum(costs[1])}</div>
        <div class="b-cost ${v.resources.iron<costs[2]?'insufficient':''}"><span class="res-dot iron"></span> ${formatNum(costs[2])}</div>
        <div class="b-cost ${v.resources.crop<costs[3]?'insufficient':''}"><span class="res-dot crop"></span> ${formatNum(costs[3])}</div>
        <div class="b-cost">â±ï¸ ${formatTime(time)}</div>
      </div>
      <div class="mt-2">
        <button class="btn ${canAfford?'btn-green':'btn-red'} btn-block" ${canAfford?`onclick="issueUpgrade(${id},'${item.type}',${mapType==='field'},${nextLvl})"`:''}>
          ${canAfford?'â¬†ï¸ Seviye '+nextLvl+' Yap':'âŒ Yetersiz Kaynak'}
        </button>
      </div>
      ${item.type==='barracks'||item.type==='stable'?`<hr class="divider"><button class="btn btn-gold btn-block" onclick="closeModal();openTroopModal('${item.type}')">ğŸ—¡ï¸ Asker EÄŸit</button>`:''}
      ${item.type==='rally'?`<hr class="divider"><button class="btn btn-red btn-block" onclick="closeModal();openAttackModal()">âš”ï¸ SaldÄ±rÄ± GÃ¶nder</button>`:''}
      ${item.type==='embassy'?`<hr class="divider"><button class="btn btn-green btn-block" onclick="closeModal();showView('alliance')">ğŸ›¡ï¸ Ä°ttifak YÃ¶netimi</button>`:''}
    `;
  } else {
    // Build new
    const layout=mapType==='building'?DORF2_LAYOUT.find(l=>l.id===id):null;
    title.textContent=mapType==='field'?'Kaynak YÃ¼kselt':'Yeni Bina Ä°nÅŸa Et';

    let html='';
    if(mapType==='field'){
      // Resource field - just upgrade from level 0
      const fItem=v.fields.find(f=>f.id===id);
      const info=BUILDINGS[fItem.type];
      const costs=calcCost(info.cost,0);
      const time=calcTime(info.time,0,v);
      const canAfford=v.resources.wood>=costs[0]&&v.resources.clay>=costs[1]&&v.resources.iron>=costs[2]&&v.resources.crop>=costs[3];
      html=`<div class="build-item">
        <div class="b-icon" style="background:rgba(200,160,80,0.1);">${info.icon}</div>
        <div class="b-info">
          <div class="b-name">${info.name}</div>
          <div class="b-desc">${info.desc}</div>
          <div class="b-costs">
            <div class="b-cost ${v.resources.wood<costs[0]?'insufficient':''}"><span class="res-dot wood"></span>${formatNum(costs[0])}</div>
            <div class="b-cost ${v.resources.clay<costs[1]?'insufficient':''}"><span class="res-dot clay"></span>${formatNum(costs[1])}</div>
            <div class="b-cost ${v.resources.iron<costs[2]?'insufficient':''}"><span class="res-dot iron"></span>${formatNum(costs[2])}</div>
            <div class="b-cost ${v.resources.crop<costs[3]?'insufficient':''}"><span class="res-dot crop"></span>${formatNum(costs[3])}</div>
            <div class="b-cost">â±ï¸${formatTime(time)}</div>
          </div>
        </div>
        <div class="b-action"><button class="btn ${canAfford?'btn-green':'btn-red'} btn-sm" ${canAfford?`onclick="issueUpgrade(${id},'${fItem.type}',true,1)"`:''}>
          ${canAfford?'Ä°nÅŸa Et':'Yetersiz'}
        </button></div>
      </div>`;
    } else {
      // Building list
      const fieldTypes=['wood','clay','iron','crop'];
      Object.entries(BUILDINGS).forEach(([type,info])=>{
        if(fieldTypes.includes(type)) return;
        // Special slot checks
        if(layout&&layout.isWall&&type!=='wall') return;
        if(layout&&!layout.isWall&&type==='wall') return;
        if(layout&&layout.isRally&&type!=='rally') return;
        if(layout&&!layout.isRally&&type==='rally') return;
        // Check if already built (unique buildings)
        const alreadyBuilt=v.buildings.some(b=>b.type===type&&b.level>0);
        if(alreadyBuilt&&type!=='cranny'&&type!=='warehouse'&&type!=='granary') return;

        // Check requirements
        let canBuild=true;
        let reqText='';
        (info.req||[]).forEach(r=>{
          const found=v.buildings.find(b=>b.type===r.b&&b.level>=r.lvl);
          if(!found){canBuild=false;reqText+=BUILDINGS[r.b].name+' Sv.'+r.lvl+', ';}
        });

        const costs=info.cost;
        const time=calcTime(info.time,0,v);
        const canAfford=canBuild&&v.resources.wood>=costs[0]&&v.resources.clay>=costs[1]&&v.resources.iron>=costs[2]&&v.resources.crop>=costs[3];

        html+=`<div class="build-item ${!canBuild?'disabled':''}">
          <div class="b-icon" style="background:rgba(200,160,80,0.1);">${info.icon}</div>
          <div class="b-info">
            <div class="b-name">${info.name}</div>
            <div class="b-desc">${info.desc}</div>
            ${!canBuild?`<div class="req-text">âŒ Gereksinim: ${reqText.slice(0,-2)}</div>`:''}
            <div class="b-costs">
              <div class="b-cost ${!canAfford?'insufficient':''}"><span class="res-dot wood"></span>${formatNum(costs[0])}</div>
              <div class="b-cost ${!canAfford?'insufficient':''}"><span class="res-dot clay"></span>${formatNum(costs[1])}</div>
              <div class="b-cost ${!canAfford?'insufficient':''}"><span class="res-dot iron"></span>${formatNum(costs[2])}</div>
              <div class="b-cost ${!canAfford?'insufficient':''}"><span class="res-dot crop"></span>${formatNum(costs[3])}</div>
              <div class="b-cost">â±ï¸${formatTime(time)}</div>
            </div>
          </div>
          <div class="b-action">
            ${canBuild&&canAfford?`<button class="btn btn-green btn-sm" onclick="issueConstruct(${id},'${type}')">Ä°nÅŸa Et</button>`:`<button class="btn btn-red btn-sm" disabled>âŒ</button>`}
          </div>
        </div>`;
      });
    }
    body.innerHTML=html;
  }
  modal.classList.remove('hidden');
}

function issueUpgrade(id,type,isField,targetLevel){
  const v=GS.villages[GS.activeVillage];
  const info=BUILDINGS[type];
  const item=isField?v.fields.find(f=>f.id===id):v.buildings.find(b=>b.id===id);
  const costs=calcCost(info.cost,item.level);
  const time=calcTime(info.time,item.level,v);

  if(v.resources.wood<costs[0]||v.resources.clay<costs[1]||v.resources.iron<costs[2]||v.resources.crop<costs[3])return;

  v.resources.wood-=costs[0];v.resources.clay-=costs[1];v.resources.iron-=costs[2];v.resources.crop-=costs[3];

  v.buildQueue.push({
    qId:Date.now()+Math.random(),
    targetId:id,type:type,
    name:info.name,
    isField:isField,
    timeLeft:time,totalTime:time,
    targetLevel:targetLevel
  });
  closeModal();
  updateUI();
}

function issueConstruct(id,type){
  const v=GS.villages[GS.activeVillage];
  const info=BUILDINGS[type];
  const costs=info.cost;
  const time=calcTime(info.time,0,v);

  if(v.resources.wood<costs[0]||v.resources.clay<costs[1]||v.resources.iron<costs[2]||v.resources.crop<costs[3])return;

  v.resources.wood-=costs[0];v.resources.clay-=costs[1];v.resources.iron-=costs[2];v.resources.crop-=costs[3];

  // Set building type
  const b=v.buildings.find(x=>x.id===id);
  if(b) b.type=type;

  v.buildQueue.push({
    qId:Date.now()+Math.random(),
    targetId:id,type:type,
    name:info.name,
    isField:false,
    timeLeft:time,totalTime:time,
    targetLevel:1
  });
  closeModal();
  renderDorf2();
  updateUI();
}

// â”€â”€â”€ TROOP TRAINING MODAL â”€â”€â”€
function openTroopModal(buildingType){
  const tribeTroops=TROOPS[GS.tribe];
  const v=GS.villages[GS.activeVillage];
  const title_=document.getElementById('modalTitle');
  const body_=document.getElementById('modalBody');

  title_.textContent=buildingType==='barracks'?'âš”ï¸ KÄ±ÅŸla - Asker EÄŸit':'ğŸ´ AhÄ±r - SÃ¼vari EÄŸit';

  let html='';
  Object.entries(tribeTroops).forEach(([key,troop])=>{
    // Barracks = infantry (t1,t2,t3), Stable = cavalry (t4,t5)
    if(buildingType==='barracks'&&['t4','t5','ram','senator','chief','bey'].includes(key))return;
    if(buildingType==='stable'&&['t1','t2','t3'].includes(key))return;

    const canAfford=v.resources.wood>=troop.cost[0]&&v.resources.clay>=troop.cost[1]&&v.resources.iron>=troop.cost[2]&&v.resources.crop>=troop.cost[3];

    html+=`<div class="build-item">
      <div class="b-icon" style="background:rgba(200,160,80,0.1);font-size:1.5rem;">${troop.icon}</div>
      <div class="b-info">
        <div class="b-name">${troop.name}</div>
        <div class="b-desc">SaldÄ±rÄ±:${troop.att} | Savunma:${troop.defI}/${troop.defC} | HÄ±z:${troop.speed} | TaÅŸÄ±ma:${troop.carry}</div>
        <div class="b-costs">
          <div class="b-cost"><span class="res-dot wood"></span>${troop.cost[0]}</div>
          <div class="b-cost"><span class="res-dot clay"></span>${troop.cost[1]}</div>
          <div class="b-cost"><span class="res-dot iron"></span>${troop.cost[2]}</div>
          <div class="b-cost"><span class="res-dot crop"></span>${troop.cost[3]}</div>
          <div class="b-cost">â±ï¸${formatTime(Math.floor(troop.time/SPEED*10))}</div>
        </div>
      </div>
      <div class="b-action flex gap-1 items-center">
        <input type="number" id="train_${key}" value="1" min="1" max="100" style="width:60px;">
        <button class="btn btn-green btn-sm" onclick="trainTroops('${key}')">EÄŸit</button>
      </div>
    </div>`;
  });
  body_.innerHTML=html;
  document.getElementById('gameModal').classList.remove('hidden');
}

function trainTroops(troopKey){
  const v=GS.villages[GS.activeVillage];
  const troop=TROOPS[GS.tribe][troopKey];
  const countEl=document.getElementById('train_'+troopKey);
  let count=parseInt(countEl.value)||1;

  // Max affordable
  const maxW=Math.floor(v.resources.wood/troop.cost[0]);
  const maxC=Math.floor(v.resources.clay/troop.cost[1]);
  const maxI=Math.floor(v.resources.iron/troop.cost[2]);
  const maxR=Math.floor(v.resources.crop/troop.cost[3]);
  count=Math.min(count,maxW,maxC,maxI,maxR);
  if(count<=0){alert('Yetersiz kaynak!');return;}

  v.resources.wood-=troop.cost[0]*count;
  v.resources.clay-=troop.cost[1]*count;
  v.resources.iron-=troop.cost[2]*count;
  v.resources.crop-=troop.cost[3]*count;

  if(!v.troopQueue) v.troopQueue=[];
  v.troopQueue.push({
    type:troopKey,
    count:count,
    timeLeft:Math.floor(troop.time*count/SPEED*10),
    totalTime:Math.floor(troop.time*count/SPEED*10)
  });

  closeModal();
  addInfo(count+'x '+troop.name+' eÄŸitimi baÅŸladÄ±!','âš”ï¸');
  updateUI();
}

// â”€â”€â”€ ATTACK MODAL â”€â”€â”€
function openAttackModal(){
  const title_=document.getElementById('modalTitle');
  const body_=document.getElementById('modalBody');
  title_.textContent='âš”ï¸ SaldÄ±rÄ± GÃ¶nder';

  const v=GS.villages[GS.activeVillage];
  const tribeTroops=TROOPS[GS.tribe];

  let troopInputs='';
  Object.entries(v.troops).forEach(([k,count])=>{
    if(count>0&&tribeTroops[k]){
      troopInputs+=`<div class="flex items-center gap-2 mb-1">
        <span>${tribeTroops[k].icon} ${tribeTroops[k].name} (${count})</span>
        <input type="number" id="att_${k}" value="0" min="0" max="${count}" style="width:70px;">
      </div>`;
    }
  });

  if(!troopInputs){
    body_.innerHTML='<div class="queue-empty">SaldÄ±rÄ± gÃ¶nderecek askerin yok!</div>';
    document.getElementById('gameModal').classList.remove('hidden');
    return;
  }

  body_.innerHTML=`
    <div class="mb-2">
      <label class="fs-sm fw-700" style="color:var(--accent);">Hedef Koordinat:</label>
      <div class="flex gap-2 mt-1">
        <div>X: <input type="number" id="attX" value="0" style="width:70px;"></div>
        <div>Y: <input type="number" id="attY" value="0" style="width:70px;"></div>
      </div>
    </div>
    <hr class="divider">
    <div class="mb-2">
      <label class="fs-sm fw-700" style="color:var(--accent);">GÃ¶nderilecek Askerler:</label>
      <div class="mt-1">${troopInputs}</div>
    </div>
    <button class="btn btn-red btn-block" onclick="sendAttack()">âš”ï¸ SaldÄ±rÄ±ya GÃ¶nder!</button>
  `;
  document.getElementById('gameModal').classList.remove('hidden');
}

function sendAttack(){
  const v=GS.villages[GS.activeVillage];
  const x=parseInt(document.getElementById('attX').value)||0;
  const y=parseInt(document.getElementById('attY').value)||0;

  // Find target
  const target=GS.bots.find(b=>b.x===x&&b.y===y);
  if(!target){alert('Bu koordinatta kÃ¶y bulunamadÄ±!');return;}

  const troops={};
  let hasAny=false;
  const tribeTroops=TROOPS[GS.tribe];

  Object.entries(v.troops).forEach(([k,count])=>{
    const sendCount=parseInt(document.getElementById('att_'+k)?.value)||0;
    if(sendCount>0&&sendCount<=count){
      troops[k]=sendCount;
      v.troops[k]-=sendCount;
      hasAny=true;
    }
  });

  if(!hasAny){alert('En az 1 asker seÃ§melisin!');return;}

  // Calculate travel time
  const dist=Math.sqrt(Math.pow(v.x-x,2)+Math.pow(v.y-y,2));
  let minSpeed=Infinity;
  Object.entries(troops).forEach(([k])=>{
    if(tribeTroops[k]) minSpeed=Math.min(minSpeed,tribeTroops[k].speed);
  });
  const travelTime=Math.max(10,Math.floor(dist*100/(minSpeed*SPEED)));

  GS.troopMovements.push({
    type:'attack',
    troops:troops,
    targetId:target.id,
    villageId:v.id,
    fromX:v.x, fromY:v.y,
    timeLeft:travelTime,
    totalTime:travelTime
  });

  closeModal();
  addInfo('SaldÄ±rÄ± gÃ¶nderildi! VarÄ±ÅŸ: '+formatTime(travelTime),'âš”ï¸');
  updateUI();
}

// â”€â”€â”€ VIEW SWITCHING â”€â”€â”€
function showView(view){
  ['dorf1','dorf2','map','stats','reports','alliance'].forEach(v=>{
    document.getElementById('view-'+v).classList.toggle('hidden',v!==view);
    document.getElementById('nav-'+v)?.classList.toggle('active',v===view);
  });
  if(view==='stats') renderStats();
  if(view==='reports') renderReports();
  if(view==='alliance') renderAlliance();
  if(view==='map') setTimeout(()=>initMap(),100);
}

// â”€â”€â”€ WORLD MAP â”€â”€â”€
let mapInitialized=false;
function initMap(){
  if(mapInitialized) return;
  mapInitialized=true;
  const container=document.getElementById('mapContainer');
  const grid=document.getElementById('mapGrid');
  const cellSize=40;
  const visibleRange=25; // show -25 to +25 around player
  const v=GS.villages[GS.activeVillage];
  const centerX=v.x||0;
  const centerY=v.y||0;

  const viewRange=visibleRange;
  const gridSize=(viewRange*2+1)*cellSize;
  grid.style.width=gridSize+'px';
  grid.style.height=gridSize+'px';

  let html='';
  // Background terrain
  for(let dy=-viewRange;dy<=viewRange;dy++){
    for(let dx=-viewRange;dx<=viewRange;dx++){
      const wx=centerX+dx;
      const wy=centerY+dy;
      const px=(dx+viewRange)*cellSize;
      const py=(dy+viewRange)*cellSize;

      // Terrain coloring
      const noise=Math.sin(wx*0.3)*Math.cos(wy*0.3);
      const isForest=noise>0.5;
      const isMountain=noise<-0.6;
      const isWater=Math.sin(wx*0.1+wy*0.15)>0.85;
      let bg=isWater?'#4a90d9':isForest?'#3a7a15':isMountain?'#8a7a60':'#5a9a25';
      // Slight variation
      const vary=Math.floor(Math.sin(wx*7+wy*13)*8);
      html+=`<div class="map-cell" style="left:${px}px;top:${py}px;background:${bg};opacity:${0.85+Math.random()*0.15};" data-x="${wx}" data-y="${wy}">`;

      // Check for villages
      // Player village
      if(wx===v.x&&wy===v.y){
        html+=`<div class="map-village player" title="${v.name}" onclick="showVillageInfo(0,'player')">ğŸ </div>`;
      } else {
        const bot=GS.bots.find(b=>b.x===wx&&b.y===wy);
        if(bot){
          const cls='bot-'+bot.tribe.toLowerCase();
          const icon=bot.tribe==='Roman'?'ğŸ›ï¸':bot.tribe==='Teuton'?'ğŸª“':'ğŸ‡';
          html+=`<div class="map-village ${cls}" title="${bot.name} (${bot.tribe})" onclick="showVillageInfo(${bot.id},'bot')">${icon}</div>`;
        } else if(isWater){
          html+='<span style="font-size:0.6rem;opacity:0.5;">ğŸŒŠ</span>';
        } else if(isForest){
          html+='<span style="font-size:0.6rem;opacity:0.4;">ğŸŒ²</span>';
        } else if(isMountain){
          html+='<span style="font-size:0.6rem;opacity:0.4;">â›°ï¸</span>';
        }
      }
      html+=`</div>`;
    }
  }
  grid.innerHTML=html;

  // Center on player
  const playerPx=(viewRange)*cellSize;
  const playerPy=(viewRange)*cellSize;
  container.scrollLeft=playerPx-container.clientWidth/2;
  container.scrollTop=playerPy-container.clientHeight/2;

  // Drag to scroll
  container.onmousedown=function(e){
    mapDragState.dragging=true;
    mapDragState.startX=e.clientX;
    mapDragState.startY=e.clientY;
    mapDragState.scrollX=container.scrollLeft;
    mapDragState.scrollY=container.scrollTop;
    grid.style.cursor='grabbing';
  };
  document.onmousemove=function(e){
    if(!mapDragState.dragging)return;
    container.scrollLeft=mapDragState.scrollX-(e.clientX-mapDragState.startX);
    container.scrollTop=mapDragState.scrollY-(e.clientY-mapDragState.startY);
  };
  document.onmouseup=function(){
    mapDragState.dragging=false;
    grid.style.cursor='grab';
  };

  // Track coordinates
  container.onscroll=function(){
    const cx=Math.floor((container.scrollLeft+container.clientWidth/2)/cellSize)-viewRange+centerX;
    const cy=Math.floor((container.scrollTop+container.clientHeight/2)/cellSize)-viewRange+centerY;
    document.getElementById('mapCoordX').textContent=cx;
    document.getElementById('mapCoordY').textContent=cy;
  };
}

function mapGoto(){
  // Reset map and reinit
  mapInitialized=false;
  const x=parseInt(document.getElementById('mapGotoX').value)||0;
  const y=parseInt(document.getElementById('mapGotoY').value)||0;
  // We'll just scroll to approximate position
  initMap();
}

function showVillageInfo(id,type){
  const title_=document.getElementById('modalTitle');
  const body_=document.getElementById('modalBody');

  if(type==='player'){
    const v=GS.villages[0];
    title_.textContent='ğŸ  '+v.name;
    body_.innerHTML=`
      <div class="fs-sm">Koordinat: (${v.x}, ${v.y})</div>
      <div class="fs-sm">NÃ¼fus: ${GS.population}</div>
      <div class="fs-sm">Kabile: ${GS.tribe}</div>
      <div class="mt-2"><button class="btn btn-green btn-sm" onclick="closeModal();showView('dorf1')">KÃ¶ye Git</button></div>
    `;
  } else {
    const bot=GS.bots.find(b=>b.id===id);
    if(!bot)return;
    const alliance=bot.alliance!==null?GS.botAlliances.find(a=>a.id===bot.alliance):null;
    const tribeNames={Roman:'RomalÄ±lar',Teuton:'Cermenler',Turk:'TÃ¼rkler'};
    title_.textContent='ğŸ˜ï¸ '+bot.name;

    let troopHTML='';
    const tribeTroops=TROOPS[bot.tribe];
    Object.entries(bot.troops).forEach(([k,c])=>{
      if(c>0&&tribeTroops[k]) troopHTML+=`<div class="troop-row"><span class="troop-icon">${tribeTroops[k].icon}</span><div class="troop-info"><div class="troop-name">${tribeTroops[k].name}</div></div><span class="troop-count">~${Math.floor(c*0.7)}+</span></div>`;
    });

    body_.innerHTML=`
      <div class="flex gap-2 items-center mb-2"><span style="font-size:1.5rem;">${bot.tribe==='Roman'?'ğŸ›ï¸':bot.tribe==='Teuton'?'ğŸª“':'ğŸ‡'}</span><b>${tribeNames[bot.tribe]}</b></div>
      <div class="fs-sm mb-1">Koordinat: (${bot.x}, ${bot.y})</div>
      <div class="fs-sm mb-1">NÃ¼fus: ~${bot.pop}</div>
      ${alliance?`<div class="fs-sm mb-1">Ä°ttifak: ğŸ›¡ï¸ ${alliance.name}</div>`:''}
      <hr class="divider">
      <h4 style="font-size:0.9rem;">KeÅŸif Bilgisi (Tahmini):</h4>
      <div class="mt-1">${troopHTML||'<div class="fs-sm text-dim">Bilgi yok</div>'}</div>
      <hr class="divider">
      <div class="flex gap-2">
        <button class="btn btn-red btn-sm" onclick="closeModal();prefillAttack(${bot.x},${bot.y})">âš”ï¸ SaldÄ±r</button>
      </div>
    `;
  }
  document.getElementById('gameModal').classList.remove('hidden');
}

function prefillAttack(x,y){
  openAttackModal();
  setTimeout(()=>{
    const xEl=document.getElementById('attX');
    const yEl=document.getElementById('attY');
    if(xEl)xEl.value=x;
    if(yEl)yEl.value=y;
  },100);
}

// â”€â”€â”€ STATISTICS â”€â”€â”€
function renderStats(){
  const el=document.getElementById('statsContent');
  // Combine player + bots and sort by population
  let allPlayers=[{name:GS.playerName,tribe:GS.tribe,pop:GS.population,isPlayer:true,alliance:GS.alliance}];
  GS.bots.forEach(b=>{
    allPlayers.push({name:b.name,tribe:b.tribe,pop:b.pop,isPlayer:false,alliance:b.alliance!==null?GS.botAlliances.find(a=>a.id===b.alliance)?.name:null});
  });
  allPlayers.sort((a,b)=>b.pop-a.pop);

  let html='<table class="stats-table"><thead><tr><th>#</th><th>Oyuncu</th><th>Kabile</th><th>Ä°ttifak</th><th>NÃ¼fus</th></tr></thead><tbody>';
  allPlayers.slice(0,100).forEach((p,i)=>{
    const tribeIcons={Roman:'ğŸ›ï¸',Teuton:'ğŸª“',Turk:'ğŸ‡'};
    html+=`<tr style="${p.isPlayer?'background:rgba(255,215,0,0.1);font-weight:700;':''}">
      <td>${i+1}</td>
      <td>${tribeIcons[p.tribe]||''} ${p.name}${p.isPlayer?' â­':''}</td>
      <td>${p.tribe}</td>
      <td>${p.alliance||'-'}</td>
      <td>${p.pop}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}

function showStatTab(tab){
  document.querySelectorAll('#view-stats .tab-btn').forEach((b,i)=>{
    b.classList.toggle('active',
      (tab==='players'&&i===0)||(tab==='alliances'&&i===1)||(tab==='attackers'&&i===2));
  });
  const el=document.getElementById('statsContent');

  if(tab==='alliances'){
    let html='<table class="stats-table"><thead><tr><th>#</th><th>Ä°ttifak</th><th>Ãœye SayÄ±sÄ±</th><th>Toplam NÃ¼fus</th></tr></thead><tbody>';
    const sorted=[...GS.botAlliances].map(a=>{
      let totalPop=0;
      a.members.forEach(mid=>{
        const bot=GS.bots.find(b=>b.id===mid);
        if(bot) totalPop+=bot.pop;
      });
      return{...a,totalPop};
    }).sort((a,b)=>b.totalPop-a.totalPop);
    sorted.forEach((a,i)=>{
      html+=`<tr><td>${i+1}</td><td>ğŸ›¡ï¸ ${a.name}</td><td>${a.members.length}</td><td>${a.totalPop}</td></tr>`;
    });
    html+='</tbody></table>';
    el.innerHTML=html;
  } else if(tab==='attackers'){
    let attackers=[...GS.bots].sort((a,b)=>{
      const aAtt=Object.values(a.troops).reduce((s,c)=>s+c,0);
      const bAtt=Object.values(b.troops).reduce((s,c)=>s+c,0);
      return bAtt-aAtt;
    }).slice(0,50);

    let html='<table class="stats-table"><thead><tr><th>#</th><th>Oyuncu</th><th>Kabile</th><th>Asker GÃ¼cÃ¼</th></tr></thead><tbody>';
    attackers.forEach((b,i)=>{
      const total=Object.values(b.troops).reduce((s,c)=>s+c,0);
      html+=`<tr><td>${i+1}</td><td>${b.name}</td><td>${b.tribe}</td><td>${total}</td></tr>`;
    });
    html+='</tbody></table>';
    el.innerHTML=html;
  } else {
    renderStats();
  }
}

// â”€â”€â”€ REPORTS â”€â”€â”€
function renderReports(){
  const el=document.getElementById('reportsContent');
  if(!GS.reports||GS.reports.length===0){
    el.innerHTML='<div class="queue-empty" style="padding:30px;">HenÃ¼z rapor yok.</div>';
    return;
  }
  let html='';
  GS.reports.forEach((r,i)=>{
    const date=new Date(r.time);
    const timeStr=String(date.getHours()).padStart(2,'0')+':'+String(date.getMinutes()).padStart(2,'0');
    html+=`<div class="report-item" onclick="showReport(${i})">
      <div class="flex justify-between">
        <span class="r-result ${r.won?'win':'loss'}">${r.won?'âš”ï¸ Zafer':'ğŸ’€ Yenilgi'}</span>
        <span class="fs-sm" style="color:var(--text-dim)">${timeStr}</span>
      </div>
      <div class="fs-sm">Hedef: ${r.target} (${r.targetCoord.x},${r.targetCoord.y})</div>
      ${r.loot?`<div class="fs-sm text-green">YaÄŸma: ğŸªµ${r.loot.wood} ğŸ§±${r.loot.clay} â›ï¸${r.loot.iron} ğŸŒ¾${r.loot.crop}</div>`:''}
    </div>`;
  });
  el.innerHTML=html;
}

function showReport(idx){
  const r=GS.reports[idx];
  if(!r)return;
  const title_=document.getElementById('modalTitle');
  const body_=document.getElementById('modalBody');
  title_.textContent=(r.won?'âš”ï¸ Zafer':'ğŸ’€ Yenilgi')+' - '+r.target;

  let attLossHTML='';
  Object.entries(r.attLosses||{}).forEach(([k,c])=>{
    if(c>0) attLossHTML+=`<div class="fs-sm text-red">-${c} ${TROOPS[GS.tribe][k]?.name||k}</div>`;
  });

  body_.innerHTML=`
    <div class="mb-2"><b>Hedef:</b> ${r.target} (${r.targetCoord.x}, ${r.targetCoord.y})</div>
    <div class="mb-2"><b>SonuÃ§:</b> <span class="${r.won?'text-green':'text-red'}">${r.won?'ZAFER':'YENÄ°LGÄ°'}</span></div>
    ${r.loot?`<div class="mb-2"><b>YaÄŸma:</b> ğŸªµ${r.loot.wood} ğŸ§±${r.loot.clay} â›ï¸${r.loot.iron} ğŸŒ¾${r.loot.crop}</div>`:''}
    <hr class="divider">
    <div class="mb-1"><b>KayÄ±plarÄ±mÄ±z:</b></div>
    ${attLossHTML||'<div class="fs-sm text-green">KayÄ±p yok</div>'}
  `;
  document.getElementById('gameModal').classList.remove('hidden');
}

// â”€â”€â”€ ALLIANCE â”€â”€â”€
function renderAlliance(){
  const el=document.getElementById('allianceContent');
  const v=GS.villages[GS.activeVillage];
  const hasEmbassy=v.buildings.some(b=>b.type==='embassy'&&b.level>0);

  if(!hasEmbassy){
    el.innerHTML=`<div class="panel"><div class="panel-body text-center" style="padding:30px;">
      <div style="font-size:3rem;">ğŸ´</div>
      <h3 class="mt-2">ElÃ§ilik Gerekli</h3>
      <p class="fs-sm" style="color:var(--text-dim)">Ä°ttifak kurmak veya katÄ±lmak iÃ§in Ã¶nce ElÃ§ilik binasÄ± inÅŸa etmelisin.</p>
    </div></div>`;
    return;
  }

  if(!GS.alliance){
    // Show available alliances to join
    let html=`<div class="panel"><div class="panel-header">ğŸ›¡ï¸ Ä°ttifak Kur / KatÄ±l</div><div class="panel-body">
      <div class="mb-2">
        <input type="text" id="newAllianceName" placeholder="Ä°ttifak adÄ±..." style="width:100%;padding:8px;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;color:var(--text);">
        <button class="btn btn-green btn-block mt-1" onclick="createAlliance()">ğŸ›¡ï¸ Yeni Ä°ttifak Kur</button>
      </div>
      <hr class="divider">
      <h4 style="font-size:0.9rem;margin-bottom:8px;">Mevcut Ä°ttifaklar:</h4>`;

    GS.botAlliances.slice(0,10).forEach(a=>{
      html+=`<div class="flex justify-between items-center mb-1" style="padding:6px;border:1px solid var(--border);border-radius:4px;">
        <span class="fs-sm fw-700">ğŸ›¡ï¸ ${a.name} (${a.members.length} Ã¼ye)</span>
        <button class="btn btn-green btn-sm" onclick="joinAlliance(${a.id})">KatÄ±l</button>
      </div>`;
    });
    html+='</div></div>';
    el.innerHTML=html;
  } else {
    // Show alliance info
    const a=GS.alliance;
    let html=`<div class="panel"><div class="panel-header">ğŸ›¡ï¸ ${a.name}</div><div class="panel-body">
      <div class="mb-2 fs-sm">Ãœye SayÄ±sÄ±: <b>${a.members.length+1}</b></div>
      <h4 style="font-size:0.9rem;margin-bottom:8px;">Ãœyeler:</h4>
      <div class="alliance-member"><b>â­ ${GS.playerName} (Sen)</b><span>${GS.population} nÃ¼fus</span></div>`;

    a.members.forEach(mid=>{
      const bot=GS.bots.find(b=>b.id===mid);
      if(bot) html+=`<div class="alliance-member"><span>${bot.name}</span><span>${bot.pop} nÃ¼fus</span></div>`;
    });

    html+=`<hr class="divider"><button class="btn btn-red btn-sm" onclick="leaveAlliance()">Ä°ttifaktan AyrÄ±l</button>`;
    html+='</div></div>';
    el.innerHTML=html;
  }
}

function createAlliance(){
  const name=document.getElementById('newAllianceName')?.value?.trim();
  if(!name||name.length<2){alert('Ä°ttifak adÄ± gerekli!');return;}
  GS.alliance={name:name,members:[],created:Date.now()};
  addInfo('Ä°ttifak kuruldu: '+name,'ğŸ›¡ï¸');
  renderAlliance();
}

function joinAlliance(id){
  const a=GS.botAlliances.find(x=>x.id===id);
  if(!a)return;
  GS.alliance={name:a.name,members:a.members.slice(0,20),created:Date.now()};
  addInfo(a.name+' ittifakÄ±na katÄ±ldÄ±n!','ğŸ›¡ï¸');
  renderAlliance();
}

function leaveAlliance(){
  GS.alliance=null;
  addInfo('Ä°ttifaktan ayrÄ±ldÄ±n.','ğŸ›¡ï¸');
  renderAlliance();
}

// â”€â”€â”€ GOLD ACTIONS â”€â”€â”€
function goldAction(type){
  const v=GS.villages[GS.activeVillage];
  if(type==='finish'){
    if(v.buildQueue.length===0){alert('Kuyruk boÅŸ!');return;}
    if(!useGold(5))return;
    [...v.buildQueue].forEach(t=>completeConstruction(v,t));
    v.buildQueue=[];
    renderDorf1(); renderDorf2();
  } else if(type==='npc'){
    if(!useGold(3))return;
    const total=v.resources.wood+v.resources.clay+v.resources.iron+v.resources.crop;
    const avg=total/4;
    v.resources={wood:Math.min(v.warehouse,avg),clay:Math.min(v.warehouse,avg),iron:Math.min(v.warehouse,avg),crop:Math.min(v.granary,avg)};
  } else if(type==='boost'){
    if(!useGold(10))return;
    GS.prodBoostUntil=Date.now()+(24*3600*1000);
    addInfo('Ãœretim %25 arttÄ±rÄ±ldÄ±! (24 saat)','ğŸ“ˆ');
  }
  updateUI();
}

function useGold(amount){
  // Also check quiz gold
  const quizGold=parseInt(localStorage.getItem('yds_game_gold'))||0;
  if(quizGold>GS.gold) GS.gold=quizGold;
  if(GS.gold>=amount){
    GS.gold-=amount;
    localStorage.setItem('yds_game_gold',GS.gold);
    return true;
  }
  alert('Yeterli altÄ±nÄ±n yok! Test Ã§Ã¶zerek altÄ±n kazanmalÄ±sÄ±n. (Mevcut: '+GS.gold+')');
  return false;
}

// â”€â”€â”€ HELPERS â”€â”€â”€
function calcCost(baseCost,level){
  const mult=Math.pow(1.28,level);
  return baseCost.map(c=>Math.floor(c*mult));
}

function calcTime(baseTime,level,v){
  let time=Math.floor(baseTime*Math.pow(1.2,level));
  // Main building reduces time
  const mb=v.buildings.find(b=>b.type==='center');
  if(mb&&mb.level>1) time=Math.floor(time*(1-mb.level*0.03));
  return Math.max(5, Math.floor(time / SPEED * 10));
}

function formatTime(sec){
  sec=Math.max(0,Math.floor(sec));
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  const s=sec%60;
  if(h>0) return h+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

function formatNum(n){
  if(n>=1000000) return (n/1000000).toFixed(1)+'M';
  if(n>=10000) return (n/1000).toFixed(1)+'K';
  return n.toLocaleString('tr-TR');
}

function closeModal(){
  document.getElementById('gameModal').classList.add('hidden');
}

let infoMessages=[];
function addInfo(msg,icon='â„¹ï¸'){
  infoMessages.unshift({msg,icon,time:Date.now()});
  if(infoMessages.length>10) infoMessages.pop();
  const el=document.getElementById('infoBox');
  el.innerHTML=infoMessages.map(m=>`<div class="fs-sm mb-1">${m.icon} ${m.msg}</div>`).join('');
}

// â”€â”€â”€ KEYBOARD SHORTCUTS â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT')return;
  if(e.key==='1') showView('dorf1');
  if(e.key==='2') showView('dorf2');
  if(e.key==='3') showView('map');
  if(e.key==='4') showView('stats');
  if(e.key==='5') showView('reports');
  if(e.key==='Escape') closeModal();
});

// â”€â”€â”€ AUTO LOGIN CHECK â”€â”€â”€
window.addEventListener('load',()=>{
  // Check if already logged in
  const lastUser=localStorage.getItem('yds_last_user');
  if(lastUser){
    document.getElementById('loginUser').value=lastUser;
  }
});

// Save last user on login
const origLogin=doLogin;
doLogin=function(){
  origLogin();
  if(currentUser) localStorage.setItem('yds_last_user',currentUser);
};
const origRegister=doRegister;
doRegister=function(){
  origRegister();
  if(currentUser) localStorage.setItem('yds_last_user',currentUser);
};
</script>
</body>
</html>
