<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Fetih: Tam Strateji</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #2c3e50;
            --map-water: #34495e;
            --map-land: #ecf0f1;
            --map-hover: #bdc3c7;
            --p1-color: #3498db; /* Mavi */
            --p2-color: #e74c3c; /* KÄ±rmÄ±zÄ± */
            --gold: #f1c40f;
        }
        body { background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #map-container {
            width: 100%; height: 75vh;
            background-color: var(--map-water);
            border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        
        svg { width: 100%; height: 100%; display: block; }
        path {
            fill: var(--map-land) !important; stroke: #95a5a6; stroke-width: 1px;   
            transition: all 0.3s ease; cursor: pointer; vector-effect: non-scaling-stroke;
        }
        path:hover { fill: var(--map-hover) !important; stroke: white; stroke-width: 2px; z-index: 10; }
        
        .owned-p1 { fill: #85c1e9 !important; stroke: #fff; }
        .owned-p2 { fill: #ec7063 !important; stroke: #fff; }
        
        .game-header { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .player-card { background: rgba(0,0,0,0.8); border-radius: 10px; padding: 15px; min-width: 200px; border: 2px solid #555; pointer-events: auto; }
        .p1-card { border-color: var(--p1-color); }
        .p2-card { border-color: var(--p2-color); }

        .modal-content { background: #2c3e50; color: white; border: 1px solid #555; }
        .option-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 8px; background: #34495e; color: white; border: 1px solid #7f8c8d; transition: 0.2s; font-size: 1.1rem; }
        .option-btn:hover { background: #2c3e50; border-color: white; }
        .option-btn.selected { background: var(--gold); color: black; font-weight: bold; }
        .locked { pointer-events: none; opacity: 0.6; }

        #status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 10px 30px; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; border: 2px solid var(--gold);
            z-index: 100; display: none; white-space: nowrap;
        }
        
        .map-icon { transform-box: fill-box; transform-origin: center; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pulse-anim { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: translateX(-50%) scale(1.05); } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

<!-- GÄ°RÄ°Åž EKRANI -->
<div id="screen-lobby" class="container d-flex flex-column justify-content-center align-items-center vh-100">
    <h1 class="display-3 fw-bold text-warning mb-4"><i class="bi bi-geo-fill"></i> YDS FETÄ°H</h1>
    <div class="card bg-dark p-5 shadow-lg border-secondary" style="width: 400px;">
        <input type="text" id="player-name" class="form-control mb-3 text-center fw-bold fs-5" placeholder="Komutan AdÄ± Gir">
        <input type="text" id="room-id" class="form-control mb-3 text-center" placeholder="Oda Ä°smi (Ã–rn: fetih1)">
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" onclick="createGame()">ODA KUR (Host)</button>
            <button class="btn btn-outline-light" onclick="joinGame()">ODAYA KATIL (Misafir)</button>
        </div>
        <div id="lobby-status" class="mt-3 text-center text-info small fw-bold"></div>
    </div>
</div>

<!-- AYARLAR -->
<div id="screen-setup" class="container d-flex flex-column justify-content-center align-items-center vh-100 d-none">
    <div class="card bg-dark p-4 shadow-lg w-50 border-warning">
        <h3 class="text-warning text-center mb-4">SavaÅŸ KurallarÄ±</h3>
        <button class="btn btn-warning btn-lg w-100 mt-3" onclick="startGameConfig()">SAVAÅžI BAÅžLAT</button>
    </div>
</div>

<!-- OYUN EKRANI -->
<div id="screen-game" class="d-none">
    <div class="game-header">
        <div class="player-card p1-card">
            <h4 id="p1-name" style="color: var(--p1-color)">Mavi</h4>
            <div><i class="bi bi-building"></i> Puan: <span id="p1-score">0</span></div>
            <div><i class="bi bi-map-fill"></i> Ä°l: <span id="p1-cities">0</span></div>
            <div><i class="bi bi-heart-fill text-danger"></i> Kale CanÄ±: <span id="p1-hp">3</span></div>
        </div>
        <div class="player-card p2-card text-end">
            <h4 id="p2-name" style="color: var(--p2-color)">KÄ±rmÄ±zÄ±</h4>
            <div><span id="p2-score">0</span> :Puan <i class="bi bi-building"></i></div>
            <div><span id="p2-cities">0</span> :Ä°l <i class="bi bi-map-fill"></i></div>
            <div><span id="p2-hp">3</span> :Kale CanÄ± <i class="bi bi-heart-fill text-danger"></i></div>
        </div>
    </div>
    <div id="map-container"></div>
    <div id="status-bar" class="pulse-anim">Oyun BaÅŸlÄ±yor...</div>
</div>

<!-- SORU MODALI -->
<div class="modal fade" id="questionModal" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <span class="badge bg-warning text-dark fs-6" id="q-counter">Soru 1/10</span>
                <span class="badge bg-danger fs-5 ms-auto" id="q-timer">30</span>
            </div>
            <div class="modal-body p-4">
                <h4 class="text-center mb-4 lh-base" id="q-text">Soru metni...</h4>
                <div id="q-options"></div>
                <div id="wait-msg" class="text-center mt-3 text-info d-none">
                    <div class="spinner-border spinner-border-sm"></div> Rakip bekleniyor...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OYUN SONU -->
<div class="modal fade" id="resultModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5">
            <h1 id="winner-title" class="display-1 mb-3">ðŸ‘‘</h1>
            <h2 id="winner-name" class="fw-bold mb-3"></h2>
            <p id="winner-reason" class="lead text-muted"></p>
            <p id="winner-score-info" class="mb-0"></p>
            <button class="btn btn-primary mt-4" onclick="location.reload()">Ana MenÃ¼ye DÃ¶n</button>
        </div>
    </div>
</div>

<script>
    /* ================= AYARLAR & DATA ================= */
    const ICON_SIZE = 55; 
    const SVG_URL = './tr.svg'; 
    const ICONS = { CASTLE: './castle.svg', HOST_SOLDIER: './hostsoldier.svg', GUEST_SOLDIER: './questsoldier.svg' };
    
    // TÃœRKÄ°YE KOMÅžULUK HARÄ°TASI (Plaka KodlarÄ±)
    const NEIGHBORS = {
        1: [33, 51, 42, 07, 70], 2: [44, 21, 63, 27, 46], 3: [26, 42, 06, 18, 20, 32], 4: [25, 36, 76, 65, 13], 5: [60, 52, 58, 19],
        6: [18, 26, 42, 71, 40, 66, 14, 05, 19], 7: [33, 42, 32, 15, 48], 8: [53, 25, 61, 28], 9: [35, 45, 20, 48], 10: [17, 35, 45],
        11: [26, 16, 54, 41, 10, 43], 12: [23, 49, 21, 44, 24, 62], 13: [49, 04, 65, 56, 21], 14: [06, 26, 11, 54, 81, 67, 18], 15: [07, 32, 03, 20],
        16: [11, 41, 54, 10, 43], 17: [10, 59], 18: [06, 14, 37, 57, 19, 71], 19: [05, 55, 60, 66, 71, 18, 37], 20: [09, 45, 43, 03, 15, 48],
        21: [44, 23, 12, 13, 72, 47, 63, 02], 22: [39, 59, 17], 23: [44, 62, 12, 21], 24: [29, 61, 28, 58, 12, 62], 25: [08, 61, 24, 12, 49, 04, 36, 75, 58],
        26: [11, 06, 42, 03, 43, 14], 27: [46, 02, 63, 79, 80], 28: [52, 58, 24, 29, 61, 08], 29: [28, 61, 24], 30: [65, 73, 56],
        31: [80, 01], 32: [07, 15, 03, 42], 33: [07, 42, 51, 01], 34: [41, 59], 35: [10, 45, 09], 36: [75, 25, 04, 76],
        37: [57, 18, 19, 78], 38: [58, 66, 51, 01, 46, 60], 39: [22, 59], 40: [06, 71, 66], 41: [34, 54, 11, 16],
        42: [06, 26, 03, 32, 07, 33, 51, 68, 70], 43: [16, 11, 26, 03, 20, 45, 10], 44: [58, 24, 12, 21, 02, 46, 38], 45: [35, 10, 43, 20, 09],
        46: [38, 44, 02, 27, 80, 01, 58], 47: [72, 21, 63, 73], 48: [09, 20, 15, 07], 49: [25, 04, 13, 12, 21, 72], 50: [40, 66, 38, 51, 68],
        51: [38, 01, 33, 42, 68, 50], 52: [55, 60, 58, 28], 53: [08, 25, 61], 54: [41, 16, 11, 14, 81], 55: [57, 19, 05, 52, 60],
        56: [13, 65, 30, 73, 47, 72], 57: [37, 18, 19, 55], 58: [28, 52, 60, 38, 46, 44, 23, 12, 24, 25], 59: [22, 39, 34, 17], 60: [55, 52, 28, 58, 66, 19, 05],
        61: [53, 08, 25, 24, 29, 28], 62: [24, 12, 23], 63: [02, 21, 47, 27, 79], 64: [43, 03, 20, 45], 65: [04, 13, 56, 30],
        66: [19, 60, 58, 38, 50, 40, 71], 67: [14, 81, 78, 37], 68: [42, 51, 50, 40], 69: [29, 24, 28], 70: [42, 33, 07],
        71: [06, 18, 19, 66, 40], 72: [21, 13, 56, 47, 49], 73: [47, 56, 30, 65], 74: [67, 78, 37], 75: [36, 25],
        76: [36, 04], 77: [34, 16, 41], 78: [74, 37, 19, 14, 67], 79: [27, 63, 80], 80: [27, 46, 01, 31, 79], 81: [54, 14, 67]
    };

    let peer = null, conn = null, isHost = false, gameState = "LOBBY";
    let currentTurn = 0, timerInterval = null;
    let turnQueue = []; // Fetih sÄ±rasÄ±nÄ± tutan kuyruk: ['p1', 'p2'] gibi

    const questions = [
        { q: "She is interested ___ music.", opts: {A:'on',B:'in',C:'at',D:'for'}, ans: 'B' },
        { q: "He works ___ a bank.", opts: {A:'at',B:'on',C:'to',D:'by'}, ans: 'A' },
        { q: "I am afraid ___ dogs.", opts: {A:'from',B:'of',C:'by',D:'in'}, ans: 'B' },
        { q: "The book is ___ the table.", opts: {A:'in',B:'on',C:'at',D:'of'}, ans: 'B' },
        { q: "Capital of Turkey?", opts: {A:'Istanbul',B:'Ankara',C:'Izmir',D:'Bursa'}, ans: 'B' }
    ];

    let players = {
        p1: { name: "", base: null, cities: [], score: 0, hp: 3, id: 'p1', time: 0 },
        p2: { name: "", base: null, cities: [], score: 0, hp: 3, id: 'p2', time: 0 }
    };

    /* ================= PEERJS BAÄžLANTI ================= */
    function createGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "Mavi";
        if(!room) return alert("Oda ismi girin!");
        if(peer) peer.destroy();
        peer = new Peer(room, { debug: 2 });
        peer.on('open', id => { isHost = true; players.p1.name = name; document.getElementById('lobby-status').innerHTML = "Oda AÃ§Ä±ldÄ±! Bekleniyor..."; });
        peer.on('error', e => alert(e.type === 'unavailable-id' ? "Oda ismi dolu!" : e.type));
        peer.on('connection', c => { conn = c; setupConnection(); });
    }
    function joinGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "KÄ±rmÄ±zÄ±";
        if(!room) return alert("Oda ismi girin!");
        if(peer) peer.destroy();
        peer = new Peer();
        peer.on('open', id => { conn = peer.connect(room); isHost = false; players.p2.name = name; setupConnection(); });
    }
    function setupConnection() {
        conn.on('data', handleData);
        conn.on('open', () => {
            conn.send(isHost ? { type: 'INIT', p1Name: players.p1.name } : { type: 'JOIN', p2Name: players.p2.name });
        });
        if(conn.open) conn.send(isHost ? { type: 'INIT', p1Name: players.p1.name } : { type: 'JOIN', p2Name: players.p2.name });
    }

    /* ================= VERÄ° Ä°ÅžLEME ================= */
    function handleData(data) {
        if(data.type === 'INIT') { players.p1.name = data.p1Name; document.getElementById('lobby-status').innerText = "BaÄŸlandÄ±!"; }
        else if(data.type === 'JOIN') { players.p2.name = data.p2Name; goToSetup(); }
        else if(data.type === 'START_GAME') { players = data.players; startGameUI(); if(isHost) setTimeout(startNewTurn, 1000); }
        else if(data.type === 'UPDATE_MAP') { 
            players = data.players; 
            renderMapState(); 
            if(data.msg) showStatus(data.msg);
            
            // EÄŸer oyun BÄ°TTÄ°YSE (Can 0 olduysa)
            if(data.gameOver) return endGame(data.winner, data.reason, data.scores);

            if(isHost) checkTurnProgress(); 
            if(isHost && gameState === "BASE_SELECT") checkGameStart();
        }
        else if(data.type === 'NEW_TURN') { currentTurn = data.turnIndex; showQuestion(data.question); }
        else if(data.type === 'OPPONENT_ANSWER') { if(isHost) resolveTurn(data.ans, data.time); }
        else if(data.type === 'TURN_RESULT') { handleTurnResult(data); }
        else if(data.type === 'QUEUE_UPDATE') { 
            turnQueue = data.queue; 
            updateExpansionStatus(); 
        }
        else if(data.type === 'GAME_OVER') { endGame(data.winner, data.reason, data.scores); }
    }

    /* ================= OYUN MANTIÄžI ================= */
    function goToSetup() { document.getElementById('screen-lobby').classList.add('d-none'); document.getElementById('screen-setup').classList.remove('d-none'); }
    function startGameConfig() { conn.send({ type: 'START_GAME', players: players }); startGameUI(); }
    function startGameUI() {
        document.getElementById('screen-lobby').classList.add('d-none');
        document.getElementById('screen-setup').classList.add('d-none');
        document.getElementById('screen-game').classList.remove('d-none');
        loadSvgMap().then(() => { updateScoreboard(); showStatus("KALE ÅžEHRÄ°NÄ° SEÃ‡"); gameState = "BASE_SELECT"; });
    }

    /* ================= TUR VE SORU ================= */
    let myAnswer = null, myTime = 0, p2AnswerTemp = null, p2TimeTemp = 0;

    function startNewTurn() {
        if(currentTurn >= questions.length) return calculateFinalWinner("Soru Bitti");
        
        myAnswer = null; p2AnswerTemp = null; turnQueue = [];
        const q = questions[currentTurn];
        conn.send({ type: 'NEW_TURN', question: q, turnIndex: currentTurn });
        showQuestion(q);
    }

    function showQuestion(q) {
        const modal = new bootstrap.Modal(document.getElementById('questionModal'));
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('q-counter').innerText = `Soru ${currentTurn+1}`;
        let html = '';
        for(let key in q.opts) html += `<button class="option-btn" onclick="submitAnswer('${key}')"><b>${key})</b> ${q.opts[key]}</button>`;
        document.getElementById('q-options').innerHTML = html;
        document.getElementById('wait-msg').classList.add('d-none');
        modal.show();
        startTimer();
    }

    function startTimer() {
        let timeLeft = 30;
        document.getElementById('q-timer').innerText = timeLeft;
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--; document.getElementById('q-timer').innerText = timeLeft;
            if(timeLeft <= 0) { clearInterval(timerInterval); submitAnswer(null); }
        }, 1000);
    }

    function submitAnswer(ans) {
        if(timerInterval) clearInterval(timerInterval);
        const timestamp = Date.now();
        document.querySelectorAll('.option-btn').forEach(b => { b.classList.add('locked'); if(ans && b.innerText.startsWith(ans)) b.classList.add('selected'); });
        document.getElementById('wait-msg').classList.remove('d-none');
        
        const finalAns = ans || 'X';
        if(isHost) { myAnswer = finalAns; myTime = timestamp; checkTurnEnd(); }
        else conn.send({ type: 'OPPONENT_ANSWER', ans: finalAns, time: timestamp });
    }

    function resolveTurn(ans, time) { p2AnswerTemp = ans; p2TimeTemp = time; checkTurnEnd(); }

    function checkTurnEnd() {
        if(myAnswer && p2AnswerTemp) {
            const q = questions[currentTurn];
            const p1C = (myAnswer === q.ans);
            const p2C = (p2AnswerTemp === q.ans);
            
            // Puanlama
            if(p1C) players.p1.score += 100;
            if(p2C) players.p2.score += 100;

            // KUYRUK MANTIÄžI (Queue)
            turnQueue = [];
            if (p1C && p2C) {
                // Ä°kisi de doÄŸru: HÄ±zlÄ± olan Ã¶nce
                if (myTime <= p2TimeTemp) turnQueue = ['p1', 'p2'];
                else turnQueue = ['p2', 'p1'];
            } else if (p1C) {
                turnQueue = ['p1', 'p1']; // Sadece P1: 2 Hak
            } else if (p2C) {
                turnQueue = ['p2', 'p2']; // Sadece P2: 2 Hak
            }

            const data = { type: 'TURN_RESULT', p1Correct: p1C, p2Correct: p2C, queue: turnQueue, correct: q.ans, players: players };
            conn.send(data);
            handleTurnResult(data);
        }
    }

    function handleTurnResult(data) {
        bootstrap.Modal.getInstance(document.getElementById('questionModal')).hide();
        players = data.players;
        turnQueue = data.queue;
        updateScoreboard();
        gameState = "EXPANSION";

        if (turnQueue.length === 0) {
            showStatus("Kimse bilemedi! Yeni soru...");
            if(isHost) { currentTurn++; setTimeout(startNewTurn, 4000); }
        } else {
            updateExpansionStatus();
        }
    }

    function updateExpansionStatus() {
        const me = isHost ? 'p1' : 'p2';
        if (turnQueue.length > 0 && turnQueue[0] === me) {
            showStatus(`SIRA SENDE! (Kalan Hak: ${turnQueue.filter(x => x === me).length})`);
        } else if (turnQueue.length > 0) {
            showStatus(`SÄ±ra rakipte (${turnQueue[0] === 'p1' ? players.p1.name : players.p2.name})...`);
        } else {
            showStatus("Fetih bitti, bekleniyor...");
        }
    }

    /* ================= FETÄ°H VE SALDIRI MANTIÄžI ================= */
    function checkTurnProgress() {
        if (gameState !== "EXPANSION") return;
        if (turnQueue.length === 0) {
            gameState = "PLAYING"; currentTurn++;
            showStatus("Tur bitti! 5 sn sonra yeni soru...");
            setTimeout(startNewTurn, 5000);
        } else {
            conn.send({ type: 'QUEUE_UPDATE', queue: turnQueue });
        }
    }

    function claimCity(plate) {
        const me = isHost ? 'p1' : 'p2';
        const opp = isHost ? 'p2' : 'p1';

        // 1. SIRA KONTROLÃœ
        if (turnQueue.length === 0 || turnQueue[0] !== me) return showStatus("SÄ±ra sende deÄŸil!");

        // 2. KOMÅžULUK KONTROLÃœ
        if (!isAdjacent(plate, players[me].cities)) return alert("Sadece sahip olduÄŸun topraklara komÅŸu yerleri seÃ§ebilirsin!");

        // 3. EYLEM TÃœRÃœ BELÄ°RLEME
        
        // A) KALE SALDIRISI (Rakip Kale mi?)
        if (players[opp].base === plate) {
            players[opp].hp -= 1;
            turnQueue.shift(); // HakkÄ± kullan
            
            let msg = `KALE SALDIRISI! ${players[opp].name} 1 can kaybetti!`;
            if (players[opp].hp <= 0) {
                // OYUN BÄ°TTÄ° - KAZANAN BENÄ°M
                players[me].score += 500;
                msg = "KALE YIKILDI! ZAFER!";
                if(isHost) endGame(players[me].name, "Kale Ä°ÅŸgali", formatScores());
                else conn.send({ type: 'UPDATE_MAP', players: players, gameOver: true, winner: players[me].name, reason: "Kale Ä°ÅŸgali", scores: formatScores() });
            }
            syncMap(msg);
            return;
        }

        // B) TOPRAK Ã‡ALMA (Rakip topraÄŸÄ± mÄ±?)
        if (players[opp].cities.includes(plate)) {
            // Rakip listesinden Ã§Ä±kar
            players[opp].cities = players[opp].cities.filter(c => c !== plate);
            players[opp].score -= 150;
            // Kendine ekle
            players[me].cities.push(plate);
            players[me].score += 150;
            
            turnQueue.shift();
            syncMap(`${players[me].name} toprak Ã‡ALDI!`);
            return;
        }

        // C) NORMAL FETÄ°H (BoÅŸ mu?)
        if (!players.p1.cities.includes(plate) && !players.p2.cities.includes(plate)) {
            players[me].cities.push(plate);
            players[me].score += 50;
            turnQueue.shift();
            syncMap(`${players[me].name} fethetti!`);
            return;
        }
        
        alert("Bu ilde iÅŸlem yapamazsÄ±n!");
    }

    function isAdjacent(targetPlate, myCities) {
        // EÄŸer hiÃ§ ÅŸehrim yoksa (imkansÄ±z ama) false
        if (myCities.length === 0) return false;
        
        // KomÅŸuluk listesinden kontrol et
        // Hedef plakanÄ±n komÅŸularÄ± arasÄ±nda benim herhangi bir ÅŸehrim var mÄ±?
        const targetNeighbors = NEIGHBORS[targetPlate] || [];
        return targetNeighbors.some(n => myCities.includes(n));
    }

    function syncMap(msg) {
        renderMapState();
        conn.send({ type: 'UPDATE_MAP', players: players, msg: msg });
        if(msg) showStatus(msg);
        if(isHost) checkTurnProgress();
    }

    /* ================= HARÄ°TA ================= */
    async function loadSvgMap() {
        const wrapper = document.getElementById('map-container');
        const resp = await fetch(SVG_URL);
        wrapper.innerHTML = await resp.text();
        const svg = wrapper.querySelector('svg');
        svg.removeAttribute('width'); svg.removeAttribute('height'); svg.style.width='100%'; svg.style.height='100%';
        const grp = document.createElementNS("http://www.w3.org/2000/svg", "g"); grp.id = "icon-layer"; svg.appendChild(grp);

        svg.querySelectorAll('path').forEach(p => {
            let id = p.getAttribute('id') || p.parentElement.getAttribute('id');
            if(id && id.startsWith('TR')) {
                const pl = parseInt(id.replace('TR',''));
                p.setAttribute('id', `city-${pl}`); p.removeAttribute('fill'); p.removeAttribute('style');
                p.onclick = (e) => { e.stopPropagation(); onCityClick(pl); };
            }
        });
    }

    function renderMapState() {
        document.querySelectorAll('path').forEach(p => p.classList.remove('owned-p1', 'owned-p2'));
        document.getElementById('icon-layer').innerHTML = '';
        players.p1.cities.forEach(c => markCity(c, 'p1'));
        players.p2.cities.forEach(c => markCity(c, 'p2'));
        updateScoreboard();
    }

    function markCity(c, pid) {
        const el = document.getElementById(`city-${c}`);
        if(el) {
            el.classList.add(pid === 'p1' ? 'owned-p1' : 'owned-p2');
            const isBase = players[pid].base === c;
            const icon = isBase ? ICONS.CASTLE : (pid === 'p1' ? ICONS.HOST_SOLDIER : ICONS.GUEST_SOLDIER);
            drawIcon(c, icon);
        }
    }

    function drawIcon(c, url) {
        const p = document.getElementById(`city-${c}`);
        const layer = document.getElementById('icon-layer');
        if(!p || !layer) return;
        const b = p.getBBox();
        const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
        img.setAttributeNS(null, "href", url);
        img.setAttribute("x", b.x+b.width/2-ICON_SIZE/2); img.setAttribute("y", b.y+b.height/2-ICON_SIZE/2);
        img.setAttribute("width", ICON_SIZE); img.setAttribute("height", ICON_SIZE); img.classList.add("map-icon");
        layer.appendChild(img);
    }

    function onCityClick(plate) {
        if(gameState === "BASE_SELECT") {
            const me = isHost ? 'p1' : 'p2';
            const opp = isHost ? 'p2' : 'p1';
            if(players[me].base || players[opp].base === plate) return;
            players[me].base = plate; players[me].cities.push(plate);
            if(isHost) { syncMap("Mavi kale kurdu!"); checkGameStart(); }
            else { conn.send({ type: 'UPDATE_MAP', players: players, msg: "KÄ±rmÄ±zÄ± kale kurdu!" }); renderMapState(); }
        }
        else if(gameState === "EXPANSION") claimCity(plate);
    }

    function checkGameStart() {
        if(players.p1.base && players.p2.base) { gameState = "PLAYING"; setTimeout(startNewTurn, 1000); }
    }

    function updateScoreboard() {
        document.getElementById('p1-score').innerText = players.p1.score;
        document.getElementById('p1-cities').innerText = players.p1.cities.length;
        document.getElementById('p1-hp').innerText = players.p1.hp;
        document.getElementById('p2-score').innerText = players.p2.score;
        document.getElementById('p2-cities').innerText = players.p2.cities.length;
        document.getElementById('p2-hp').innerText = players.p2.hp;
    }
    
    function showStatus(msg) {
        const el = document.getElementById('status-bar'); el.innerText = msg; el.style.display = 'block';
    }

    function calculateFinalWinner(reason) {
        let winner = "Berabere", p1 = players.p1.score, p2 = players.p2.score;
        if(p1 > p2) winner = players.p1.name;
        else if(p2 > p1) winner = players.p2.name;
        
        const scores = formatScores();
        conn.send({ type: 'GAME_OVER', winner: winner, reason: reason, scores: scores });
        endGame(winner, reason, scores);
    }

    function formatScores() { return `${players.p1.name}: ${players.p1.score} - ${players.p2.name}: ${players.p2.score}`; }

    function endGame(winner, reason, scores) {
        document.getElementById('winner-name').innerText = "Kazanan: " + winner;
        document.getElementById('winner-reason').innerText = reason;
        document.getElementById('winner-score-info').innerText = scores;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
