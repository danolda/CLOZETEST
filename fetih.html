<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Fetih: Bil ve Fethet (Tam SÃ¼rÃ¼m)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #2c3e50;
            --map-water: #34495e;
            --map-land: #ecf0f1;
            --map-hover: #bdc3c7;
            --p1-color: #3498db; /* Mavi */
            --p2-color: #e74c3c; /* KÄ±rmÄ±zÄ± */
            --gold: #f1c40f;
        }
        body { background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* HARÄ°TA ALANI */
        #map-container {
            width: 100%;
            height: 75vh;
            background-color: var(--map-water);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        path {
            fill: var(--map-land);
            stroke: #7f8c8d;
            stroke-width: 0.5;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        path:hover {
            fill: var(--map-hover);
            transform: scale(1.005); /* Hafif bÃ¼yÃ¼me efekti */
            transform-origin: center;
        }

        /* SAHÄ°PLÄ°K RENKLERÄ° */
        .owned-p1 { fill: var(--p1-color) !important; stroke: #2980b9; }
        .owned-p2 { fill: var(--p2-color) !important; stroke: #c0392b; }
        
        /* MERKEZ (KALE) EFEKTÄ° */
        .base-city { 
            stroke: var(--gold) !important; 
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 5px var(--gold));
        }

        /* SKOR PANELÄ° */
        .game-header {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; z-index: 100;
            pointer-events: none; /* TÄ±klamayÄ± engellemesin */
        }
        .player-card {
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            border: 2px solid #555;
            pointer-events: auto;
        }
        .p1-card { border-color: var(--p1-color); }
        .p2-card { border-color: var(--p2-color); }

        /* MODALLAR */
        .modal-content { background: #2c3e50; color: white; border: 1px solid #555; }
        .option-btn {
            width: 100%; text-align: left; padding: 15px; margin-bottom: 8px;
            background: #34495e; color: white; border: 1px solid #7f8c8d;
            transition: 0.2s; font-size: 1.1rem;
        }
        .option-btn:hover { background: #2c3e50; border-color: white; }
        .option-btn.selected { background: var(--gold); color: black; font-weight: bold; }
        .locked { pointer-events: none; opacity: 0.6; }

        /* BÄ°LDÄ°RÄ°M Ã‡UBUÄžU */
        #status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid var(--gold);
            z-index: 100;
            display: none;
            white-space: nowrap;
        }
        
        .pulse-anim { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: translateX(-50%) scale(1.05); } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

<!-- GÄ°RÄ°Åž EKRANI -->
<div id="screen-lobby" class="container d-flex flex-column justify-content-center align-items-center vh-100">
    <h1 class="display-3 fw-bold text-warning mb-4"><i class="bi bi-geo-fill"></i> YDS FETÄ°H</h1>
    <div class="card bg-dark p-5 shadow-lg border-secondary" style="width: 400px;">
        <input type="text" id="player-name" class="form-control mb-3 text-center fw-bold fs-5" placeholder="Komutan AdÄ± Gir">
        <input type="text" id="room-id" class="form-control mb-3 text-center" placeholder="Oda Ä°smi (Ã–rn: fetih1)">
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" onclick="createGame()">ODA KUR (Host)</button>
            <button class="btn btn-outline-light" onclick="joinGame()">ODAYA KATIL (Misafir)</button>
        </div>
        <div id="lobby-status" class="mt-3 text-center text-info small fw-bold"></div>
    </div>
</div>

<!-- AYARLAR (Sadece Host) -->
<div id="screen-setup" class="container d-flex flex-column justify-content-center align-items-center vh-100 d-none">
    <div class="card bg-dark p-4 shadow-lg w-50 border-warning">
        <h3 class="text-warning text-center mb-4">SavaÅŸ KurallarÄ±</h3>
        <div class="mb-3">
            <label class="form-label text-white">Soru BaÅŸÄ±na DÃ¼ÅŸen Fetih SÃ¼resi (Saniye):</label>
            <input type="number" id="setup-time" class="form-control text-center fw-bold" value="30">
        </div>
        <div class="mb-3">
            <label class="form-label text-white">Toplam Soru SayÄ±sÄ±:</label>
            <select id="setup-count" class="form-select text-center fw-bold">
                <option value="5">5 Soru (HÄ±zlÄ±)</option>
                <option value="10" selected>10 Soru (Normal)</option>
                <option value="20">20 Soru (Uzun)</option>
            </select>
        </div>
        <button class="btn btn-warning btn-lg w-100 mt-3" onclick="startGameConfig()">SAVAÅžI BAÅžLAT</button>
    </div>
</div>

<!-- OYUN EKRANI -->
<div id="screen-game" class="d-none">
    <!-- Skorlar -->
    <div class="game-header">
        <div class="player-card p1-card">
            <h4 id="p1-name" style="color: var(--p1-color)">Mavi</h4>
            <div><i class="bi bi-building"></i> Puan: <span id="p1-score">0</span></div>
            <div><i class="bi bi-map-fill"></i> Ä°l SayÄ±sÄ±: <span id="p1-cities">0</span></div>
            <div><i class="bi bi-heart-fill text-danger"></i> Kale: <span id="p1-hp">3</span></div>
        </div>
        <div class="player-card p2-card text-end">
            <h4 id="p2-name" style="color: var(--p2-color)">KÄ±rmÄ±zÄ±</h4>
            <div><span id="p2-score">0</span> :Puan <i class="bi bi-building"></i></div>
            <div><span id="p2-cities">0</span> :Ä°l SayÄ±sÄ± <i class="bi bi-map-fill"></i></div>
            <div><span id="p2-hp">3</span> :Kale <i class="bi bi-heart-fill text-danger"></i></div>
        </div>
    </div>

    <!-- Harita -->
    <div id="map-container">
        <!-- SVG JS ile doldurulacak -->
    </div>

    <!-- Alt Bildirim -->
    <div id="status-bar" class="pulse-anim">
        Oyun BaÅŸlÄ±yor...
    </div>
</div>

<!-- SORU MODALI -->
<div class="modal fade" id="questionModal" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <span class="badge bg-warning text-dark fs-6" id="q-counter">Soru 1/10</span>
                <span class="badge bg-danger fs-5 ms-auto" id="q-timer">30</span>
            </div>
            <div class="modal-body p-4">
                <h4 class="text-center mb-4 lh-base" id="q-text">Soru metni buraya gelecek...</h4>
                <div id="q-options"></div>
                <div id="wait-msg" class="text-center mt-3 text-info d-none">
                    <div class="spinner-border spinner-border-sm"></div> Rakip bekleniyor...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OYUN SONU -->
<div class="modal fade" id="resultModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5">
            <h1 id="winner-title" class="display-1 mb-3">ðŸ‘‘</h1>
            <h2 id="winner-name" class="fw-bold mb-3"></h2>
            <p id="winner-reason" class="lead text-muted"></p>
            <button class="btn btn-primary mt-4" onclick="location.reload()">Ana MenÃ¼ye DÃ¶n</button>
        </div>
    </div>
</div>

<script>
/* ================= 1. TAM TÃœRKÄ°YE HARÄ°TASI (81 Ä°L SVG PATH) ================= */
// Bu koordinatlar 1050x600 boyutunda bir tuval (viewBox) iÃ§in ayarlanmÄ±ÅŸtÄ±r.

const mapPaths = {
    1: "M553,425 L558,418 L568,419 L575,425 L572,435 L560,445 L550,438 Z", // Adana
    2: "M635,375 L645,372 L655,378 L650,390 L638,392 L630,385 Z", // AdÄ±yaman
    3: "M285,275 L295,270 L305,275 L300,290 L288,292 L280,285 Z", // Afyon
    4: "M730,265 L745,260 L755,270 L750,285 L735,288 L725,275 Z", // AÄŸrÄ±
    5: "M535,235 L545,230 L555,240 L550,255 L538,258 L530,245 Z", // Amasya
    6: "M385,245 L405,240 L420,255 L410,280 L390,285 L375,265 Z", // Ankara
    7: "M285,365 L298,360 L310,370 L305,390 L285,395 L275,380 Z", // Antalya
    8: "M685,215 L700,210 L710,220 L705,235 L690,238 L680,225 Z", // Artvin
    9: "M145,345 L158,340 L170,350 L165,365 L148,368 L138,355 Z", // AydÄ±n
    10: "M135,275 L148,270 L160,280 L155,295 L138,298 L128,285 Z", // BalÄ±kesir
    11: "M255,225 L265,220 L275,230 L270,245 L258,248 L250,235 Z", // Bilecik
    12: "M665,315 L680,310 L690,320 L685,335 L670,338 L660,325 Z", // BingÃ¶l
    13: "M695,335 L710,330 L720,340 L715,355 L700,358 L690,345 Z", // Bitlis
    14: "M335,205 L350,200 L365,215 L355,235 L338,238 L328,220 Z", // Bolu
    15: "M265,345 L275,340 L285,350 L280,365 L268,368 L260,355 Z", // Burdur
    16: "M225,215 L245,210 L255,225 L245,245 L228,248 L218,230 Z", // Bursa
    17: "M65,235 L85,225 L100,245 L90,265 L70,260 L60,245 Z", // Ã‡anakkale
    18: "M415,205 L428,200 L440,210 L435,225 L418,228 L410,215 Z", // Ã‡ankÄ±rÄ±
    19: "M465,205 L485,200 L500,215 L490,235 L468,238 L458,220 Z", // Ã‡orum
    20: "M215,335 L230,330 L245,340 L240,355 L225,358 L210,345 Z", // Denizli
    21: "M625,345 L645,340 L660,355 L650,375 L630,378 L620,360 Z", // DiyarbakÄ±r
    22: "M65,165 L80,160 L90,175 L85,190 L70,192 L60,180 Z", // Edirne
    23: "M605,315 L620,310 L635,320 L630,335 L615,338 L600,325 Z", // ElazÄ±ÄŸ
    24: "M605,265 L625,260 L640,275 L630,295 L610,298 L600,280 Z", // Erzincan
    25: "M685,255 L710,250 L730,270 L715,300 L690,305 L675,280 Z", // Erzurum
    26: "M305,235 L320,230 L335,245 L325,265 L308,268 L298,250 Z", // EskiÅŸehir
    27: "M585,415 L598,410 L610,420 L605,435 L588,438 L578,425 Z", // Gaziantep
    28: "M585,215 L600,210 L615,220 L610,235 L595,238 L580,225 Z", // Giresun
    29: "M605,235 L615,230 L625,240 L620,255 L608,258 L600,245 Z", // GÃ¼mÃ¼ÅŸhane
    30: "M755,365 L770,360 L785,375 L775,395 L755,398 L745,380 Z", // Hakkari
    31: "M555,455 L565,450 L575,460 L570,475 L558,478 L550,465 Z", // Hatay
    32: "M285,325 L298,320 L310,330 L305,345 L288,348 L278,335 Z", // Isparta
    33: "M485,415 L505,410 L525,425 L515,450 L490,455 L475,435 Z", // Mersin
    34: "M195,175 L215,170 L230,185 L220,205 L200,208 L190,190 Z", // Ä°stanbul (DÃ¼zeltildi)
    35: "M95,305 L115,300 L130,315 L120,335 L100,338 L90,320 Z", // Ä°zmir
    36: "M765,215 L780,210 L795,225 L785,245 L768,248 L758,230 Z", // Kars
    37: "M435,175 L455,170 L470,185 L460,205 L440,208 L430,190 Z", // Kastamonu
    38: "M495,295 L515,290 L530,305 L520,325 L500,328 L485,310 Z", // Kayseri
    39: "M95,155 L110,150 L125,165 L115,180 L100,182 L90,170 Z", // KÄ±rklareli
    40: "M445,265 L458,260 L470,270 L465,285 L448,288 L438,275 Z", // KÄ±rÅŸehir
    41: "M245,185 L260,180 L275,195 L265,210 L250,212 L240,200 Z", // Kocaeli
    42: "M385,325 L415,315 L440,335 L425,370 L390,375 L375,350 Z", // Konya
    43: "M235,265 L250,260 L265,275 L255,290 L240,292 L230,280 Z", // KÃ¼tahya
    44: "M555,315 L570,310 L585,320 L580,335 L565,338 L550,325 Z", // Malatya
    45: "M145,295 L160,290 L175,305 L165,320 L150,322 L140,310 Z", // Manisa
    46: "M555,365 L570,360 L585,375 L575,395 L555,398 L545,380 Z", // K.MaraÅŸ
    47: "M665,375 L680,370 L695,380 L690,395 L675,398 L660,385 Z", // Mardin
    48: "M165,375 L180,370 L195,385 L185,405 L168,408 L158,390 Z", // MuÄŸla
    49: "M695,295 L710,290 L725,305 L715,320 L700,322 L690,310 Z", // MuÅŸ
    50: "M475,295 L488,290 L500,300 L495,315 L478,318 L468,305 Z", // NevÅŸehir
    51: "M485,365 L500,360 L515,375 L505,390 L488,392 L478,380 Z", // NiÄŸde
    52: "M535,205 L550,200 L565,215 L555,230 L538,232 L528,220 Z", // Ordu
    53: "M635,195 L650,190 L665,205 L655,220 L638,222 L628,210 Z", // Rize
    54: "M275,195 L290,190 L305,205 L295,220 L278,222 L268,210 Z", // Sakarya
    55: "M485,185 L505,180 L525,195 L515,215 L495,218 L480,200 Z", // Samsun
    56: "M695,355 L708,350 L720,360 L715,375 L698,378 L688,365 Z", // Siirt
    57: "M455,165 L470,160 L485,175 L475,190 L458,192 L448,180 Z", // Sinop
    58: "M535,275 L560,265 L585,285 L570,310 L545,315 L525,295 Z", // Sivas
    59: "M115,165 L130,160 L145,175 L135,190 L118,192 L108,180 Z", // TekirdaÄŸ
    60: "M515,235 L530,230 L545,245 L535,265 L518,268 L508,250 Z", // Tokat
    61: "M605,205 L620,200 L635,215 L625,230 L608,232 L598,220 Z", // Trabzon
    62: "M605,285 L618,280 L630,290 L625,305 L608,308 L598,295 Z", // Tunceli
    63: "M585,385 L605,380 L625,395 L615,415 L595,418 L580,400 Z", // ÅžanlÄ±urfa
    64: "M225,295 L238,290 L250,300 L245,315 L228,318 L218,305 Z", // UÅŸak
    65: "M755,305 L775,300 L795,315 L785,340 L760,345 L745,325 Z", // Van
    66: "M475,245 L495,240 L510,255 L500,275 L480,278 L470,260 Z", // Yozgat
    67: "M335,185 L350,180 L365,195 L355,210 L338,212 L328,200 Z", // Zonguldak
    68: "M455,335 L470,330 L485,345 L475,360 L458,362 L448,350 Z", // Aksaray
    69: "M625,245 L638,240 L650,250 L645,265 L628,268 L618,255 Z", // Bayburt
    70: "M435,375 L450,370 L465,385 L455,400 L438,402 L428,390 Z", // Karaman
    71: "M445,235 L455,230 L465,240 L460,255 L448,258 L440,245 Z", // KÄ±rÄ±kkale
    72: "M665,345 L678,340 L690,350 L685,365 L668,368 L658,355 Z", // Batman
    73: "M715,365 L730,360 L745,375 L735,390 L718,392 L708,380 Z", // ÅžÄ±rnak
    74: "M375,175 L390,170 L405,185 L395,200 L378,202 L368,190 Z", // BartÄ±n
    75: "M755,245 L768,240 L780,250 L775,265 L758,268 L748,255 Z", // Ardahan
    76: "M775,265 L788,260 L800,270 L795,285 L778,288 L768,275 Z", // IÄŸdÄ±r
    77: "M205,195 L215,190 L225,200 L220,210 L208,212 L202,205 Z", // Yalova
    78: "M365,195 L380,190 L395,205 L385,220 L368,222 L358,210 Z", // KarabÃ¼k
    79: "M535,425 L545,420 L555,430 L550,445 L538,448 L530,435 Z", // Kilis
    80: "M585,405 L598,400 L610,410 L605,425 L588,428 L578,415 Z", // Osmaniye
    81: "M305,205 L318,200 L330,210 L325,225 L308,228 L298,215 Z"  // DÃ¼zce
};
    


    /* ================= HARÄ°TA YÃœKLEME (GÃœNCELLENDÄ°) ================= */
function loadSvgMap() {
    const wrapper = document.getElementById('svg-wrapper');
    wrapper.innerHTML = '';
    
    // SVG OluÅŸtur
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 900 500"); // TÃœRKÄ°YE KOORDÄ°NAT SÄ°STEMÄ°NE UYGUN
    svg.style.width = "100%";
    svg.style.height = "100%";
    
    // 81 Ä°l Ã‡izimi
    for (let i = 1; i <= 81; i++) {
        const plate = i;
        const pathData = mapPaths[plate];
        
        if (pathData) {
            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", pathData);
            path.setAttribute("id", `city-${plate}`);
            path.setAttribute("class", "map-province");
            path.onclick = () => onCityClick(plate);
            
            // Tooltip
            const title = document.createElementNS(svgNS, "title");
            title.textContent = `Ä°l Plaka: ${plate}`;
            path.appendChild(title);
            
            svg.appendChild(path);
        }
    }
    
    wrapper.appendChild(svg);
    console.log("Harita baÅŸarÄ±yla yÃ¼klendi.");
}
    
    function getProvincePath(plate) {
        if(mapPaths[plate]) return mapPaths[plate];
        
        // EÄŸer gerÃ§ek harita datasÄ± yoksa, harita Ã¼zerinde rastgele bir yerde bir kare Ã§iz.
        // Bu sadece demo'da oyunun Ã§Ã¶kmemesi iÃ§indir. GerÃ§ekte mapPaths full dolu olmalÄ±.
        const x = (plate % 10) * 90 + 50;
        const y = Math.floor(plate / 10) * 50 + 50;
        return `M${x},${y} h40 v40 h-40 z`; 
    }

    /* ================= 2. OYUN SÄ°STEMÄ° ================= */
    let peer = null;
    let conn = null;
    let isHost = false;
    let gameState = "LOBBY"; 
    let currentTurn = 0;
    
    // Sorular (Manuel ekle veya LocalStorage'dan Ã§ek)
    const questions = [
        { q: "She is interested ___ music.", opts: {A:'on',B:'in',C:'at',D:'for',E:'with'}, ans: 'B' },
        { q: "He works ___ a bank.", opts: {A:'at',B:'on',C:'to',D:'by',E:'of'}, ans: 'A' },
        { q: "I am afraid ___ dogs.", opts: {A:'from',B:'of',C:'by',D:'in',E:'at'}, ans: 'B' },
        // ... Demo sorular
    ];

    let players = {
        p1: { name: "", base: null, cities: [], score: 0, hp: 3, id: 'p1', color: 'var(--p1-color)' },
        p2: { name: "", base: null, cities: [], score: 0, hp: 3, id: 'p2', color: 'var(--p2-color)' }
    };

    let expansionTimer = null;

    /* ================= 3. BAÄžLANTI (PEERJS) ================= */
    function createGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "Mavi";
        if(!room) return alert("Oda ismi girin!");

        peer = new Peer(room);
        peer.on('open', id => {
            isHost = true;
            players.p1.name = name;
            document.getElementById('lobby-status').innerHTML = `<span class="text-success">Oda AÃ§Ä±ldÄ±! Rakip Bekleniyor...</span>`;
        });
        peer.on('connection', c => {
            conn = c;
            setupConnection();
        });
    }

    function joinGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "KÄ±rmÄ±zÄ±";
        if(!room) return alert("Oda ismi girin!");

        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(room);
            isHost = false;
            players.p2.name = name;
            setupConnection();
        });
    }

    function setupConnection() {
        conn.on('open', () => {
            if(isHost) {
                conn.send({ type: 'INIT', p1Name: players.p1.name });
            } else {
                conn.send({ type: 'JOIN', p2Name: players.p2.name });
            }
        });

        conn.on('data', handleData);
    }

    function handleData(data) {
        if(data.type === 'INIT') {
            players.p1.name = data.p1Name;
            document.getElementById('lobby-status').innerText = "BaÄŸlandÄ±!";
        }
        else if(data.type === 'JOIN') {
            players.p2.name = data.p2Name;
            goToSetup();
        }
        else if(data.type === 'START_GAME') {
    players = data.players;
    startGameUI();
    // EÄŸer Host ise oyunu baÅŸlatma emrini o verir
    if (isHost) {
        setTimeout(startNewTurn, 1000);
    }
}
        else if(data.type === 'UPDATE_MAP') {
            players = data.players;
            renderMapState();
            if(data.msg) showStatus(data.msg);
        }
        else if(data.type === 'NEW_TURN') {
            currentTurn = data.turnIndex;
            showQuestion(data.question);
        }
        else if(data.type === 'OPPONENT_ANSWER') {
            // Sadece Host iÅŸler
            if(isHost) resolveTurn(data.ans, 'p2'); 
        }
        else if(data.type === 'TURN_RESULT') {
            handleTurnResult(data);
        }
        else if(data.type === 'EXPANSION_START') {
            startExpansion(data.winner);
        }
        else if(data.type === 'GAME_OVER') {
            endGame(data.winner, data.reason);
        }
    }

    /* ================= 4. OYUN AKIÅžI ================= */
    function goToSetup() {
        document.getElementById('screen-lobby').classList.add('d-none');
        document.getElementById('screen-setup').classList.remove('d-none');
    }

    function startGameConfig() {
        // GerÃ§ekte burada sorularÄ± havuzdan seÃ§eriz
        conn.send({ type: 'START_GAME', players: players });
        startGameUI();
    }

    function startGameUI() {
        document.getElementById('screen-lobby').classList.add('d-none');
        document.getElementById('screen-setup').classList.add('d-none');
        document.getElementById('screen-game').classList.remove('d-none');
        
        renderMap();
        updateScoreboard();
        showStatus("KALE ÅžEHRÄ°NÄ° SEÃ‡ (Haritaya TÄ±kla)");
        gameState = "BASE_SELECT";
    }

    /* ================= 5. HARÄ°TA MANTIÄžI ================= */
    function renderMap() {
        const container = document.getElementById('map-container');
        container.innerHTML = '';
        
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("viewBox", "0 0 1000 500");

        for(let i=1; i<=81; i++) {
            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", getProvincePath(i)); // YukarÄ±daki fonksiyon
            path.setAttribute("id", `city-${i}`);
            path.onclick = () => onCityClick(i);
            
            // Ä°l AdÄ± Tooltip
            const title = document.createElementNS(svgNS, "title");
            title.textContent = `Ä°l Plaka: ${i}`;
            path.appendChild(title);
            
            svg.appendChild(path);
        }
        container.appendChild(svg);
    }

    function renderMapState() {
        // Temizle
        document.querySelectorAll('path').forEach(p => p.classList.remove('owned-p1', 'owned-p2', 'base-city'));

        players.p1.cities.forEach(c => {
            const el = document.getElementById(`city-${c}`);
            if(el) {
                el.classList.add('owned-p1');
                if(players.p1.base === c) el.classList.add('base-city');
            }
        });

        players.p2.cities.forEach(c => {
            const el = document.getElementById(`city-${c}`);
            if(el) {
                el.classList.add('owned-p2');
                if(players.p2.base === c) el.classList.add('base-city');
            }
        });
        
        updateScoreboard();
    }

    function onCityClick(plate) {
        if(gameState === "BASE_SELECT") {
            selectBase(plate);
        } else if(gameState === "EXPANSION") {
            claimCity(plate);
        }
    }

    function selectBase(plate) {
        const me = isHost ? 'p1' : 'p2';
        
        // Zaten seÃ§tiyse Ã§Ä±k
        if(players[me].base) return;
        // Rakibin kalesiyse Ã§Ä±k (Host kontrolÃ¼)
        if(players[isHost?'p2':'p1'].base === plate) return;

        players[me].base = plate;
        players[me].cities.push(plate);

        // GÃ¼ncelle ve GÃ¶nder
        if(isHost) {
            syncMap("Mavi kalesini kurdu!");
            checkGameStart();
        } else {
            // Guest seÃ§imini Host'a bildirir
            // Host bunu handleData -> UPDATE_MAP ile geri yollar
            // Bu basit versiyonda Guest direkt kendi state'ini gÃ¼ncelliyor gibi gÃ¶rÃ¼nÃ¼p Host'a atÄ±yoruz.
            // Ama senkronizasyon iÃ§in Host'a Ã¶zel bir mesaj atÄ±p onun daÄŸÄ±tmasÄ± daha doÄŸru.
            // Pratik Ã§Ã¶zÃ¼m:
            conn.send({ type: 'UPDATE_MAP', players: players, msg: "KÄ±rmÄ±zÄ± kalesini kurdu!" });
            renderMapState(); // Kendimde de gÃ¶ster
        }
    }

    function checkGameStart() {
        if(players.p1.base && players.p2.base) {
            gameState = "PLAYING";
            setTimeout(() => startNewTurn(), 1000);
        }
    }

    function syncMap(msg) {
        renderMapState();
        conn.send({ type: 'UPDATE_MAP', players: players, msg: msg });
        if(msg) showStatus(msg);
    }

    /* ================= 6. SORU VE TUR MANTIÄžI ================= */
    let myAnswer = null;
    let p2AnswerTemp = null; // Host'ta tutulur

    function startNewTurn() {
        if(currentTurn >= questions.length) return endGame("Berabere", "Sorular bitti!");
        
        const q = questions[currentTurn];
        myAnswer = null;
        p2AnswerTemp = null;

        // Herkese soruyu gÃ¶nder
        const payload = { type: 'NEW_TURN', question: q, turnIndex: currentTurn };
        conn.send(payload);
        showQuestion(q);
    }

    function showQuestion(q) {
        const modal = new bootstrap.Modal(document.getElementById('questionModal'));
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('q-counter').innerText = `Soru ${currentTurn+1}`;
        
        let html = '';
        for(let key in q.opts) {
            html += `<button class="option-btn" onclick="submitAnswer('${key}')"><b>${key})</b> ${q.opts[key]}</button>`;
        }
        document.getElementById('q-options').innerHTML = html;
        document.getElementById('wait-msg').classList.add('d-none');
        
        modal.show();
    }

    function submitAnswer(ans) {
        // UI Kilitle
        document.querySelectorAll('.option-btn').forEach(b => {
            b.classList.add('locked');
            if(b.innerText.startsWith(ans)) b.classList.add('selected');
        });
        document.getElementById('wait-msg').classList.remove('d-none');

        if(isHost) {
            myAnswer = ans;
            checkTurnEnd();
        } else {
            conn.send({ type: 'OPPONENT_ANSWER', ans: ans });
        }
    }

    // Sadece Host Ã§alÄ±ÅŸtÄ±rÄ±r
    function resolveTurn(p2Ans, playerKey) {
        if(playerKey === 'p2') p2AnswerTemp = p2Ans;
        checkTurnEnd();
    }

    function checkTurnEnd() {
        if(myAnswer && p2AnswerTemp) {
            // Ä°kisi de cevapladÄ±
            const q = questions[currentTurn];
            const p1Correct = (myAnswer === q.ans);
            const p2Correct = (p2AnswerTemp === q.ans);
            
            // Puan Ver
            if(p1Correct) players.p1.score += 100;
            if(p2Correct) players.p2.score += 100;

            let winner = null;
            if(p1Correct && !p2Correct) winner = 'p1';
            else if(p2Correct && !p1Correct) winner = 'p2';
            
            const resultData = { 
                type: 'TURN_RESULT', 
                p1Correct, p2Correct, winner, 
                correct: q.ans,
                players: players 
            };
            
            conn.send(resultData);
            handleTurnResult(resultData);
        }
    }

    function handleTurnResult(data) {
        // ModalÄ± Kapat
        bootstrap.Modal.getInstance(document.getElementById('questionModal')).hide();
        
        // PuanlarÄ± GÃ¼ncelle
        players = data.players;
        updateScoreboard();

        if(data.winner) {
            // Kazanan Fetih Yapar
            if(isHost) {
                // Host, herkese fetih emri gÃ¶nderir
                const payload = { type: 'EXPANSION_START', winner: data.winner };
                conn.send(payload);
                startExpansion(data.winner);
            }
        } else {
            // Berabere ise yeni soru
            showStatus("Tur Berabere! Yeni soru geliyor...");
            if(isHost) {
                currentTurn++;
                setTimeout(startNewTurn, 2000);
            }
        }
    }

    /* ================= 7. FETÄ°H (GENÄ°ÅžLEME) ================= */
    function startExpansion(winnerKey) {
        gameState = "EXPANSION";
        const winnerName = players[winnerKey].name;
        
        // Bu istemci kazanan mÄ±?
        const amIWinner = (isHost && winnerKey === 'p1') || (!isHost && winnerKey === 'p2');

        if(amIWinner) {
            showStatus(`TEBRÄ°KLER! Fethetmek iÃ§in bir ile tÄ±kla! (30sn)`);
            // SayaÃ§ baÅŸlatÄ±labilir...
        } else {
            showStatus(`${winnerName} fetih yapÄ±yor... Bekle.`);
        }
    }

    function claimCity(plate) {
        // Sadece sÄ±rasÄ± gelen (kazanan) tÄ±klayabilir
        // Basitlik iÃ§in: Her tÄ±klandÄ±ÄŸÄ±nda Host kontrol etsin.
        
        const me = isHost ? 'p1' : 'p2';
        
        // Ä°l zaten dolu mu?
        if(players.p1.cities.includes(plate) || players.p2.cities.includes(plate)) {
            // EÄŸer dÃ¼ÅŸman kalesiyse saldÄ±rÄ± olabilir (Basit versiyonda engelliyoruz)
            return alert("Bu il zaten dolu!");
        }

        // KomÅŸu mu? (Basitlik iÃ§in her yeri alabilir yapÄ±yorum, komÅŸuluk algoritmasÄ± uzun)
        // Normalde: checkNeighbor() kullanÄ±lmalÄ±.
        
        players[me].cities.push(plate);
        players[me].score += 50;

        if(isHost) {
            syncMap(`${players.p1.name} bir il fethetti!`);
            endExpansion();
        } else {
            // Guest hamlesini bildirir
            conn.send({ type: 'UPDATE_MAP', players: players, msg: `${players.p2.name} bir il fethetti!` });
            renderMapState();
            // Host bunu alÄ±nca turu bitirir (ama Guest'in bitirme yetkisi yok, Host timeout ile yapmalÄ±)
            // Biz burada Guest'in de haritayÄ± gÃ¼ncellediÄŸini varsayÄ±yoruz.
        }
    }
    
    // Host tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
    function endExpansion() {
        gameState = "PLAYING";
        currentTurn++;
        setTimeout(startNewTurn, 1000);
    }

    /* ================= YARDIMCI ================= */
    function showStatus(msg) {
        const el = document.getElementById('status-bar');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }

    function updateScoreboard() {
        document.getElementById('p1-score').innerText = players.p1.score;
        document.getElementById('p1-cities').innerText = players.p1.cities.length;
        document.getElementById('p2-score').innerText = players.p2.score;
        document.getElementById('p2-cities').innerText = players.p2.cities.length;
    }

    function endGame(winner, reason) {
        document.getElementById('winner-name').innerText = winner || "Oyun Bitti";
        document.getElementById('winner-reason').innerText = reason;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
