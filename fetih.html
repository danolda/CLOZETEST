<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Fetih: Bil ve Fethet (Tam SÃ¼rÃ¼m)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #2c3e50;
            --map-water: #34495e;
            --map-land: #ecf0f1;
            --map-hover: #bdc3c7;
            --p1-color: #3498db; /* Mavi */
            --p2-color: #e74c3c; /* KÄ±rmÄ±zÄ± */
            --gold: #f1c40f;
        }
        body { background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* HARÄ°TA ALANI */
        #map-container {
            width: 100%;
            height: 75vh;
            background-color: var(--map-water);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* --- HARÄ°TA GÃ–RÃœNÃœMÃœ --- */
        #map-container svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); /* Haritaya gÃ¶lge ver */
        }
        
        path {
            fill: var(--map-land) !important; 
            stroke: #5e6b6f;       /* Ä°LLER ARASI SINIR RENGÄ° (Koyu Gri) */
            stroke-width: 1.5px;   /* SINIR KALINLIÄžI (Bunu artÄ±rÄ±rsan sÄ±nÄ±rlar kalÄ±nlaÅŸÄ±r) */
            transition: all 0.3s ease;
            cursor: pointer;
            vector-effect: non-scaling-stroke; /* Zoom yapÄ±nca Ã§izgiler bozulmasÄ±n */
        }
        
        path:hover {
            fill: var(--map-hover) !important;
            stroke: white;         /* Ãœzerine gelince sÄ±nÄ±r beyaz olsun */
            stroke-width: 2px;
            z-index: 10;           /* Ã–ne Ã§Ä±kar */
        }
        
        /* SAHÄ°PLÄ°K RENKLERÄ° */
        .owned-p1 { fill: var(--p1-color) !important; stroke: #fff; }
        .owned-p2 { fill: var(--p2-color) !important; stroke: #fff; }
        
        /* KALE EFEKTÄ° */
        .base-city { 
            stroke: var(--gold) !important; 
            stroke-width: 4px !important;
            stroke-dasharray: 5, 5; /* Kesik Ã§izgi efekti */
        }
        /* SKOR PANELÄ° */
        .game-header {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; z-index: 100;
            pointer-events: none; /* TÄ±klamayÄ± engellemesin */
        }
        .player-card {
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            border: 2px solid #555;
            pointer-events: auto;
        }
        .p1-card { border-color: var(--p1-color); }
        .p2-card { border-color: var(--p2-color); }

        /* MODALLAR */
        .modal-content { background: #2c3e50; color: white; border: 1px solid #555; }
        .option-btn {
            width: 100%; text-align: left; padding: 15px; margin-bottom: 8px;
            background: #34495e; color: white; border: 1px solid #7f8c8d;
            transition: 0.2s; font-size: 1.1rem;
        }
        .option-btn:hover { background: #2c3e50; border-color: white; }
        .option-btn.selected { background: var(--gold); color: black; font-weight: bold; }
        .locked { pointer-events: none; opacity: 0.6; }

        /* BÄ°LDÄ°RÄ°M Ã‡UBUÄžU */
        #status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 10px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid var(--gold);
            z-index: 100;
            display: none;
            white-space: nowrap;
        }
        
        .pulse-anim { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: translateX(-50%) scale(1.05); } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

<!-- GÄ°RÄ°Åž EKRANI -->
<div id="screen-lobby" class="container d-flex flex-column justify-content-center align-items-center vh-100">
    <h1 class="display-3 fw-bold text-warning mb-4"><i class="bi bi-geo-fill"></i> YDS FETÄ°H</h1>
    <div class="card bg-dark p-5 shadow-lg border-secondary" style="width: 400px;">
        <input type="text" id="player-name" class="form-control mb-3 text-center fw-bold fs-5" placeholder="Komutan AdÄ± Gir">
        <input type="text" id="room-id" class="form-control mb-3 text-center" placeholder="Oda Ä°smi (Ã–rn: fetih1)">
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" onclick="createGame()">ODA KUR (Host)</button>
            <button class="btn btn-outline-light" onclick="joinGame()">ODAYA KATIL (Misafir)</button>
        </div>
        <div id="lobby-status" class="mt-3 text-center text-info small fw-bold"></div>
    </div>
</div>

<!-- AYARLAR (Sadece Host) -->
<div id="screen-setup" class="container d-flex flex-column justify-content-center align-items-center vh-100 d-none">
    <div class="card bg-dark p-4 shadow-lg w-50 border-warning">
        <h3 class="text-warning text-center mb-4">SavaÅŸ KurallarÄ±</h3>
        <div class="mb-3">
            <label class="form-label text-white">Soru BaÅŸÄ±na DÃ¼ÅŸen Fetih SÃ¼resi (Saniye):</label>
            <input type="number" id="setup-time" class="form-control text-center fw-bold" value="30">
        </div>
        <div class="mb-3">
            <label class="form-label text-white">Toplam Soru SayÄ±sÄ±:</label>
            <select id="setup-count" class="form-select text-center fw-bold">
                <option value="5">5 Soru (HÄ±zlÄ±)</option>
                <option value="10" selected>10 Soru (Normal)</option>
                <option value="20">20 Soru (Uzun)</option>
            </select>
        </div>
        <button class="btn btn-warning btn-lg w-100 mt-3" onclick="startGameConfig()">SAVAÅžI BAÅžLAT</button>
    </div>
</div>

<!-- OYUN EKRANI -->
<div id="screen-game" class="d-none">
    <!-- Skorlar -->
    <div class="game-header">
        <div class="player-card p1-card">
            <h4 id="p1-name" style="color: var(--p1-color)">Mavi</h4>
            <div><i class="bi bi-building"></i> Puan: <span id="p1-score">0</span></div>
            <div><i class="bi bi-map-fill"></i> Ä°l SayÄ±sÄ±: <span id="p1-cities">0</span></div>
            <div><i class="bi bi-heart-fill text-danger"></i> Kale: <span id="p1-hp">3</span></div>
        </div>
        <div class="player-card p2-card text-end">
            <h4 id="p2-name" style="color: var(--p2-color)">KÄ±rmÄ±zÄ±</h4>
            <div><span id="p2-score">0</span> :Puan <i class="bi bi-building"></i></div>
            <div><span id="p2-cities">0</span> :Ä°l SayÄ±sÄ± <i class="bi bi-map-fill"></i></div>
            <div><span id="p2-hp">3</span> :Kale <i class="bi bi-heart-fill text-danger"></i></div>
        </div>
    </div>

    <!-- Harita -->
    <div id="map-container">
        <!-- SVG JS ile doldurulacak -->
    </div>

    <!-- Alt Bildirim -->
    <div id="status-bar" class="pulse-anim">
        Oyun BaÅŸlÄ±yor...
    </div>
</div>

<!-- SORU MODALI -->
<div class="modal fade" id="questionModal" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <span class="badge bg-warning text-dark fs-6" id="q-counter">Soru 1/10</span>
                <span class="badge bg-danger fs-5 ms-auto" id="q-timer">30</span>
            </div>
            <div class="modal-body p-4">
                <h4 class="text-center mb-4 lh-base" id="q-text">Soru metni buraya gelecek...</h4>
                <div id="q-options"></div>
                <div id="wait-msg" class="text-center mt-3 text-info d-none">
                    <div class="spinner-border spinner-border-sm"></div> Rakip bekleniyor...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OYUN SONU -->
<div class="modal fade" id="resultModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5">
            <h1 id="winner-title" class="display-1 mb-3">ðŸ‘‘</h1>
            <h2 id="winner-name" class="fw-bold mb-3"></h2>
            <p id="winner-reason" class="lead text-muted"></p>
            <button class="btn btn-primary mt-4" onclick="location.reload()">Ana MenÃ¼ye DÃ¶n</button>
        </div>
    </div>
</div>

<script>


    


/* ================= HARÄ°TA YÃœKLEME (Ä°L SINIRLI VERSÄ°YON) ================= */
async function loadSvgMap() {
    const wrapper = document.getElementById('map-container');
    wrapper.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100 text-warning"><div class="spinner-border me-3"></div> Harita HazÄ±rlanÄ±yor...</div>';
    
    // KAYNAK: Bu haritada 81 il ayrÄ± path olarak tanÄ±mlÄ±dÄ±r.
    const mapUrl = 'https://raw.githubusercontent.com/alperenunal/Turkey-Map-SVG/master/turkey-map.svg';

    try {
        const response = await fetch(mapUrl);
        if (!response.ok) throw new Error("Harita sunucudan Ã§ekilemedi.");
        
        let svgText = await response.text();
        
        // SVG'yi temizle ve yerleÅŸtir
        wrapper.innerHTML = svgText;
        const svg = wrapper.querySelector('svg');
        
        // BoyutlandÄ±rma ayarlarÄ±
        svg.removeAttribute('width');
        svg.removeAttribute('height');
        svg.style.width = '100%';
        svg.style.height = '100%';

        // Path (Ä°l) Ä°ÅŸlemleri
        const paths = svg.querySelectorAll('path');
        
        paths.forEach(path => {
            // Bu SVG kaynaÄŸÄ±nda ID'ler plaka koduyla gelir (Ã–rn: id="01" veya id="TR-01")
            // Veya path class'larÄ±nda plaka yazar.
            
            let rawId = path.getAttribute('id') || path.getAttribute('data-plaka');
            
            // EÄŸer ID yoksa parent elementten (g) almaya Ã§alÄ±ÅŸ (bazÄ± svglerde gruplama vardÄ±r)
            if (!rawId && path.parentElement.tagName === 'g') {
                rawId = path.parentElement.getAttribute('id') || path.parentElement.getAttribute('data-plaka');
            }

            // ID'yi temizle (TR-01 -> 1 veya 01 -> 1)
            let plate = null;
            if (rawId) {
                // Sadece sayÄ±larÄ± al
                const match = rawId.match(/(\d+)/);
                if (match) {
                    plate = parseInt(match[0], 10);
                }
            }

            if (plate && plate > 0 && plate <= 81) {
                // Oyuna uygun ID ata
                path.setAttribute('id', `city-${plate}`);
                
                // VarsayÄ±lan renkleri sil (CSS kontrol etsin)
                path.removeAttribute('fill');
                path.removeAttribute('style');
                path.setAttribute('class', 'map-province'); // CSS sÄ±nÄ±fÄ± ekle
                
                // TÄ±klama olayÄ±
                path.onclick = (e) => {
                    // SVG tÄ±klamalarÄ±nda bazen event yayÄ±lmasÄ± (propagation) olur, durduralÄ±m
                    e.stopPropagation();
                    onCityClick(plate);
                };

                // Tooltip (Ä°l AdÄ±)
                // Bu SVG'de genellikle title tag'i yoktur, data-name attribute'u olabilir.
                let cityName = path.getAttribute('data-name') || path.parentElement.getAttribute('data-name') || `Ä°l ${plate}`;
                
                // Varolan title varsa sil, yenisini ekle
                const oldTitle = path.querySelector('title');
                if(oldTitle) oldTitle.remove();

                const titleEl = document.createElementNS("http://www.w3.org/2000/svg", "title");
                titleEl.textContent = `${cityName} (Plaka: ${plate})`;
                path.appendChild(titleEl);
            }
        });

        console.log("Harita ve il sÄ±nÄ±rlarÄ± baÅŸarÄ±yla yÃ¼klendi.");

    } catch (error) {
        console.error(error);
        wrapper.innerHTML = `<div class="text-danger text-center mt-5"><h3>Harita YÃ¼klenemedi</h3><p>${error.message}</p></div>`;
    }
}
    
    function getProvincePath(plate) {
        if(mapPaths[plate]) return mapPaths[plate];
        
        // EÄŸer gerÃ§ek harita datasÄ± yoksa, harita Ã¼zerinde rastgele bir yerde bir kare Ã§iz.
        // Bu sadece demo'da oyunun Ã§Ã¶kmemesi iÃ§indir. GerÃ§ekte mapPaths full dolu olmalÄ±.
        const x = (plate % 10) * 90 + 50;
        const y = Math.floor(plate / 10) * 50 + 50;
        return `M${x},${y} h40 v40 h-40 z`; 
    }

    /* ================= 2. OYUN SÄ°STEMÄ° ================= */
    let peer = null;
    let conn = null;
    let isHost = false;
    let gameState = "LOBBY"; 
    let currentTurn = 0;
    
    // Sorular (Manuel ekle veya LocalStorage'dan Ã§ek)
    const questions = [
        { q: "She is interested ___ music.", opts: {A:'on',B:'in',C:'at',D:'for',E:'with'}, ans: 'B' },
        { q: "He works ___ a bank.", opts: {A:'at',B:'on',C:'to',D:'by',E:'of'}, ans: 'A' },
        { q: "I am afraid ___ dogs.", opts: {A:'from',B:'of',C:'by',D:'in',E:'at'}, ans: 'B' },
        // ... Demo sorular
    ];

    let players = {
        p1: { name: "", base: null, cities: [], score: 0, hp: 3, id: 'p1', color: 'var(--p1-color)' },
        p2: { name: "", base: null, cities: [], score: 0, hp: 3, id: 'p2', color: 'var(--p2-color)' }
    };

    let expansionTimer = null;

    /* ================= 3. BAÄžLANTI (PEERJS) ================= */
    function createGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "Mavi";
        if(!room) return alert("Oda ismi girin!");

        peer = new Peer(room);
        peer.on('open', id => {
            isHost = true;
            players.p1.name = name;
            document.getElementById('lobby-status').innerHTML = `<span class="text-success">Oda AÃ§Ä±ldÄ±! Rakip Bekleniyor...</span>`;
        });
        peer.on('connection', c => {
            conn = c;
            setupConnection();
        });
    }

    function joinGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "KÄ±rmÄ±zÄ±";
        if(!room) return alert("Oda ismi girin!");

        peer = new Peer();
        peer.on('open', id => {
            conn = peer.connect(room);
            isHost = false;
            players.p2.name = name;
            setupConnection();
        });
    }

    function setupConnection() {
        conn.on('open', () => {
            if(isHost) {
                conn.send({ type: 'INIT', p1Name: players.p1.name });
            } else {
                conn.send({ type: 'JOIN', p2Name: players.p2.name });
            }
        });

        conn.on('data', handleData);
    }

    function handleData(data) {
        if(data.type === 'INIT') {
            players.p1.name = data.p1Name;
            document.getElementById('lobby-status').innerText = "BaÄŸlandÄ±!";
        }
        else if(data.type === 'JOIN') {
            players.p2.name = data.p2Name;
            goToSetup();
        }
        else if(data.type === 'START_GAME') {
    players = data.players;
    startGameUI();
    // EÄŸer Host ise oyunu baÅŸlatma emrini o verir
    if (isHost) {
        setTimeout(startNewTurn, 1000);
    }
}
        else if(data.type === 'UPDATE_MAP') {
            players = data.players;
            renderMapState();
            if(data.msg) showStatus(data.msg);
        }
        else if(data.type === 'NEW_TURN') {
            currentTurn = data.turnIndex;
            showQuestion(data.question);
        }
        else if(data.type === 'OPPONENT_ANSWER') {
            // Sadece Host iÅŸler
            if(isHost) resolveTurn(data.ans, 'p2'); 
        }
        else if(data.type === 'TURN_RESULT') {
            handleTurnResult(data);
        }
        else if(data.type === 'EXPANSION_START') {
            startExpansion(data.winner);
        }
        else if(data.type === 'GAME_OVER') {
            endGame(data.winner, data.reason);
        }
    }

    /* ================= 4. OYUN AKIÅžI ================= */
    function goToSetup() {
        document.getElementById('screen-lobby').classList.add('d-none');
        document.getElementById('screen-setup').classList.remove('d-none');
    }

    function startGameConfig() {
        // GerÃ§ekte burada sorularÄ± havuzdan seÃ§eriz
        conn.send({ type: 'START_GAME', players: players });
        startGameUI();
    }

function startGameUI() {
    document.getElementById('screen-lobby').classList.add('d-none');
    document.getElementById('screen-setup').classList.add('d-none');
    document.getElementById('screen-game').classList.remove('d-none');
    
    loadSvgMap(); // <--- BURASI DEÄžÄ°ÅžTÄ° (Eskiden renderMap() idi)
    
    updateScoreboard();
    showStatus("KALE ÅžEHRÄ°NÄ° SEÃ‡ (Haritaya TÄ±kla)");
    gameState = "BASE_SELECT";
}

    /* ================= 5. HARÄ°TA MANTIÄžI ================= */
    function renderMap() {
        const container = document.getElementById('map-container');
        container.innerHTML = '';
        
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("viewBox", "0 0 1000 500");

        for(let i=1; i<=81; i++) {
            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", getProvincePath(i)); // YukarÄ±daki fonksiyon
            path.setAttribute("id", `city-${i}`);
            path.onclick = () => onCityClick(i);
            
            // Ä°l AdÄ± Tooltip
            const title = document.createElementNS(svgNS, "title");
            title.textContent = `Ä°l Plaka: ${i}`;
            path.appendChild(title);
            
            svg.appendChild(path);
        }
        container.appendChild(svg);
    }

    function renderMapState() {
        // Temizle
        document.querySelectorAll('path').forEach(p => p.classList.remove('owned-p1', 'owned-p2', 'base-city'));

        players.p1.cities.forEach(c => {
            const el = document.getElementById(`city-${c}`);
            if(el) {
                el.classList.add('owned-p1');
                if(players.p1.base === c) el.classList.add('base-city');
            }
        });

        players.p2.cities.forEach(c => {
            const el = document.getElementById(`city-${c}`);
            if(el) {
                el.classList.add('owned-p2');
                if(players.p2.base === c) el.classList.add('base-city');
            }
        });
        
        updateScoreboard();
    }

    function onCityClick(plate) {
        if(gameState === "BASE_SELECT") {
            selectBase(plate);
        } else if(gameState === "EXPANSION") {
            claimCity(plate);
        }
    }

    function selectBase(plate) {
        const me = isHost ? 'p1' : 'p2';
        
        // Zaten seÃ§tiyse Ã§Ä±k
        if(players[me].base) return;
        // Rakibin kalesiyse Ã§Ä±k (Host kontrolÃ¼)
        if(players[isHost?'p2':'p1'].base === plate) return;

        players[me].base = plate;
        players[me].cities.push(plate);

        // GÃ¼ncelle ve GÃ¶nder
        if(isHost) {
            syncMap("Mavi kalesini kurdu!");
            checkGameStart();
        } else {
            // Guest seÃ§imini Host'a bildirir
            // Host bunu handleData -> UPDATE_MAP ile geri yollar
            // Bu basit versiyonda Guest direkt kendi state'ini gÃ¼ncelliyor gibi gÃ¶rÃ¼nÃ¼p Host'a atÄ±yoruz.
            // Ama senkronizasyon iÃ§in Host'a Ã¶zel bir mesaj atÄ±p onun daÄŸÄ±tmasÄ± daha doÄŸru.
            // Pratik Ã§Ã¶zÃ¼m:
            conn.send({ type: 'UPDATE_MAP', players: players, msg: "KÄ±rmÄ±zÄ± kalesini kurdu!" });
            renderMapState(); // Kendimde de gÃ¶ster
        }
    }

    function checkGameStart() {
        if(players.p1.base && players.p2.base) {
            gameState = "PLAYING";
            setTimeout(() => startNewTurn(), 1000);
        }
    }

    function syncMap(msg) {
        renderMapState();
        conn.send({ type: 'UPDATE_MAP', players: players, msg: msg });
        if(msg) showStatus(msg);
    }

    /* ================= 6. SORU VE TUR MANTIÄžI ================= */
    let myAnswer = null;
    let p2AnswerTemp = null; // Host'ta tutulur

    function startNewTurn() {
        if(currentTurn >= questions.length) return endGame("Berabere", "Sorular bitti!");
        
        const q = questions[currentTurn];
        myAnswer = null;
        p2AnswerTemp = null;

        // Herkese soruyu gÃ¶nder
        const payload = { type: 'NEW_TURN', question: q, turnIndex: currentTurn };
        conn.send(payload);
        showQuestion(q);
    }

    function showQuestion(q) {
        const modal = new bootstrap.Modal(document.getElementById('questionModal'));
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('q-counter').innerText = `Soru ${currentTurn+1}`;
        
        let html = '';
        for(let key in q.opts) {
            html += `<button class="option-btn" onclick="submitAnswer('${key}')"><b>${key})</b> ${q.opts[key]}</button>`;
        }
        document.getElementById('q-options').innerHTML = html;
        document.getElementById('wait-msg').classList.add('d-none');
        
        modal.show();
    }

    function submitAnswer(ans) {
        // UI Kilitle
        document.querySelectorAll('.option-btn').forEach(b => {
            b.classList.add('locked');
            if(b.innerText.startsWith(ans)) b.classList.add('selected');
        });
        document.getElementById('wait-msg').classList.remove('d-none');

        if(isHost) {
            myAnswer = ans;
            checkTurnEnd();
        } else {
            conn.send({ type: 'OPPONENT_ANSWER', ans: ans });
        }
    }

    // Sadece Host Ã§alÄ±ÅŸtÄ±rÄ±r
    function resolveTurn(p2Ans, playerKey) {
        if(playerKey === 'p2') p2AnswerTemp = p2Ans;
        checkTurnEnd();
    }

    function checkTurnEnd() {
        if(myAnswer && p2AnswerTemp) {
            // Ä°kisi de cevapladÄ±
            const q = questions[currentTurn];
            const p1Correct = (myAnswer === q.ans);
            const p2Correct = (p2AnswerTemp === q.ans);
            
            // Puan Ver
            if(p1Correct) players.p1.score += 100;
            if(p2Correct) players.p2.score += 100;

            let winner = null;
            if(p1Correct && !p2Correct) winner = 'p1';
            else if(p2Correct && !p1Correct) winner = 'p2';
            
            const resultData = { 
                type: 'TURN_RESULT', 
                p1Correct, p2Correct, winner, 
                correct: q.ans,
                players: players 
            };
            
            conn.send(resultData);
            handleTurnResult(resultData);
        }
    }

    function handleTurnResult(data) {
        // ModalÄ± Kapat
        bootstrap.Modal.getInstance(document.getElementById('questionModal')).hide();
        
        // PuanlarÄ± GÃ¼ncelle
        players = data.players;
        updateScoreboard();

        if(data.winner) {
            // Kazanan Fetih Yapar
            if(isHost) {
                // Host, herkese fetih emri gÃ¶nderir
                const payload = { type: 'EXPANSION_START', winner: data.winner };
                conn.send(payload);
                startExpansion(data.winner);
            }
        } else {
            // Berabere ise yeni soru
            showStatus("Tur Berabere! Yeni soru geliyor...");
            if(isHost) {
                currentTurn++;
                setTimeout(startNewTurn, 2000);
            }
        }
    }

    /* ================= 7. FETÄ°H (GENÄ°ÅžLEME) ================= */
    function startExpansion(winnerKey) {
        gameState = "EXPANSION";
        const winnerName = players[winnerKey].name;
        
        // Bu istemci kazanan mÄ±?
        const amIWinner = (isHost && winnerKey === 'p1') || (!isHost && winnerKey === 'p2');

        if(amIWinner) {
            showStatus(`TEBRÄ°KLER! Fethetmek iÃ§in bir ile tÄ±kla! (30sn)`);
            // SayaÃ§ baÅŸlatÄ±labilir...
        } else {
            showStatus(`${winnerName} fetih yapÄ±yor... Bekle.`);
        }
    }

    function claimCity(plate) {
        // Sadece sÄ±rasÄ± gelen (kazanan) tÄ±klayabilir
        // Basitlik iÃ§in: Her tÄ±klandÄ±ÄŸÄ±nda Host kontrol etsin.
        
        const me = isHost ? 'p1' : 'p2';
        
        // Ä°l zaten dolu mu?
        if(players.p1.cities.includes(plate) || players.p2.cities.includes(plate)) {
            // EÄŸer dÃ¼ÅŸman kalesiyse saldÄ±rÄ± olabilir (Basit versiyonda engelliyoruz)
            return alert("Bu il zaten dolu!");
        }

        // KomÅŸu mu? (Basitlik iÃ§in her yeri alabilir yapÄ±yorum, komÅŸuluk algoritmasÄ± uzun)
        // Normalde: checkNeighbor() kullanÄ±lmalÄ±.
        
        players[me].cities.push(plate);
        players[me].score += 50;

        if(isHost) {
            syncMap(`${players.p1.name} bir il fethetti!`);
            endExpansion();
        } else {
            // Guest hamlesini bildirir
            conn.send({ type: 'UPDATE_MAP', players: players, msg: `${players.p2.name} bir il fethetti!` });
            renderMapState();
            // Host bunu alÄ±nca turu bitirir (ama Guest'in bitirme yetkisi yok, Host timeout ile yapmalÄ±)
            // Biz burada Guest'in de haritayÄ± gÃ¼ncellediÄŸini varsayÄ±yoruz.
        }
    }
    
    // Host tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
    function endExpansion() {
        gameState = "PLAYING";
        currentTurn++;
        setTimeout(startNewTurn, 1000);
    }

    /* ================= YARDIMCI ================= */
    function showStatus(msg) {
        const el = document.getElementById('status-bar');
        el.innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }

    function updateScoreboard() {
        document.getElementById('p1-score').innerText = players.p1.score;
        document.getElementById('p1-cities').innerText = players.p1.cities.length;
        document.getElementById('p2-score').innerText = players.p2.score;
        document.getElementById('p2-cities').innerText = players.p2.cities.length;
    }

    function endGame(winner, reason) {
        document.getElementById('winner-name').innerText = winner || "Oyun Bitti";
        document.getElementById('winner-reason').innerText = reason;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
