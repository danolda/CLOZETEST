<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Fetih: Tam Strateji</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #2c3e50;
            --map-water: #34495e;
            --map-land: #ecf0f1;
            --map-hover: #bdc3c7;
            --p1-color: #3498db; /* Mavi */
            --p2-color: #e74c3c; /* KÄ±rmÄ±zÄ± */
            --gold: #f1c40f;
        }
        body { background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #map-container {
            width: 100%; height: 75vh;
            background-color: var(--map-water);
            border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        
        svg { width: 100%; height: 100%; display: block; }
        path {
            fill: var(--map-land) !important; stroke: #95a5a6; stroke-width: 1px;   
            transition: all 0.3s ease; cursor: pointer; vector-effect: non-scaling-stroke;
        }
        path:hover { fill: var(--map-hover) !important; stroke: white; stroke-width: 2px; z-index: 10; }
        
        .owned-p1 { fill: #85c1e9 !important; stroke: #fff; }
        .owned-p2 { fill: #ec7063 !important; stroke: #fff; }
        
        .game-header { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .player-card { background: rgba(0,0,0,0.8); border-radius: 10px; padding: 15px; min-width: 200px; border: 2px solid #555; pointer-events: auto; }
        .p1-card { border-color: var(--p1-color); }
        .p2-card { border-color: var(--p2-color); }

        .modal-content { background: #2c3e50; color: white; border: 1px solid #555; }
        .option-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 8px; background: #34495e; color: white; border: 1px solid #7f8c8d; transition: 0.2s; font-size: 1.1rem; }
        .option-btn:hover { background: #2c3e50; border-color: white; }
        .option-btn.selected { background: var(--gold); color: black; font-weight: bold; }
        .locked { pointer-events: none; opacity: 0.6; }

        #status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 10px 30px; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; border: 2px solid var(--gold);
            z-index: 100; display: none; white-space: nowrap;
        }
        
        .map-icon { transform-box: fill-box; transform-origin: center; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pulse-anim { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: translateX(-50%) scale(1.05); } 100% { opacity: 0.8; } }

        /* --- CEVAP RENKLENDÄ°RME --- */
        .btn-p1 { background-color: var(--p1-color) !important; color: white !important; }
        .btn-p2 { background-color: var(--p2-color) !important; color: white !important; }
        /* Ä°kisi aynÄ± ÅŸÄ±kkÄ± seÃ§erse yarÄ±sÄ± mavi yarÄ±sÄ± kÄ±rmÄ±zÄ± */
        .btn-both { 
            background: linear-gradient(90deg, var(--p1-color) 50%, var(--p2-color) 50%) !important; 
            color: white !important; text-shadow: 1px 1px 2px black;
        }
        /* DoÄŸru cevap yeÅŸil Ã§erÃ§eve */
        .btn-correct { 
            border: 4px solid #2ecc71 !important; 
            box-shadow: 0 0 15px #2ecc71; 
            transform: scale(1.02);
        }
        
        /* Setup EkranÄ± Stilleri */
        .setup-card { max-width: 700px; margin: auto; }
        .category-checkbox { cursor: pointer; padding: 10px; border-radius: 5px; transition: 0.2s; }
        .category-checkbox:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<!-- GÄ°RÄ°Åž EKRANI -->
<div id="screen-lobby" class="container d-flex flex-column justify-content-center align-items-center vh-100">
    <h1 class="display-3 fw-bold text-warning mb-4"><i class="bi bi-geo-fill"></i> YDS FETÄ°H</h1>
    <div class="card bg-dark p-5 shadow-lg border-secondary" style="width: 400px;">
        <input type="text" id="player-name" class="form-control mb-3 text-center fw-bold fs-5" placeholder="Komutan AdÄ± Gir">
        <input type="text" id="room-id" class="form-control mb-3 text-center" placeholder="Oda Ä°smi (Ã–rn: fetih1)">
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" onclick="createGame()">ODA KUR (Host)</button>
            <button class="btn btn-outline-light" onclick="joinGame()">ODAYA KATIL (Misafir)</button>
        </div>
        <div id="lobby-status" class="mt-3 text-center text-info small fw-bold"></div>
    </div>
</div>

<!-- AYARLAR (SADECE HOST GÃ–RÃœR) -->
<div id="screen-setup" class="container d-flex flex-column justify-content-center align-items-center vh-100 d-none">
    <div class="card bg-dark p-4 shadow-lg setup-card border-warning">
        <h3 class="text-warning text-center mb-4"><i class="bi bi-gear-fill"></i> SavaÅŸ KurallarÄ±</h3>
        
        <!-- SÃ¼re ve Soru SayÄ±sÄ± AyarÄ± -->
        <div class="row g-3 mb-4">
            <div class="col-6">
                <label class="form-label fw-bold"><i class="bi bi-clock-fill"></i> Soru BaÅŸÄ± SÃ¼re (sn):</label>
                <input type="number" id="time-per-q" class="form-control" value="30" min="10" max="120">
            </div>
            <div class="col-6">
                <label class="form-label fw-bold"><i class="bi bi-hash"></i> BÃ¶lÃ¼m BaÅŸÄ± Soru:</label>
                <select id="q-per-cat" class="form-select">
                    <option value="2">2 Soru</option>
                    <option value="3" selected>3 Soru</option>
                    <option value="4">4 Soru</option>
                    <option value="5">5 Soru</option>
                </select>
            </div>
        </div>

        <!-- Kategori SeÃ§imi -->
        <h5 class="mb-3 text-center">Hangi BÃ¶lÃ¼mlerden Soru Gelsin?</h5>
        <div id="category-list" class="mb-4">
            <!-- JS ile doldurulacak -->
        </div>

        <button class="btn btn-warning btn-lg w-100 mt-3" onclick="startGameConfig()">
            <i class="bi bi-play-circle-fill"></i> SAVAÅžI BAÅžLAT
        </button>
    </div>
</div>

<!-- OYUN EKRANI -->
<div id="screen-game" class="d-none">
    <div class="game-header">
        <div class="player-card p1-card">
            <h4 id="p1-name" style="color: var(--p1-color)">Mavi</h4>
            <div><i class="bi bi-building"></i> Puan: <span id="p1-score">0</span></div>
            <div><i class="bi bi-map-fill"></i> Ä°l: <span id="p1-cities">0</span></div>
            <div><i class="bi bi-heart-fill text-danger"></i> Kale CanÄ±: <span id="p1-hp">3</span></div>
        </div>
        <div class="player-card p2-card text-end">
            <h4 id="p2-name" style="color: var(--p2-color)">KÄ±rmÄ±zÄ±</h4>
            <div><span id="p2-score">0</span> :Puan <i class="bi bi-building"></i></div>
            <div><span id="p2-cities">0</span> :Ä°l <i class="bi bi-map-fill"></i></div>
            <div><span id="p2-hp">3</span> :Kale CanÄ± <i class="bi bi-heart-fill text-danger"></i></div>
        </div>
    </div>
    <div id="map-container"></div>
    <div id="status-bar" class="pulse-anim">Oyun BaÅŸlÄ±yor...</div>
</div>

<!-- SORU MODALI -->
<div class="modal fade" id="questionModal" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <span class="badge bg-warning text-dark fs-6" id="q-counter">Soru 1/10</span>
                <span class="badge bg-danger fs-5 ms-auto" id="q-timer">30</span>
            </div>
            <div class="modal-body p-4">
                <h4 class="text-center mb-4 lh-base" id="q-text">Soru metni...</h4>
                <div id="q-options"></div>
                <div id="wait-msg" class="text-center mt-3 text-info d-none">
                    <div class="spinner-border spinner-border-sm"></div> Rakip bekleniyor...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OYUN SONU -->
<div class="modal fade" id="resultModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5">
            <h1 id="winner-title" class="display-1 mb-3">ðŸ‘‘</h1>
            <h2 id="winner-name" class="fw-bold mb-3"></h2>
            <p id="winner-reason" class="lead text-muted"></p>
            <p id="winner-score-info" class="mb-0"></p>
            <button class="btn btn-primary mt-4" onclick="location.reload()">Ana MenÃ¼ye DÃ¶n</button>
        </div>
    </div>
</div>

<script>
/* ================= INDEX.TXT'DEN ALINAN GERÃ‡EK SORU HAVUZU ================= */

// NOT: Bu havuzu index.txt'deki questionBank kÄ±smÄ±ndan kopyalayacaksÄ±n!
// Åžimdilik demo olarak birkaÃ§ kategori ekliyorum:

const questionBank = {
    "Grammar": [
        {
            text: "Dogs can be good friends to humans ---- they are treated with love and care.",
            options: { A: "so that", B: "as if", C: "unless", D: "provided that", E: "even though" },
            correctAnswer: "D"
        },
        {
            text: "The risk of breaking a hip is shown to be higher for vegetarian women than those who are regular meat eaters, ---- meat-free diets are possibly deficient in vitamins and minerals that help strengthen bones.",
            options: { A: "whereas", B: "so", C: "because", D: "although", E: "whether" },
            correctAnswer: "C"
        },
        {
            text: "---- the vast deserts and steamy rainforests of Africa make this continent a tricky place to look for fossils, in recent years, many areas have been found to be rich in ancient life.",
            options: { A: "Once", B: "Even though", C: "Provided that", D: "As long as", E: "As if" },
            correctAnswer: "B"
        }
    ],
    
    "Reading 1": [
        {
            text: "(1-3) Dolphins are widely considered to be among the most intelligent of creatures. Perhaps their most outstanding feature, aside from this high intelligence, is the way they communicate. Dolphins produce high-pitched whistles and clicking sounds to communicate with each other. In fact, recent studies reveal that each dolphin has its own unique whistle, much like the human voice. ---- When a dolphin is separated from a group, for example, it sends out a whistle that the others recognise, and they call back, allowing the two to reunite. (2024 YDS)\n\n1. Which of the following best completes the text?",
            options: { 
                A: "Scientists have observed that dolphins use these unique sounds to identify and communicate with specific individuals.", 
                B: "There is some dispute over the exact extent to which dolphins are intelligent.", 
                C: "Dolphins may get separated from the main group during a hunt for food, for instance.", 
                D: "Whistles and other sounds are essential to the way of life of dolphins.", 
                E: "Dolphins' habitats around the world are being increasingly disturbed by fishing activities." 
            },
            correctAnswer: "A"
        }
    ],
    
    "Vocabulary": [
        {
            text: "Scientists studying climate change have developed models to ---- the potential effects of global warming over the next century.",
            options: { A: "predict", B: "abandon", C: "ignore", D: "eliminate", E: "conceal" },
            correctAnswer: "A"
        },
        {
            text: "The company's new policy aims to ---- workplace efficiency by introducing flexible working hours.",
            options: { A: "diminish", B: "enhance", C: "prevent", D: "abandon", E: "overlook" },
            correctAnswer: "B"
        }
    ]
};

/* ================= AYARLAR & DATA ================= */
const ICON_SIZE = 55; 
const SVG_URL = './tr.svg'; 
const ICONS = { CASTLE: './castle.svg', HOST_SOLDIER: './hostsoldier.svg', GUEST_SOLDIER: './questsoldier.svg' };

// GÃœNCELLENMÄ°Åž KOMÅžULUK HARÄ°TASI (SVG UYUMLU)
const NEIGHBORS = {
    1: [33, 51, 38, 46, 80, 31], 2: [46, 44, 21, 63, 27], 3: [26, 42, 32, 20, 64, 43], 4: [25, 36, 76, 65, 13, 49],
    5: [60, 19, 55], 6: [14, 26, 42, 68, 40, 71, 18], 7: [48, 15, 32, 42, 70, 33], 8: [53, 25, 61, 28],
    9: [17, 22, 45, 35, 77], 10: [7, 74, 34, 20, 3, 26, 43, 64], 11: [52, 59, 66, 62], 12: [24, 30, 23, 58, 73],
    13: [76, 4, 49, 65, 72, 75], 14: [6, 71, 40, 68, 50], 15: [48, 7, 70], 16: [17, 59], 17: [9, 16, 59, 77, 35, 22],
    18: [6, 40, 71], 19: [5, 60, 55], 20: [10, 64, 3, 43], 21: [2, 63, 44, 27], 22: [9, 17, 35, 45], 23: [12, 24, 58],
    24: [12, 23, 30], 25: [4, 8, 28, 36], 26: [3, 6, 10], 27: [2, 21, 44, 56], 28: [8, 25, 36, 61, 69],
    29: [47, 56, 62, 66], 30: [12, 24], 31: [1, 51, 33, 80], 32: [3, 7, 42], 33: [1, 7, 31, 51, 70, 80],
    34: [10, 74, 35, 45], 35: [9, 17, 22, 34, 45, 77], 36: [4, 25, 28, 76], 37: [55, 60], 38: [1, 46, 80],
    39: [57, 67], 40: [6, 14, 18, 50, 68, 71], 41: [54], 42: [3, 6, 7, 26, 32], 43: [3, 10, 20, 64],
    44: [2, 21, 27, 63], 45: [9, 22, 34, 35], 46: [1, 2, 27, 38, 63, 80], 47: [29, 56, 62], 48: [7, 15],
    49: [4, 13, 65], 50: [14, 40, 68], 51: [1, 31, 33, 80], 52: [11, 59, 66], 53: [8, 61], 54: [41],
    55: [5, 19, 37, 60], 56: [27, 29, 44, 47, 63], 57: [39, 67], 58: [12, 23, 73], 59: [11, 16, 17, 52, 66, 77],
    60: [5, 19, 37, 55], 61: [8, 28, 53, 69], 62: [11, 29, 47, 66], 63: [2, 21, 27, 44, 46, 56, 80],
    64: [3, 10, 20, 43], 65: [4, 13, 49, 72], 66: [11, 29, 52, 59, 62, 77], 67: [39, 57], 68: [6, 14, 40, 50, 71],
    69: [28, 61], 70: [7, 15, 33], 71: [6, 14, 18, 40, 68], 72: [13, 65, 75], 73: [12, 58], 74: [10, 34],
    75: [13, 72], 76: [4, 13, 36], 77: [9, 17, 35, 59, 66], 80: [1, 31, 33, 38, 46, 51, 63], 81: []
};

/* ================= OYUN DEÄžÄ°ÅžKENLERÄ° ================= */
let peer, conn, isHost = false, gameState = "LOBBY"; // LOBBY, BASE_SELECT, PLAYING, EXPANSION, WAITING
let players = {
    p1: { name: "Mavi", base: null, cities: [], score: 0, hp: 3 },
    p2: { name: "KÄ±rmÄ±zÄ±", base: null, cities: [], score: 0, hp: 3 }
};

let turnQueue = []; // P1 ve P2'nin sÄ±rayla fetih haklarÄ±
let currentTurn = 1; // KaÃ§Ä±ncÄ± soru
let maxTurns = 10; // Toplam tur sayÄ±sÄ±
let questionsPool = []; // Oyunda kullanÄ±lacak sorular
let currentQuestionIndex = 0; // KaÃ§Ä±ncÄ± soru
let timerInterval = null;
let timePerQuestion = 30; // Host tarafÄ±ndan ayarlanacak

let myAnswer = null;
let oppAnswer = null;

/* ================= PeerJS BAÄžLANTI ================= */
function createGame() {
    const name = document.getElementById('player-name').value.trim() || "Mavi Komutan";
    const roomId = document.getElementById('room-id').value.trim();
    
    if (!roomId) {
        alert("LÃ¼tfen bir oda ismi girin!");
        return;
    }

    isHost = true;
    players.p1.name = name;
    
    document.getElementById('lobby-status').innerText = "Oda aÃ§Ä±lÄ±yor...";
    document.getElementById('lobby-status').classList.remove('d-none');
    
    peer = new Peer(roomId, { debug: 2 });
    
    peer.on('open', () => {
        document.getElementById('lobby-status').innerHTML = `âœ… Oda Kodu: <b>${roomId}</b><br>Misafir bekleniyor...`;
    });
    
    peer.on('connection', (connection) => {
        conn = connection;
        setupConnection();
        document.getElementById('lobby-status').innerText = "Rakip baÄŸlandÄ±! Ayarlar yÃ¼kleniyor...";
        
        setTimeout(() => {
            document.getElementById('screen-lobby').classList.add('d-none');
            document.getElementById('screen-setup').classList.remove('d-none');
            loadCategoryOptions();
        }, 500);
    });
    
    peer.on('error', (err) => {
        alert("BaÄŸlantÄ± hatasÄ±: " + err.message);
    });
}

function joinGame() {
    const name = document.getElementById('player-name').value.trim() || "KÄ±rmÄ±zÄ± Komutan";
    const roomId = document.getElementById('room-id').value.trim();
    
    if (!roomId) {
        alert("LÃ¼tfen oda ismini girin!");
        return;
    }

    isHost = false;
    players.p2.name = name;
    
    document.getElementById('lobby-status').innerText = "Odaya baÄŸlanÄ±lÄ±yor...";
    document.getElementById('lobby-status').classList.remove('d-none');
    
    peer = new Peer(null, { debug: 2 });
    
    peer.on('open', () => {
        conn = peer.connect(roomId, { reliable: true });
        setupConnection();
    });
}

function setupConnection() {
    conn.on('open', () => {
        if (!isHost) {
            conn.send({ type: 'JOINED', name: players.p2.name });
        }
    });
    
    conn.on('data', (data) => {
        if (data.type === 'JOINED') {
            players.p2.name = data.name;
        }
        else if (data.type === 'START_GAME') {
            questionsPool = data.questions;
            timePerQuestion = data.timeLimit;
            maxTurns = questionsPool.length;
            
            document.getElementById('screen-lobby').classList.add('d-none');
            document.getElementById('screen-setup').classList.add('d-none');
            document.getElementById('screen-game').classList.remove('d-none');
            
            loadSvgMap().then(() => {
                gameState = "BASE_SELECT";
                showStatus("Kale yerinizi seÃ§in!");
            });
        }
        else if (data.type === 'UPDATE_MAP') {
            players = data.players;
            renderMapState();
            if (data.msg) showStatus(data.msg);
            if (!isHost && players.p1.base && players.p2.base && gameState === "BASE_SELECT") {
                gameState = "PLAYING";
            }
        }
        else if (data.type === 'START_QUESTION') {
            openQuestionModal();
        }
        else if (data.type === 'ANSWER') {
            oppAnswer = data.answer;
            if (myAnswer) evaluateAnswers();
        }
        else if (data.type === 'QUEUE_UPDATE') {
            turnQueue = data.queue;
            updateExpansionStatus();
        }
        else if (data.type === 'GAME_OVER') {
            endGame(data.winner, data.reason, data.scores);
        }
    });
}

/* ================= KATEGORÄ° SEÃ‡Ä°MÄ° (HOST) ================= */
function loadCategoryOptions() {
    const container = document.getElementById('category-list');
    container.innerHTML = '';
    
    Object.keys(questionBank).forEach(cat => {
        const div = document.createElement('div');
        div.className = 'form-check category-checkbox';
        div.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${cat}" id="cat-${cat}" checked>
            <label class="form-check-label" for="cat-${cat}">
                ${cat} (${questionBank[cat].length} soru)
            </label>
        `;
        container.appendChild(div);
    });
}

function startGameConfig() {
    const selectedCats = [];
    document.querySelectorAll('#category-list input:checked').forEach(cb => {
        selectedCats.push(cb.value);
    });
    
    if (selectedCats.length === 0) {
        alert("En az 1 kategori seÃ§melisiniz!");
        return;
    }
    
    const qPerCat = parseInt(document.getElementById('q-per-cat').value);
    timePerQuestion = parseInt(document.getElementById('time-per-q').value);
    
    // Sorular havuzunu oluÅŸtur
    let pool = [];
    selectedCats.forEach(cat => {
        const allQs = questionBank[cat];
        const shuffled = allQs.sort(() => 0.5 - Math.random());
        const picked = shuffled.slice(0, qPerCat);
        pool = pool.concat(picked);
    });
    
    if (pool.length === 0) {
        alert("Yeterli soru bulunamadÄ±!");
        return;
    }
    
    // TÃ¼m sorularÄ± karÄ±ÅŸtÄ±r
    questionsPool = pool.sort(() => 0.5 - Math.random());
    maxTurns = questionsPool.length;
    
    // Guest'e gÃ¶nder
    conn.send({ 
        type: 'START_GAME', 
        questions: questionsPool, 
        timeLimit: timePerQuestion 
    });
    
    // Kendi ekranÄ±nÄ± aÃ§
    document.getElementById('screen-setup').classList.add('d-none');
    document.getElementById('screen-game').classList.remove('d-none');
    
    loadSvgMap().then(() => {
        gameState = "BASE_SELECT";
        showStatus("Kale yerinizi seÃ§in!");
    });
}

/* ================= HARÄ°TA ================= */
async function loadSvgMap() {
    const wrapper = document.getElementById('map-container');
    const resp = await fetch(SVG_URL);
    wrapper.innerHTML = await resp.text();
    const svg = wrapper.querySelector('svg');
    svg.removeAttribute('width'); svg.removeAttribute('height'); svg.style.width='100%'; svg.style.height='100%';
    const grp = document.createElementNS("http://www.w3.org/2000/svg", "g"); grp.id = "icon-layer"; svg.appendChild(grp);

    svg.querySelectorAll('path').forEach(p => {
        let id = p.getAttribute('id') || p.parentElement.getAttribute('id');
        if(id && id.startsWith('TR')) {
            const pl = parseInt(id.replace('TR',''));
            p.setAttribute('id', `city-${pl}`); p.removeAttribute('fill'); p.removeAttribute('style');
            p.onclick = (e) => { e.stopPropagation(); onCityClick(pl); };
        }
    });
}

function renderMapState() {
    document.querySelectorAll('path').forEach(p => p.classList.remove('owned-p1', 'owned-p2'));
    document.getElementById('icon-layer').innerHTML = '';
    players.p1.cities.forEach(c => markCity(c, 'p1'));
    players.p2.cities.forEach(c => markCity(c, 'p2'));
    updateScoreboard();
}

function markCity(c, pid) {
    const el = document.getElementById(`city-${c}`);
    if(el) {
        el.classList.add(pid === 'p1' ? 'owned-p1' : 'owned-p2');
        const isBase = players[pid].base === c;
        const icon = isBase ? ICONS.CASTLE : (pid === 'p1' ? ICONS.HOST_SOLDIER : ICONS.GUEST_SOLDIER);
        drawIcon(c, icon);
    }
}

function drawIcon(c, url) {
    const p = document.getElementById(`city-${c}`);
    const layer = document.getElementById('icon-layer');
    if(!p || !layer) return;
    const b = p.getBBox();
    const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
    img.setAttributeNS(null, "href", url);
    img.setAttribute("x", b.x+b.width/2-ICON_SIZE/2); img.setAttribute("y", b.y+b.height/2-ICON_SIZE/2);
    img.setAttribute("width", ICON_SIZE); img.setAttribute("height", ICON_SIZE); img.classList.add("map-icon");
    layer.appendChild(img);
}

function onCityClick(plate) {
    if(gameState === "BASE_SELECT") {
        const me = isHost ? 'p1' : 'p2';
        const opp = isHost ? 'p2' : 'p1';
        if(players[me].base || players[opp].base === plate) return;
        players[me].base = plate; players[me].cities.push(plate);
        if(isHost) { syncMap("Mavi kale kurdu!"); checkGameStart(); }
        else { conn.send({ type: 'UPDATE_MAP', players: players, msg: "KÄ±rmÄ±zÄ± kale kurdu!" }); renderMapState(); }
    }
    else if(gameState === "EXPANSION") claimCity(plate);
}

function checkGameStart() {
    if(players.p1.base && players.p2.base) { 
        gameState = "PLAYING"; 
        setTimeout(startNewTurn, 1000); 
    }
}

function updateScoreboard() {
    document.getElementById('p1-name').innerText = players.p1.name;
    document.getElementById('p2-name').innerText = players.p2.name;
    document.getElementById('p1-score').innerText = players.p1.score;
    document.getElementById('p1-cities').innerText = players.p1.cities.length;
    document.getElementById('p1-hp').innerText = players.p1.hp;
    document.getElementById('p2-score').innerText = players.p2.score;
    document.getElementById('p2-cities').innerText = players.p2.cities.length;
    document.getElementById('p2-hp').innerText = players.p2.hp;
}

function showStatus(msg) {
    const el = document.getElementById('status-bar'); el.innerText = msg; el.style.display = 'block';
}

/* ================= SORU AKIÅžI ================= */
function startNewTurn() {
    if (currentTurn > maxTurns) {
        if (isHost) calculateFinalWinner("Oyun bitti! TÃ¼m turlar tamamlandÄ±.");
        return;
    }
    
    myAnswer = null;
    oppAnswer = null;
    
    if (isHost) {
        conn.send({ type: 'START_QUESTION' });
    }
    
    openQuestionModal();
}

function openQuestionModal() {
    const q = questionsPool[currentQuestionIndex];
    
    document.getElementById('q-counter').innerText = `Soru ${currentTurn}/${maxTurns}`;
    document.getElementById('q-text').innerText = q.text;
    document.getElementById('q-timer').innerText = timePerQuestion;
    
    const opts = document.getElementById('q-options');
    opts.innerHTML = '';
    
    ['A', 'B', 'C', 'D', 'E'].forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'btn option-btn';
        btn.innerHTML = `<b>${opt})</b> ${q.options[opt]}`;
        btn.onclick = () => selectAnswer(opt, btn);
        opts.appendChild(btn);
    });
    
    document.getElementById('wait-msg').classList.add('d-none');
    
    new bootstrap.Modal(document.getElementById('questionModal')).show();
    
    startQuestionTimer();
}

function startQuestionTimer() {
    let timeLeft = timePerQuestion;
    document.getElementById('q-timer').innerText = timeLeft;
    
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('q-timer').innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            if (!myAnswer) selectAnswer('X', null); // Zaman doldu, boÅŸ geÃ§
        }
    }, 1000);
}

function selectAnswer(ans, btnElement) {
    if (myAnswer) return; // Zaten cevapladÄ±
    
    myAnswer = ans;
    
    // ButonlarÄ± kilitle
    document.querySelectorAll('.option-btn').forEach(b => b.classList.add('locked'));
    if (btnElement) btnElement.classList.add('selected');
    
    // Rakibe gÃ¶nder
    conn.send({ type: 'ANSWER', answer: ans });
    
    if (!oppAnswer) {
        document.getElementById('wait-msg').classList.remove('d-none');
    } else {
        evaluateAnswers();
    }
}

function evaluateAnswers() {
    clearInterval(timerInterval);
    
    const q = questionsPool[currentQuestionIndex];
    const correct = q.correctAnswer;
    
    // Renklendirme
    document.querySelectorAll('.option-btn').forEach(btn => {
        const opt = btn.innerHTML.split(')')[0].replace('<b>', '');
        
        if (opt === correct) {
            btn.classList.add('btn-correct');
        }
        
        if (opt === myAnswer && opt === oppAnswer) {
            btn.classList.add('btn-both');
        } else if (opt === myAnswer) {
            btn.classList.add('btn-p1');
        } else if (opt === oppAnswer) {
            btn.classList.add('btn-p2');
        }
    });
    
    // Hak daÄŸÄ±tÄ±mÄ± mantÄ±ÄŸÄ±
    if (isHost) {
        // Kimin kaÃ§ hakkÄ± olacak?
        if (myAnswer === correct && oppAnswer !== correct) {
            turnQueue = ['p1', 'p1']; // 2 Hak P1
        } else if (oppAnswer === correct && myAnswer !== correct) {
            turnQueue = ['p2', 'p2']; // 2 Hak P2
        } else if (myAnswer === correct && oppAnswer === correct) {
            turnQueue = ['p1', 'p2']; // Ä°kisi de 1'er hak
        } else {
            turnQueue = []; // Ä°kisi de yanlÄ±ÅŸ
        }
        
        conn.send({ type: 'QUEUE_UPDATE', queue: turnQueue });
    }
    
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('questionModal')).hide();
        currentQuestionIndex++;
        
        if (turnQueue.length > 0) {
            gameState = "EXPANSION";
            updateExpansionStatus();
            showStatus("Harita Ã¼zerinden ÅŸehir seÃ§in!");
        } else {
            showStatus("Ä°kiniz de yanlÄ±ÅŸ! 3 sn sonra yeni soru...");
            currentTurn++;
            setTimeout(startNewTurn, 3000);
        }
    }, 3000);
}

function updateExpansionStatus() {
    if (turnQueue.length === 0) return;
    
    const next = turnQueue[0];
    const isMyTurn = (isHost && next === 'p1') || (!isHost && next === 'p2');
    
    if (isMyTurn) {
        showStatus(`SÄ°ZÄ°N SIRA! (Kalan Hak: ${turnQueue.length})`);
    } else {
        showStatus(`Rakip Oynuyor... (Kalan Hak: ${turnQueue.length})`);
    }
}

function claimCity(plate) {
    const playerKey = isHost ? 'p1' : 'p2';
    const oppKey = isHost ? 'p2' : 'p1';
    
    // SÄ±ra kontrolÃ¼
    if (turnQueue.length === 0) return;
    if ((isHost && turnQueue[0] !== 'p1') || (!isHost && turnQueue[0] !== 'p2')) {
        showStatus("SÄ±ra sizde deÄŸil!");
        return;
    }
    
    let msg = "";
    let actionSuccess = false;
    
    // A) KALE SALDIRISI
    if (players[oppKey].base === plate) {
        players[oppKey].hp--;
        msg = `${players[playerKey].name} dÃ¼ÅŸman kalesine saldÄ±rdÄ±!`;
        actionSuccess = true;
        
        if (players[oppKey].hp <= 0) {
            if (isHost) calculateFinalWinner(`${players[playerKey].name} dÃ¼ÅŸman kaleyi ele geÃ§irdi!`);
            return;
        }
    }
    // B) TOPRAK Ã‡ALMA (KomÅŸu kontrolÃ¼)
    else if (players[oppKey].cities.includes(plate) && isAdjacent(plate, players[playerKey].cities)) {
        players[oppKey].cities = players[oppKey].cities.filter(c => c !== plate);
        players[oppKey].score -= 150;
        players[playerKey].cities.push(plate);
        players[playerKey].score += 150;
        msg = `${players[playerKey].name} toprak Ã‡ALDI!`;
        actionSuccess = true;
    }
    // C) NORMAL FETÄ°H (BoÅŸ Toprak)
    else if (!players.p1.cities.includes(plate) && !players.p2.cities.includes(plate)) {
        players[playerKey].cities.push(plate);
        players[playerKey].score += 50;
        msg = `${players[playerKey].name} fethetti!`;
        actionSuccess = true;
    }
    
    if (actionSuccess) {
        turnQueue.shift();
        
        renderMapState();
        conn.send({ type: 'UPDATE_MAP', players: players, msg: msg });
        conn.send({ type: 'QUEUE_UPDATE', queue: turnQueue });
        updateExpansionStatus();
        
        if(msg) showStatus(msg);
        
        if (turnQueue.length === 0) {
            gameState = "WAITING";
            showStatus("Tur bitti! 5 sn sonra yeni soru...");
            currentTurn++;
            setTimeout(startNewTurn, 5000);
        }
    }
}

function isAdjacent(targetPlate, myCities) {
    if (myCities.length === 0) return false;
    const targetNeighbors = NEIGHBORS[targetPlate] || [];
    return targetNeighbors.some(n => myCities.includes(n));
}

function syncMap(msg) {
    renderMapState();
    conn.send({ type: 'UPDATE_MAP', players: players, msg: msg });
    if(msg) showStatus(msg);
}

/* ================= OYUN SONU ================= */
function calculateFinalWinner(reason) {
    let winner = "Berabere", p1 = players.p1.score, p2 = players.p2.score;
    if(p1 > p2) winner = players.p1.name;
    else if(p2 > p1) winner = players.p2.name;
    
    const scores = formatScores();
    
    conn.send({ type: 'GAME_OVER', winner: winner, reason: reason, scores: scores });
    endGame(winner, reason, scores);
}

function formatScores() { 
    return `${players.p1.name}: ${players.p1.score} - ${players.p2.name}: ${players.p2.score}`; 
}

function endGame(winner, reason, scores) {
    document.getElementById('winner-name').innerText = "Kazanan: " + winner;
    document.getElementById('winner-reason').innerText = reason;
    document.getElementById('winner-score-info').innerText = scores;
    new bootstrap.Modal(document.getElementById('resultModal')).show();
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
