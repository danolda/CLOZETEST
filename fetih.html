<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YDS Fetih: Strateji Modu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #2c3e50;
            --map-water: #34495e;
            --map-land: #ecf0f1;
            --map-hover: #bdc3c7;
            --p1-color: #3498db; /* Mavi */
            --p2-color: #e74c3c; /* KÄ±rmÄ±zÄ± */
            --gold: #f1c40f;
        }
        body { background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* HARÄ°TA ALANI */
        #map-container {
            width: 100%;
            height: 75vh;
            background-color: var(--map-water);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        
        svg { width: 100%; height: 100%; display: block; }
        #map-container svg { width: 100%; height: 100%; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        
        path {
            fill: var(--map-land) !important; 
            stroke: #95a5a6; stroke-width: 1px;   
            transition: all 0.3s ease; cursor: pointer; vector-effect: non-scaling-stroke;
        }
        path:hover { fill: var(--map-hover) !important; stroke: white; stroke-width: 2px; z-index: 10; }
        
        .owned-p1 { fill: #85c1e9 !important; stroke: #fff; }
        .owned-p2 { fill: #ec7063 !important; stroke: #fff; }
        
        /* ARAYÃœZ ELEMANLARI */
        .game-header { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .player-card { background: rgba(0,0,0,0.8); border-radius: 10px; padding: 15px; min-width: 200px; border: 2px solid #555; pointer-events: auto; }
        .p1-card { border-color: var(--p1-color); }
        .p2-card { border-color: var(--p2-color); }

        .modal-content { background: #2c3e50; color: white; border: 1px solid #555; }
        .option-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 8px; background: #34495e; color: white; border: 1px solid #7f8c8d; transition: 0.2s; font-size: 1.1rem; }
        .option-btn:hover { background: #2c3e50; border-color: white; }
        .option-btn.selected { background: var(--gold); color: black; font-weight: bold; }
        .locked { pointer-events: none; opacity: 0.6; }

        #status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); padding: 10px 30px; border-radius: 30px;
            font-size: 1.2rem; font-weight: bold; border: 2px solid var(--gold);
            z-index: 100; display: none; white-space: nowrap;
        }
        
        .map-icon { transform-box: fill-box; transform-origin: center; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pulse-anim { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: translateX(-50%) scale(1.05); } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

<!-- GÄ°RÄ°Åž EKRANI -->
<div id="screen-lobby" class="container d-flex flex-column justify-content-center align-items-center vh-100">
    <h1 class="display-3 fw-bold text-warning mb-4"><i class="bi bi-geo-fill"></i> YDS FETÄ°H</h1>
    <div class="card bg-dark p-5 shadow-lg border-secondary" style="width: 400px;">
        <input type="text" id="player-name" class="form-control mb-3 text-center fw-bold fs-5" placeholder="Komutan AdÄ± Gir">
        <input type="text" id="room-id" class="form-control mb-3 text-center" placeholder="Oda Ä°smi (Ã–rn: fetih1)">
        <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" onclick="createGame()">ODA KUR (Host)</button>
            <button class="btn btn-outline-light" onclick="joinGame()">ODAYA KATIL (Misafir)</button>
        </div>
        <div id="lobby-status" class="mt-3 text-center text-info small fw-bold"></div>
    </div>
</div>

<!-- AYARLAR (Sadece Host) -->
<div id="screen-setup" class="container d-flex flex-column justify-content-center align-items-center vh-100 d-none">
    <div class="card bg-dark p-4 shadow-lg w-50 border-warning">
        <h3 class="text-warning text-center mb-4">SavaÅŸ KurallarÄ±</h3>
        <div class="mb-3">
            <label class="form-label text-white">Soru BaÅŸÄ±na DÃ¼ÅŸen Fetih SÃ¼resi (Saniye):</label>
            <input type="number" id="setup-time" class="form-control text-center fw-bold" value="30">
        </div>
        <div class="mb-3">
            <label class="form-label text-white">Toplam Soru SayÄ±sÄ±:</label>
            <select id="setup-count" class="form-select text-center fw-bold">
                <option value="5">5 Soru (HÄ±zlÄ±)</option>
                <option value="10" selected>10 Soru (Normal)</option>
                <option value="20">20 Soru (Uzun)</option>
            </select>
        </div>
        <button class="btn btn-warning btn-lg w-100 mt-3" onclick="startGameConfig()">SAVAÅžI BAÅžLAT</button>
    </div>
</div>

<!-- OYUN EKRANI -->
<div id="screen-game" class="d-none">
    <div class="game-header">
        <div class="player-card p1-card">
            <h4 id="p1-name" style="color: var(--p1-color)">Mavi</h4>
            <div><i class="bi bi-building"></i> Puan: <span id="p1-score">0</span></div>
            <div><i class="bi bi-map-fill"></i> Ä°l SayÄ±sÄ±: <span id="p1-cities">0</span></div>
        </div>
        <div class="player-card p2-card text-end">
            <h4 id="p2-name" style="color: var(--p2-color)">KÄ±rmÄ±zÄ±</h4>
            <div><span id="p2-score">0</span> :Puan <i class="bi bi-building"></i></div>
            <div><span id="p2-cities">0</span> :Ä°l SayÄ±sÄ± <i class="bi bi-map-fill"></i></div>
        </div>
    </div>
    <div id="map-container"></div>
    <div id="status-bar" class="pulse-anim">Oyun BaÅŸlÄ±yor...</div>
</div>

<!-- SORU MODALI -->
<div class="modal fade" id="questionModal" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <span class="badge bg-warning text-dark fs-6" id="q-counter">Soru 1/10</span>
                <span class="badge bg-danger fs-5 ms-auto" id="q-timer">30</span>
            </div>
            <div class="modal-body p-4">
                <h4 class="text-center mb-4 lh-base" id="q-text">Soru metni...</h4>
                <div id="q-options"></div>
                <div id="wait-msg" class="text-center mt-3 text-info d-none">
                    <div class="spinner-border spinner-border-sm"></div> Rakip bekleniyor...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OYUN SONU -->
<div class="modal fade" id="resultModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-5">
            <h1 id="winner-title" class="display-1 mb-3">ðŸ‘‘</h1>
            <h2 id="winner-name" class="fw-bold mb-3"></h2>
            <p id="winner-reason" class="lead text-muted"></p>
            <p id="winner-score-info" class="mb-0"></p>
            <button class="btn btn-primary mt-4" onclick="location.reload()">Ana MenÃ¼ye DÃ¶n</button>
        </div>
    </div>
</div>

<script>
    /* ================= SABÄ°TLER ================= */
    const ICON_SIZE = 55; 
    const SVG_URL = './tr.svg'; 
    const ICONS = { CASTLE: './castle.svg', HOST_SOLDIER: './hostsoldier.svg', GUEST_SOLDIER: './questsoldier.svg' };

    /* ================= DEÄžÄ°ÅžKENLER ================= */
    let peer = null, conn = null, isHost = false, gameState = "LOBBY";
    let currentTurn = 0;
    let timerInterval = null;
    
    // YENÄ°: Fetih HaklarÄ±
    let expansionRights = { p1: 0, p2: 0 }; 

    const questions = [
        { q: "She is interested ___ music.", opts: {A:'on',B:'in',C:'at',D:'for',E:'with'}, ans: 'B' },
        { q: "He works ___ a bank.", opts: {A:'at',B:'on',C:'to',D:'by',E:'of'}, ans: 'A' },
        { q: "I am afraid ___ dogs.", opts: {A:'from',B:'of',C:'by',D:'in',E:'at'}, ans: 'B' },
        { q: "The book is ___ the table.", opts: {A:'in',B:'on',C:'at',D:'of',E:'to'}, ans: 'B' },
        { q: "I wake up ___ 7 o'clock.", opts: {A:'on',B:'in',C:'at',D:'to',E:'of'}, ans: 'C' }
    ];

    let players = {
        p1: { name: "", base: null, cities: [], score: 0, id: 'p1' },
        p2: { name: "", base: null, cities: [], score: 0, id: 'p2' }
    };

    /* ================= BAÄžLANTI (PEERJS) ================= */
    function createGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "Mavi";
        if(!room) return alert("Oda ismi girin!");

        if(peer) peer.destroy();
        peer = new Peer(room, { debug: 2 });

        peer.on('open', id => {
            isHost = true;
            players.p1.name = name;
            document.getElementById('lobby-status').innerHTML = `<span class="text-success">Oda AÃ§Ä±ldÄ±! Bekleniyor...</span>`;
        });
        peer.on('error', err => {
            if(err.type === 'unavailable-id') alert("Bu oda ismi dolu! BaÅŸka bir isim girin.");
            else alert("Hata: " + err.type);
        });
        peer.on('connection', c => { conn = c; setupConnection(); });
    }

    function joinGame() {
        const room = document.getElementById('room-id').value;
        const name = document.getElementById('player-name').value || "KÄ±rmÄ±zÄ±";
        if(!room) return alert("Oda ismi girin!");

        if(peer) peer.destroy();
        peer = new Peer();

        peer.on('open', id => {
            conn = peer.connect(room);
            isHost = false;
            players.p2.name = name;
            setupConnection(); // Bekleme yapmadan Ã§aÄŸÄ±r
        });
        peer.on('error', err => alert("Hata: " + err.type));
    }

    function setupConnection() {
        conn.on('data', handleData);
        conn.on('open', () => {
            if(isHost) conn.send({ type: 'INIT', p1Name: players.p1.name });
            else conn.send({ type: 'JOIN', p2Name: players.p2.name });
        });
        // EÄŸer 'open' kaÃ§Ä±rÄ±ldÄ±ysa manuel tetikle
        if(conn.open) {
             if (isHost) conn.send({ type: 'INIT', p1Name: players.p1.name });
             else conn.send({ type: 'JOIN', p2Name: players.p2.name });
        }
    }

    function handleData(data) {
        if(data.type === 'INIT') { 
            players.p1.name = data.p1Name; 
            document.getElementById('lobby-status').innerText = "BaÄŸlandÄ±!"; 
        }
        else if(data.type === 'JOIN') { 
            players.p2.name = data.p2Name; 
            goToSetup(); 
        }
        else if(data.type === 'START_GAME') { 
            players = data.players; 
            startGameUI(); 
            if(isHost) setTimeout(startNewTurn, 1000); 
        }
        else if(data.type === 'UPDATE_MAP') { 
            players = data.players; 
            renderMapState(); 
            if(data.msg) showStatus(data.msg);
            
            // EÄŸer Host isek ve harita gÃ¼ncellendiyse sÄ±ranÄ±n bitip bitmediÄŸini kontrol et
            if(isHost) checkTurnProgress();
            
            if(isHost && gameState === "BASE_SELECT") checkGameStart();
        }
        else if(data.type === 'NEW_TURN') { 
            currentTurn = data.turnIndex; 
            showQuestion(data.question); 
        }
        else if(data.type === 'OPPONENT_ANSWER') { 
            if(isHost) resolveTurn(data.ans, 'p2'); 
        }
        else if(data.type === 'TURN_RESULT') { 
            handleTurnResult(data); 
        }
        else if(data.type === 'EXPANSION_UPDATE') {
            // Misafir iÃ§in: Hak bilgisini gÃ¼ncelle
            expansionRights = data.rights;
            updateExpansionStatus();
        }
        else if(data.type === 'GAME_OVER') { 
            endGame(data.winner, data.reason, data.scores); 
        }
    }

    /* ================= OYUN YÃ–NETÄ°MÄ° ================= */
    function goToSetup() {
        document.getElementById('screen-lobby').classList.add('d-none');
        document.getElementById('screen-setup').classList.remove('d-none');
    }

    function startGameConfig() {
        conn.send({ type: 'START_GAME', players: players });
        startGameUI();
    }

    function startGameUI() {
        document.getElementById('screen-lobby').classList.add('d-none');
        document.getElementById('screen-setup').classList.add('d-none');
        document.getElementById('screen-game').classList.remove('d-none');
        
        loadSvgMap().then(() => {
            updateScoreboard();
            showStatus("KALE ÅžEHRÄ°NÄ° SEÃ‡ (Haritaya TÄ±kla)");
            gameState = "BASE_SELECT";
        });
    }

    /* ================= SORU VE TUR MANTIÄžI ================= */
    let myAnswer = null;
    let p2AnswerTemp = null;

    function startNewTurn() {
        // OYUN BÄ°TÄ°Åž KONTROLÃœ
        if(currentTurn >= questions.length) {
            calculateFinalWinner();
            return;
        }

        const q = questions[currentTurn];
        myAnswer = null; p2AnswerTemp = null;
        expansionRights = { p1: 0, p2: 0 }; // HaklarÄ± sÄ±fÄ±rla

        conn.send({ type: 'NEW_TURN', question: q, turnIndex: currentTurn });
        showQuestion(q);
    }

    function calculateFinalWinner() {
        let winnerName = "Berabere";
        let reason = "Puanlar EÅŸit";
        let p1S = players.p1.score;
        let p2S = players.p2.score;

        if (p1S > p2S) { winnerName = players.p1.name; reason = "Puan ÃœstÃ¼nlÃ¼ÄŸÃ¼"; }
        else if (p2S > p1S) { winnerName = players.p2.name; reason = "Puan ÃœstÃ¼nlÃ¼ÄŸÃ¼"; }
        
        const scores = `${players.p1.name}: ${p1S} - ${players.p2.name}: ${p2S}`;
        
        // Herkese gÃ¶nder
        conn.send({ type: 'GAME_OVER', winner: winnerName, reason: reason, scores: scores });
        endGame(winnerName, reason, scores);
    }

    function showQuestion(q) {
        const modal = new bootstrap.Modal(document.getElementById('questionModal'));
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('q-counter').innerText = `Soru ${currentTurn+1}`;
        
        let html = '';
        for(let key in q.opts) {
            html += `<button class="option-btn" onclick="submitAnswer('${key}')"><b>${key})</b> ${q.opts[key]}</button>`;
        }
        document.getElementById('q-options').innerHTML = html;
        document.getElementById('wait-msg').classList.add('d-none');
        modal.show();
        startTimer();
    }

    function startTimer() {
        let timeLeft = 30; 
        const timerEl = document.getElementById('q-timer');
        timerEl.innerText = timeLeft;
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            timerEl.innerText = timeLeft;
            if(timeLeft <= 0) { clearInterval(timerInterval); submitAnswer(null); }
        }, 1000);
    }

    function submitAnswer(ans) {
        if(timerInterval) clearInterval(timerInterval);
        document.querySelectorAll('.option-btn').forEach(b => {
            b.classList.add('locked');
            if(ans && b.innerText.startsWith(ans)) b.classList.add('selected');
        });
        document.getElementById('wait-msg').classList.remove('d-none');
        const finalAns = ans || 'X'; 
        isHost ? (myAnswer = finalAns, checkTurnEnd()) : conn.send({ type: 'OPPONENT_ANSWER', ans: finalAns });
    }

    function resolveTurn(p2Ans) {
        p2AnswerTemp = p2Ans;
        checkTurnEnd();
    }

    // --- YENÄ° PUANLAMA VE HAK SÄ°STEMÄ° BURADA ---
    function checkTurnEnd() {
        if(myAnswer && p2AnswerTemp) {
            const q = questions[currentTurn];
            const p1Correct = (myAnswer === q.ans);
            const p2Correct = (p2AnswerTemp === q.ans);
            
            if(p1Correct) players.p1.score += 100;
            if(p2Correct) players.p2.score += 100;

            // HAK DAÄžITIMI
            if (p1Correct && !p2Correct) {
                expansionRights = { p1: 2, p2: 0 }; // Sadece P1 bildi: 2 Hak
            } else if (!p1Correct && p2Correct) {
                expansionRights = { p1: 0, p2: 2 }; // Sadece P2 bildi: 2 Hak
            } else if (p1Correct && p2Correct) {
                expansionRights = { p1: 1, p2: 1 }; // Ä°kisi de bildi: 1'er Hak
            } else {
                expansionRights = { p1: 0, p2: 0 }; // Ä°kisi de bilemedi: 0 Hak
            }
            
            const resultData = { 
                type: 'TURN_RESULT', 
                p1Correct, p2Correct, 
                rights: expansionRights, 
                correct: q.ans, 
                players: players 
            };
            
            conn.send(resultData);
            handleTurnResult(resultData);
        }
    }

    function handleTurnResult(data) {
        bootstrap.Modal.getInstance(document.getElementById('questionModal')).hide();
        players = data.players;
        expansionRights = data.rights; // HaklarÄ± al
        updateScoreboard();

        gameState = "EXPANSION";

        if (expansionRights.p1 === 0 && expansionRights.p2 === 0) {
            // KÄ°MSE BÄ°LEMEDÄ°
            showStatus("Kimse bilemedi! 5sn sonra yeni soru...");
            if(isHost) {
                currentTurn++;
                setTimeout(startNewTurn, 5000);
            }
        } else {
            // FETÄ°H BAÅžLIYOR
            updateExpansionStatus();
        }
    }

    function updateExpansionStatus() {
        const myRights = isHost ? expansionRights.p1 : expansionRights.p2;
        if (myRights > 0) {
            showStatus(`TEBRÄ°KLER! ${myRights} il fethetme hakkÄ±n var!`);
        } else {
            showStatus("Rakip fetih yapÄ±yor, bekleniyor...");
        }
    }

    /* ================= HARÄ°TA VE TIKLAMA ================= */
    async function loadSvgMap() {
        const wrapper = document.getElementById('map-container');
        try {
            const response = await fetch(SVG_URL);
            if (!response.ok) throw new Error("tr.svg bulunamadÄ±!");
            wrapper.innerHTML = await response.text();
            
            const svg = wrapper.querySelector('svg');
            svg.removeAttribute('width'); svg.removeAttribute('height');
            svg.style.width = '100%'; svg.style.height = '100%';
            
            const iconGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            iconGroup.setAttribute("id", "icon-layer");
            svg.appendChild(iconGroup);

            svg.querySelectorAll('path').forEach(path => {
                let rawId = path.getAttribute('id') || path.parentElement.getAttribute('id');
                if (rawId && rawId.startsWith('TR')) {
                    const plate = parseInt(rawId.replace('TR', ''), 10);
                    if (!isNaN(plate)) {
                        path.setAttribute('id', `city-${plate}`);
                        path.removeAttribute('fill'); path.removeAttribute('style');
                        path.onclick = (e) => { e.stopPropagation(); onCityClick(plate); };
                    }
                }
            });
        } catch (e) { wrapper.innerHTML = `<h3 class="text-danger text-center mt-5">Harita HatasÄ±: ${e.message}</h3>`; }
    }

    function renderMapState() {
        document.querySelectorAll('path').forEach(p => p.classList.remove('owned-p1', 'owned-p2'));
        document.getElementById('icon-layer').innerHTML = ''; 

        players.p1.cities.forEach(c => markCity(c, 'p1'));
        players.p2.cities.forEach(c => markCity(c, 'p2'));
        updateScoreboard();
    }

    function markCity(c, playerKey) {
        const el = document.getElementById(`city-${c}`);
        if(el) {
            el.classList.add(playerKey === 'p1' ? 'owned-p1' : 'owned-p2');
            const isBase = players[playerKey].base === c;
            const icon = isBase ? ICONS.CASTLE : (playerKey === 'p1' ? ICONS.HOST_SOLDIER : ICONS.GUEST_SOLDIER);
            drawIcon(c, icon);
        }
    }

    function drawIcon(cityId, iconUrl) {
        const path = document.getElementById(`city-${cityId}`);
        const iconLayer = document.getElementById('icon-layer');
        if (!path || !iconLayer) return;
        const bbox = path.getBBox();
        const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
        img.setAttributeNS(null, "href", iconUrl);
        img.setAttribute("x", bbox.x + bbox.width/2 - ICON_SIZE/2);
        img.setAttribute("y", bbox.y + bbox.height/2 - ICON_SIZE/2);
        img.setAttribute("width", ICON_SIZE); img.setAttribute("height", ICON_SIZE);
        img.setAttribute("class", "map-icon");
        iconLayer.appendChild(img);
    }

    function onCityClick(plate) {
        if(gameState === "BASE_SELECT") selectBase(plate);
        else if(gameState === "EXPANSION") claimCity(plate);
    }

    function selectBase(plate) {
        const me = isHost ? 'p1' : 'p2';
        const opp = isHost ? 'p2' : 'p1';
        if(players[me].base || players[opp].base === plate) return;

        players[me].base = plate;
        players[me].cities.push(plate);

        if(isHost) { syncMap("Mavi kalesini kurdu!"); checkGameStart(); }
        else { conn.send({ type: 'UPDATE_MAP', players: players, msg: "KÄ±rmÄ±zÄ± kalesini kurdu!" }); renderMapState(); }
    }

    function checkGameStart() {
        if(players.p1.base && players.p2.base) {
            gameState = "PLAYING";
            setTimeout(startNewTurn, 1000);
        }
    }

    // --- YENÄ°LENMÄ°Åž FETÄ°H MANTIÄžI ---
    function claimCity(plate) {
        const me = isHost ? 'p1' : 'p2';
        
        // 1. HAK KONTROLÃœ
        if (expansionRights[me] <= 0) return showStatus("Fetih hakkÄ±n kalmadÄ± veya sÄ±ra sende deÄŸil!");
        
        // 2. DOLULUK KONTROLÃœ
        if(players.p1.cities.includes(plate) || players.p2.cities.includes(plate)) return alert("Bu il zaten dolu!");

        // 3. Ä°LÄ° AL
        players[me].cities.push(plate);
        players[me].score += 50;
        expansionRights[me]--; // HakkÄ± dÃ¼ÅŸ

        // 4. GÃœNCELLE
        if(isHost) {
            // Misafire gÃ¼ncel haklarÄ± da gÃ¶nderiyoruz
            conn.send({ type: 'EXPANSION_UPDATE', rights: expansionRights });
            syncMap(`${players[me].name} fethetti! (Kalan Hak: ${expansionRights[me]})`);
        } else {
            conn.send({ type: 'UPDATE_MAP', players: players, msg: `${players[me].name} fethetti!` });
            renderMapState();
            updateExpansionStatus();
        }
    }

    // Host tarafÄ±nda tur ilerleyiÅŸini kontrol eden fonksiyon
    function checkTurnProgress() {
        if (gameState !== "EXPANSION") return;

        // Herkesin hakkÄ± bitti mi?
        if (expansionRights.p1 === 0 && expansionRights.p2 === 0) {
            gameState = "PLAYING";
            currentTurn++;
            showStatus("TÃ¼m fetihler bitti! 5sn sonra yeni soru...");
            setTimeout(startNewTurn, 5000);
        } else {
            // Haklar gÃ¼ncellendiyse misafire bildir (claimCity iÃ§inde yapÄ±lÄ±yor ama garanti olsun)
            conn.send({ type: 'EXPANSION_UPDATE', rights: expansionRights });
        }
    }

    function syncMap(msg) {
        renderMapState();
        conn.send({ type: 'UPDATE_MAP', players: players, msg: msg });
        if(msg) showStatus(msg);
    }

    function showStatus(msg) {
        const el = document.getElementById('status-bar');
        el.innerText = msg; el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }
    function updateScoreboard() {
        document.getElementById('p1-score').innerText = players.p1.score;
        document.getElementById('p1-cities').innerText = players.p1.cities.length;
        document.getElementById('p2-score').innerText = players.p2.score;
        document.getElementById('p2-cities').innerText = players.p2.cities.length;
    }
    function endGame(winner, reason, scores) {
        document.getElementById('winner-title').innerText = "OYUN BÄ°TTÄ°";
        document.getElementById('winner-name').innerText = "Kazanan: " + winner;
        document.getElementById('winner-reason').innerText = reason;
        document.getElementById('winner-score-info').innerText = scores || "";
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
